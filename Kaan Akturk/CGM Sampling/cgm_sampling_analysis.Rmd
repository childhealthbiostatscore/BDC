---
title: "CGM Sampling Analysis"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = "/Users/timvigers/Desktop")
library(arsenal)
library(skimr)
library(knitr)
library(cgmanalysis)
library(tidyverse)
```

```{r import A1c data}
# Import
subjects <- read.csv("./Data_Cleaned/subject_info.csv",na.strings = c("","(-)"))
# Names to lower case and no middle or suffixes for matching
subjects[,c("FirstName","LastName")] <- 
  lapply(subjects[,c("FirstName","LastName")],function(x){
    x <- tolower(x)
    x <- sub(" .*","",x)
  })
subjects$name <- paste0(subjects$FirstName,subjects$LastName)
subjects$name <- gsub(" ","",subjects$name)
```

```{r organize CGM data,eval=FALSE}
# Set output directory
outdir <- "./Data_Cleaned/cgm"
# Iterate through CGM data, format, and name
files <- list.files("./Data_Raw/Patient 90 days",full.names = T)
for (f in files) {
  ext <- tools::file_ext(f)
  if(grepl("xls",ext)){
    dat <- readxl::read_excel(f,col_types = "text")
    dat <- as.data.frame(dat)
  } else if (ext == "csv"){
    dat <- read.csv(f,na.strings = "")
  }
  name <- sub(" *\\ ","",tolower(paste0(dat[1,5],dat[2,5])))
  name <- gsub("[[:digit:]]","",name)
  name <- gsub(" ","",name)
  date <- lubridate::mdy(subjects$MostRecentVisitDate[match(name,subjects$name)])
  if(is.na(date)){stop(paste("No date:",f))}
  # Format data
  colnames(dat)[grep("glucose",tolower(colnames(dat)))] <- "sensorglucose"
  colnames(dat)[grep("timestamp",tolower(colnames(dat)))] <- "timestamp"
  dat$timestamp <- lubridate::ymd_hms(sub("T"," ",dat$timestamp))
  dat <- dat[-c(1:min(which(!is.na(dat$timestamp)))),]
  dat$subjectid <- name
  dat <- dat[,c("subjectid","timestamp","sensorglucose")]
  
  day14 <- dat[dat$timestamp <= date & dat$timestamp >= (date-14),]
  day30 <- dat[dat$timestamp <= date & dat$timestamp >= (date-30),]
  day90 <- dat[dat$timestamp <= date & dat$timestamp >= (date-90),]
  # Write CSV files
  if (nrow(day14 > 0)){write.csv(day14,paste0(outdir,"/day14/",name,"day14.csv"),na = "",row.names = F)}
  if (nrow(day30 > 0)){write.csv(day30,paste0(outdir,"/day30/",name,"day30.csv"),na = "",row.names = F)}
  if (nrow(day90 > 0)){write.csv(day90,paste0(outdir,"/day90/",name,"day90.csv"),na = "",row.names = F)}
}
```

```{r cgmvariables,eval=FALSE}
# CGM variables on each folder
cgmvariables("./Data_Cleaned/cgm/day14","./Data_Cleaned/",
             outputname = "day14variables",printname=T)
cgmvariables("./Data_Cleaned/cgm/day30","./Data_Cleaned",
             outputname = "day30variables")
cgmvariables("./Data_Cleaned/cgm/day90","./Data_Cleaned",
             outputname = "day90variables")
```

```{r combine data}
vars <- c("percent_time_70_180","percent_time_over_250","percent_time_over_180",
          "percent_time_under_70","percent_time_under_54","cv","average_sensor")
# Import cgm variables - limit to those with > 10 days of data
m3day14 <- read.csv("./Data_Cleaned/cgm/month3/m3day14variables.csv") %>%
  filter(percent_cgm_wear >= 75) %>% mutate(timepoint = "m3",cutoff = 14) %>% 
  select(subject_id,timepoint,cutoff,all_of(vars)) %>% 
  left_join(subjects[,c("name","A1c..month.3.670g")],by = c("subject_id" = "name"))
m3day30 <- read.csv("./Data_Cleaned/cgm/month3/m3day30variables.csv") %>%
  filter(percent_cgm_wear >= 75) %>% mutate(timepoint = "m3",cutoff = 30) %>% 
  select(subject_id,timepoint,cutoff,all_of(vars)) %>% 
  left_join(subjects[,c("name","A1c..month.3.670g")],by = c("subject_id" = "name"))
m3day90 <- read.csv("./Data_Cleaned/cgm/month3/m3day90variables.csv") %>%
  filter(percent_cgm_wear >= 75) %>% mutate(timepoint = "m3",cutoff = 90) %>% 
  select(subject_id,timepoint,cutoff,all_of(vars)) %>% 
  left_join(subjects[,c("name","A1c..month.3.670g")],by = c("subject_id" = "name"))
m6day14 <- read.csv("./Data_Cleaned/cgm/month6/m6day14variables.csv") %>%
  filter(percent_cgm_wear >= 75) %>% mutate(timepoint = "m6",cutoff = 14) %>% 
  select(subject_id,timepoint,cutoff,all_of(vars)) %>% 
  left_join(subjects[,c("name","A1c.month.6.670g")],by = c("subject_id" = "name"))
m6day30 <- read.csv("./Data_Cleaned/cgm/month6/m6day30variables.csv") %>%
  filter(percent_cgm_wear >= 75) %>% mutate(timepoint = "m6",cutoff = 30) %>% 
  select(subject_id,timepoint,cutoff,all_of(vars)) %>% 
  left_join(subjects[,c("name","A1c.month.6.670g")],by = c("subject_id" = "name"))
m6day90 <- read.csv("./Data_Cleaned/cgm/month6/m6day90variables.csv") %>%
  filter(percent_cgm_wear >= 75) %>% mutate(timepoint = "m6",cutoff = 90) %>% 
  select(subject_id,timepoint,cutoff,all_of(vars)) %>% 
  left_join(subjects[,c("name","A1c.month.6.670g")],by = c("subject_id" = "name"))
```

```{r analysis}
corr_analysis <- function(df14,df30,df90,title){
  df1 <- cor(df14[,4:ncol(df14)],use = "pairwise.complete.obs")
  df2 <- cor(df30[,4:ncol(df30)],use = "pairwise.complete.obs")
  df3 <- cor(df90[,4:ncol(df90)],use = "pairwise.complete.obs")
  df <- bind_rows(df1[1:7,8],df2[1:7,8],df3[1:7,8])
  df <- df^2
  df$time <- c(14,30,90)
  df <- df %>% pivot_longer(-time)
  ggplot(df,aes(x = time,y = value,color = name)) + geom_line() + geom_point() +
    ylim(0,1) + ggtitle(title) + theme_bw() + 
    xlab("Days in Sampling Period") + ylab("R^2")
}
corr_analysis(m3day14,m3day30,m3day90,"3 Month A1c")
corr_analysis(m6day14,m6day30,m6day90,"6 Month A1c")
```

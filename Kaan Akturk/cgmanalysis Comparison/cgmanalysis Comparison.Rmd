---
title: "cgmanalysis Comparison"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/bdc/SHARED/KAAN/Medtronic, Dexcom, Libre/")
library(arsenal)
library(skimr)
library(knitr)
library(cgmanalysis)
library(tidyverse)
library(patchwork)
```

```{r cgmanalysis, echo=FALSE,eval=FALSE,warning=FALSE}
# Get cgmanalysis variables
cgmvariables("Cleaned/Dexcom","Cleaned/",outputname = "dexcom_results")
cgmvariables("Cleaned/Libre","Cleaned/",outputname = "libre_results")
cgmvariables("Cleaned/Medtronic","Cleaned/",outputname = "medtronic_results")
```

# Dexcom

```{r compare results dexcom,echo=FALSE}
# Read in results from Dexcom, format name
dexcom_software <- read.csv("Dexcom/Patient List_Dexcom.csv",stringsAsFactors = F)
dexcom_software$Patient.Name <- tolower(dexcom_software$Patient.Name)
colnames(dexcom_software)[2] <- "subject_id"
# Read in results from package, multiply
dexcom_package <- read.csv("Cleaned/dexcom_results.csv",stringsAsFactors = F)
# Merge
dexcom_package <- left_join(dexcom_package,dexcom_software,by = "subject_id")
# Select columns
dexcom_package <- dexcom_package %>% select(subject_id,
                                            percent_time_under_54,X.54,
                                            percent_time_under_70,X.70,
                                            percent_time_70_180,X70.180,
                                            percent_time_over_180,X.180,
                                            percent_time_over_250,X.250,
                                            cv,CV,
                                            standard_deviation,SD)
# Dvide software CV by 100, round all columns
dexcom_package$CV <- dexcom_package$CV / 100
dexcom_package[,2:ncol(dexcom_package)] <- 
  lapply(dexcom_package[,2:ncol(dexcom_package)],function(x) round(x,1))
```

## Plots

```{r dexcom plots,echo=FALSE}
# Make plots
under_54 <- ggplot(dexcom_package,aes(x = percent_time_under_54,y = X.54)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time Under 54 mg/dL")
under_70 <- ggplot(dexcom_package,aes(x = percent_time_under_70,y = X.70)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time Under 70 mg/dL")
tir_70_180 <- ggplot(dexcom_package,aes(x = percent_time_70_180,y = X70.180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time 70 - 180 mg/dL")
over_180 <- ggplot(dexcom_package,aes(x = percent_time_over_180,y = X.180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time Over 180 mg/dL")
over_250 <- ggplot(dexcom_package,aes(x = percent_time_over_250,y = X.250)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time Over 250 mg/dL")
sd <- ggplot(dexcom_package,aes(x = standard_deviation,y = SD)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("Standard Deviation")

(under_54 | under_70 | tir_70_180) / (over_180 | over_250 | sd)
```

## Differences

```{r present dexcom,echo=FALSE,results='asis'}
# Calculate differences
dexcom_package <- dexcom_package %>%
  mutate(`Diff. in % Time Under 54` = X.54 - percent_time_under_54,
         `Diff. in % Time Under 70` = X.70 - percent_time_under_70,
         `Diff. in % Time 70 - 180` = X70.180 - percent_time_70_180,
         `Diff. in % Time Over 180` = X.180 - percent_time_over_180,
         `Diff. in % Time Over 250` = X.250 - percent_time_over_250,
         `Diff. in CV` = CV - cv,`Diff. in SD` = standard_deviation - SD)
# Results table
dex_table <- tableby(~ `Diff. in % Time Under 54` + `Diff. in % Time Under 70` + 
                       `Diff. in % Time 70 - 180` + `Diff. in % Time Over 180` + 
                       `Diff. in % Time Over 250` + `Diff. in CV` + `Diff. in SD`,
                     data = dexcom_package)
summary(dex_table)
```

# Libre

```{r compare results libre,echo=FALSE}
# Read in results from Libre, format name
libre_software <- read.csv("Libre/Patient List_Libre.csv",stringsAsFactors = F)
libre_software$Patient.Name <- tolower(libre_software$Patient.Name)
colnames(libre_software)[2] <- "subject_id"
# Read in results from package, multiply
libre_package <- read.csv("Cleaned/libre_results.csv",stringsAsFactors = F)
# Merge
libre_package <- left_join(libre_package,libre_software,by = "subject_id")
# Select columns
libre_package <- libre_package %>% select(subject_id,
                                            percent_time_under_54,X.54,
                                            percent_time_under_70,X.70,
                                            percent_time_70_180,X70.180,
                                            percent_time_over_180,X.180,
                                            percent_time_over_250,X.250,
                                            cv,CV,
                                            standard_deviation,SD)
# Dvide software CV by 100, round all columns
libre_package$CV <- libre_package$CV / 100
libre_package[,2:ncol(libre_package)] <- 
  lapply(libre_package[,2:ncol(libre_package)],function(x) round(x,1))
```

## Plots

```{r libre plots,echo=FALSE}
# Make plots
under_54 <- ggplot(libre_package,aes(x = percent_time_under_54,y = X.54)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time Under 54 mg/dL")
under_70 <- ggplot(libre_package,aes(x = percent_time_under_70,y = X.70)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time Under 70 mg/dL")
tir_70_180 <- ggplot(libre_package,aes(x = percent_time_70_180,y = X70.180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time 70 - 180 mg/dL")
over_180 <- ggplot(libre_package,aes(x = percent_time_over_180,y = X.180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time Over 180 mg/dL")
over_250 <- ggplot(libre_package,aes(x = percent_time_over_250,y = X.250)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time Over 250 mg/dL")
sd <- ggplot(libre_package,aes(x = standard_deviation,y = SD)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("Standard Deviation")

(under_54 | under_70 | tir_70_180) / (over_180 | over_250 | sd)
```

## Differences

```{r present libre,echo=FALSE,results='asis'}
# Calculate differences
libre_package <- libre_package %>%
  mutate(`Diff. in % Time Under 54` = X.54 - percent_time_under_54,
         `Diff. in % Time Under 70` = X.70 - percent_time_under_70,
         `Diff. in % Time 70 - 180` = X70.180 - percent_time_70_180,
         `Diff. in % Time Over 180` = X.180 - percent_time_over_180,
         `Diff. in % Time Over 250` = X.250 - percent_time_over_250,
         `Diff. in CV` = CV - cv,`Diff. in SD` = standard_deviation - SD)
# Results table
libre_table <- tableby(~ `Diff. in % Time Under 54` + `Diff. in % Time Under 70` + 
                       `Diff. in % Time 70 - 180` + `Diff. in % Time Over 180` + 
                       `Diff. in % Time Over 250` + `Diff. in CV` + `Diff. in SD`,
                     data = libre_package)
summary(libre_table)
```

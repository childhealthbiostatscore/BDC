---
title: "cgmanalysis Comparison"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,dpi = 600)
knitr::opts_knit$set(root.dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Kaan Akturk/cgmanalysis Comparisons/Medtronic, Dexcom, Libre")
library(arsenal)
library(skimr)
library(knitr)
library(cgmanalysis)
library(tidyverse)
library(blandr)
library(patchwork)
```

```{r cgmanalysis,echo=FALSE,eval=FALSE,warning=FALSE}
# Get cgmanalysis variables
cgmvariables("Cleaned/Dexcom","Cleaned/",outputname = "dexcom_results")
cgmvariables("Cleaned/Libre","Cleaned/",outputname = "libre_results")
cgmvariables("Cleaned/Medtronic","Cleaned/",outputname = "medtronic_results",
             customintervals = list(c(40,50),c(50,70),c(180,250),c(250,400)))
```

# Dexcom vs. cgmanalysis

```{r compare results dexcom,echo=FALSE}
# Read in results from Dexcom, format name
dexcom_software <- read.csv("./Dexcom/Patient List_Dexcom.csv",stringsAsFactors = F)
dexcom_software$Patient.Name <- tolower(dexcom_software$Patient.Name)
colnames(dexcom_software)[2] <- "subject_id"
# Read in results from package, multiply
dexcom_package <- read.csv("./Cleaned/dexcom_results.csv",stringsAsFactors = F)
# Merge
dexcom_package <- left_join(dexcom_package,dexcom_software,by = "subject_id")
# Select columns
dexcom_package <- dexcom_package %>% select(subject_id,
                                            percent_time_under_54,X.54,
                                            percent_time_under_70,X.70,
                                            percent_time_70_180,X70.180,
                                            percent_time_over_180,X.180,
                                            percent_time_over_250,X.250,
                                            cv,CV,
                                            standard_deviation,SD)
# Divide software CV by 100, round all columns
dexcom_package$CV <- dexcom_package$CV / 100
dexcom_package[,2:ncol(dexcom_package)] <- 
  lapply(dexcom_package[,2:ncol(dexcom_package)],function(x) round(x,1))
```

## Plots

### Linear Models

```{r dexcom lm plots,echo=FALSE,fig.width=8,fig.height=6}
# Make plots
under_54 <- ggplot(dexcom_package,aes(x = percent_time_under_54,y = X.54)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time Under 54 mg/dL")
under_70 <- ggplot(dexcom_package,aes(x = percent_time_under_70,y = X.70)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time Under 70 mg/dL")
tir_70_180 <- ggplot(dexcom_package,aes(x = percent_time_70_180,y = X70.180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time 70 - 180 mg/dL")
over_180 <- ggplot(dexcom_package,aes(x = percent_time_over_180,y = X.180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time Over 180 mg/dL")
over_250 <- ggplot(dexcom_package,aes(x = percent_time_over_250,y = X.250)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("% Time Over 250 mg/dL")
sd <- ggplot(dexcom_package,aes(x = standard_deviation,y = SD)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Dexcom Software") + 
  ggtitle("Standard Deviation")
# Layout
(under_54 | under_70 | tir_70_180) / (over_180 | over_250 | sd)
```

### Bland-Altman

```{r dexcom b-a plot,echo=FALSE,warning=F,fig.width=8,fig.height=6}
# Make plots
under_54 <- blandr.draw(dexcom_package$percent_time_under_54,dexcom_package$X.54,
                        ciDisplay = F) + 
  theme_bw() + ggtitle("% Time Under 54 mg/dL")
under_70 <- blandr.draw(dexcom_package$percent_time_under_70,dexcom_package$X.70,
                        ciDisplay = F) + 
  theme_bw() + ggtitle("% Time Under 70 mg/dL")
tir_70_180 <- blandr.draw(dexcom_package$percent_time_70_180,dexcom_package$X70.180,
                          ciDisplay = F) + 
  theme_bw() + ggtitle("% Time 70 - 180 mg/dL")
over_180 <- blandr.draw(dexcom_package$percent_time_over_180,dexcom_package$X.180,
                        ciDisplay = F) + 
  theme_bw() + ggtitle("% Time Over 180 mg/dL")
over_250 <- blandr.draw(dexcom_package$percent_time_over_250,dexcom_package$X.250,
                        ciDisplay = F) + 
  theme_bw() + ggtitle("% Time Over 250 mg/dL")
sd <- blandr.draw(dexcom_package$standard_deviation,dexcom_package$SD,
                  ciDisplay = F) + 
  theme_bw() + ggtitle("Standard Deviation")
# Layout
(under_54 | under_70 | tir_70_180) / (over_180 | over_250 | sd)
```

## Differences

```{r present dexcom,echo=FALSE,results='asis'}
# Calculate differences
dexcom_package <- dexcom_package %>%
  mutate(`Diff. in % Time Under 54` = X.54 - percent_time_under_54,
         `Diff. in % Time Under 70` = X.70 - percent_time_under_70,
         `Diff. in % Time 70 - 180` = X70.180 - percent_time_70_180,
         `Diff. in % Time Over 180` = X.180 - percent_time_over_180,
         `Diff. in % Time Over 250` = X.250 - percent_time_over_250,
         `Diff. in CV` = CV - cv,`Diff. in SD` = standard_deviation - SD)
# Results table and p values
dex_table <- tableby(~ `Diff. in % Time Under 54` + `Diff. in % Time Under 70` + 
                       `Diff. in % Time 70 - 180` + `Diff. in % Time Over 180` + 
                       `Diff. in % Time Over 250` + `Diff. in CV` + `Diff. in SD`,
                     data = dexcom_package)
ps <- 
  sapply(c("Diff. in % Time Under 54","Diff. in % Time Under 70",
           "Diff. in % Time 70 - 180","Diff. in % Time Over 180",
           "Diff. in % Time Over 250","Diff. in CV","Diff. in SD"), 
         function(x){
           t = t.test(dexcom_package[,x])
           t$p.value
         })
summary(dex_table)
kable(as.data.frame(ps))
```

# Dexcom vs. Tandem vs. cgmanalysis

```{r dex tandem data,echo=FALSE}
dexcom_tandem = read.csv("./tandem_dex_pdfs.csv",stringsAsFactors = F)
dexcom_tandem = round(dexcom_tandem)
```

```{r dex tandem package data,echo=FALSE}
dexcom_tandem_package = read.csv("./tandem_dex_package.csv",stringsAsFactors = F)
dexcom_tandem_package = dexcom_tandem_package %>% 
  select(id,percent_time_under_54,percent_time_under_70,
         percent_time_70_180,percent_time_over_180,percent_time_over_250,
         standard_deviation)
# Get device and separate out id
dexcom_tandem_package$device = 
  ifelse(grepl("Dexcom",dexcom_tandem_package$id),"dex","tandem")
dexcom_tandem_package$id = 
  as.numeric(sapply(strsplit(dexcom_tandem_package$id,"-"),"[[",1))
# To wider
dexcom_tandem_package = dexcom_tandem_package %>%
  pivot_wider(id_cols = "id",names_from = "device",
              values_from = c("percent_time_under_54","percent_time_under_70",
                              "percent_time_70_180","percent_time_over_180",
                              "percent_time_over_250","standard_deviation"))
colnames(dexcom_tandem_package) = 
  gsub("standard_deviation","sd",colnames(dexcom_tandem_package))
# Round
dexcom_tandem_package = round(dexcom_tandem_package)
# Combine all three
dexcom_tandem_package = inner_join(dexcom_tandem,dexcom_tandem_package,by = "id")
```

## Plots

### Linear Models

```{r dexcom vs. tandem lm plots,echo=FALSE,fig.width=8,fig.height=6}
# Make plots
# Under 54
under_54_t_d <- ggplot(dexcom_tandem_package,aes(x = tandem_u54,y = dex_u54)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("Dexcom Software")

under_54_t_p <- ggplot(dexcom_tandem_package,aes(x = tandem_u54,
                                                 y = percent_time_under_54_tandem)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("cgmanalysis Package")

under_54_d_p <- ggplot(dexcom_tandem_package,aes(x = dex_u54,
                                                 y = percent_time_under_54_dex)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Dexcom Software") + ylab("cgmanalysis Package")

(under_54_t_d + plot_spacer()) / (under_54_t_p + under_54_d_p) + 
  plot_annotation(title = "% Time Under 54 mg/dL",
                  theme = theme(plot.title = element_text(hjust = 0.5)))

# Under 70
under_70_t_d <- ggplot(dexcom_tandem_package,aes(x = tandem_u70,y = dex_u70)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("Dexcom Software")

under_70_t_p <- ggplot(dexcom_tandem_package,aes(x = tandem_u70,
                                                 y = percent_time_under_70_tandem)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("cgmanalysis Package")

under_70_d_p <- ggplot(dexcom_tandem_package,aes(x = dex_u70,
                                                 y = percent_time_under_70_dex)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Dexcom Software") + ylab("cgmanalysis Package")

(under_70_t_d + plot_spacer())/ (under_70_t_p + under_70_d_p) + 
  plot_annotation(title = "% Time Under 70 mg/dL",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
# 70 - 180
tir_70_180_t_d <- ggplot(dexcom_tandem_package,aes(x = tandem_70_180,y = dex_70_180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("Dexcom Software")

tir_70_180_t_p <- ggplot(dexcom_tandem_package,aes(x = tandem_70_180,
                                                   y = percent_time_70_180_tandem)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("cgmanalysis Package")

tir_70_180_d_p <- ggplot(dexcom_tandem_package,aes(x = dex_70_180,
                                                   y = percent_time_70_180_dex)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Dexcom Software") + ylab("cgmanalysis Package")

(tir_70_180_t_d + plot_spacer()) / (tir_70_180_t_p + tir_70_180_d_p) + 
  plot_annotation(title = "% Time 70 - 180 mg/dL",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
# Over 180
over_180_t_d <- ggplot(dexcom_tandem_package,aes(x = tandem_a180,y = dex_a180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("Dexcom Software")

over_180_t_p <- ggplot(dexcom_tandem_package,aes(x = tandem_a180,
                                                 y = percent_time_over_180_tandem)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("cgmanalysis Package")

over_180_d_p <- ggplot(dexcom_tandem_package,aes(x = dex_a180,
                                                 y = percent_time_over_180_dex)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Dexcom Software") + ylab("cgmanalysis Package")

(over_180_t_d + plot_spacer()) / (over_180_t_p + over_180_d_p) + 
  plot_annotation(title = "% Time Over 180 mg/dL",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
# Over 250
over_250_t_d <- ggplot(dexcom_tandem_package,aes(x = tandem_a250,y = dex_a250)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("Dexcom Software")

over_250_t_p <- ggplot(dexcom_tandem_package,aes(x = tandem_a250,
                                                 y = percent_time_over_250_tandem)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("cgmanalysis Package")

over_250_d_p <- ggplot(dexcom_tandem_package,aes(x = dex_a250,
                                                 y = percent_time_over_250_dex)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Dexcom Software") + ylab("cgmanalysis Package")

(over_250_t_d + plot_spacer()) / (over_250_t_p + over_250_d_p) + 
  plot_annotation(title = "% Time Over 250 mg/dL",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
# SD
sd_t_d <- ggplot(dexcom_tandem_package,aes(x = tandem_sd,y = dex_sd)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("Dexcom Software")

sd_t_p <- ggplot(dexcom_tandem_package,aes(x = tandem_sd,y = sd_tandem)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Tandem Software") + ylab("cgmanalysis Package")

sd_d_p <- ggplot(dexcom_tandem_package,aes(x = dex_sd,y = sd_dex)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("Dexcom Software") + ylab("cgmanalysis Package")

(sd_t_d + plot_spacer()) / (sd_t_p + sd_d_p) + 
  plot_annotation(title = "Standard Deviation",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
```

### Dexcom vs. Tandem

```{r present dex vs. tandem,echo=FALSE,results='asis'}
# Calculate differences
dexcom_tandem_package <- dexcom_tandem_package %>%
  mutate(`Diff. in % Time Under 54` = dex_u54 - tandem_u54,
         `Diff. in % Time Under 70` = dex_u70 - tandem_u70,
         `Diff. in % Time 70 - 180` = dex_70_180 - tandem_70_180,
         `Diff. in % Time Over 180` = dex_a180 - tandem_a180,
         `Diff. in % Time Over 250` = dex_a250 - tandem_a250,
         `Diff. in SD` = dex_sd - tandem_sd)
# Results table
dex_tan_table <- tableby(~ `Diff. in % Time Under 54` + `Diff. in % Time Under 70` + 
                           `Diff. in % Time 70 - 180` + `Diff. in % Time Over 180` + 
                           `Diff. in % Time Over 250` + `Diff. in SD`,
                         data = dexcom_tandem_package)
ps <- 
  sapply(c("Diff. in % Time Under 54","Diff. in % Time Under 70",
           "Diff. in % Time 70 - 180","Diff. in % Time Over 180",
           "Diff. in % Time Over 250","Diff. in SD"), 
         function(x){
           t = t.test(dexcom_tandem_package[,x])
           t$p.value
         })
summary(dex_tan_table)
kable(as.data.frame(ps))
```

### Tandem vs. cgmanalysis

```{r present tandem vs. package,echo=FALSE,results='asis'}
# Calculate differences
dexcom_tandem_package <- dexcom_tandem_package %>%
  mutate(`Diff. in % Time Under 54` = tandem_u54 - percent_time_under_54_tandem,
         `Diff. in % Time Under 70` = tandem_u70 - percent_time_under_70_tandem,
         `Diff. in % Time 70 - 180` = tandem_70_180 - percent_time_70_180_tandem,
         `Diff. in % Time Over 180` = tandem_a180 - percent_time_over_180_tandem,
         `Diff. in % Time Over 250` = tandem_a250 - percent_time_over_250_tandem,
         `Diff. in SD` = tandem_sd - sd_tandem)
# Results table
tan_pack_table <- 
  tableby(~ `Diff. in % Time Under 54` + `Diff. in % Time Under 70` + 
            `Diff. in % Time 70 - 180` + `Diff. in % Time Over 180` + 
            `Diff. in % Time Over 250` + `Diff. in SD`,
          data = dexcom_tandem_package)
ps <- 
  sapply(c("Diff. in % Time Under 54","Diff. in % Time Under 70",
           "Diff. in % Time 70 - 180","Diff. in % Time Over 180",
           "Diff. in % Time Over 250","Diff. in SD"), 
         function(x){
           t = t.test(dexcom_tandem_package[,x])
           t$p.value
         })
summary(tan_pack_table)
kable(as.data.frame(ps))
```

### Dexcom vs. cgmanalysis

```{r present dex vs. package,echo=FALSE,results='asis'}
# Calculate differences
dexcom_tandem_package <- dexcom_tandem_package %>%
  mutate(`Diff. in % Time Under 54` = dex_u54 - percent_time_under_54_dex,
         `Diff. in % Time Under 70` = dex_u70 - percent_time_under_70_dex,
         `Diff. in % Time 70 - 180` = dex_70_180 - percent_time_70_180_dex,
         `Diff. in % Time Over 180` = dex_a180 - percent_time_over_180_dex,
         `Diff. in % Time Over 250` = dex_a250 - percent_time_over_250_dex,
         `Diff. in SD` = dex_sd - sd_dex)
# Results table
dex_pack_table <- 
  tableby(~ `Diff. in % Time Under 54` + `Diff. in % Time Under 70` + 
            `Diff. in % Time 70 - 180` + `Diff. in % Time Over 180` + 
            `Diff. in % Time Over 250` + `Diff. in SD`,
          data = dexcom_tandem_package)
ps <- 
  sapply(c("Diff. in % Time Under 54","Diff. in % Time Under 70",
           "Diff. in % Time 70 - 180","Diff. in % Time Over 180",
           "Diff. in % Time Over 250","Diff. in SD"), 
         function(x){
           t = t.test(dexcom_tandem_package[,x])
           t$p.value
         })
summary(dex_pack_table)
kable(as.data.frame(ps))
```

# Libre vs. cgmanalysis

```{r compare results libre,echo=FALSE}
# Read in results from Libre, format name
libre_software <- read.csv("Libre/Patient List_Libre.csv",stringsAsFactors = F)
libre_software$Patient.Name <- tolower(libre_software$Patient.Name)
colnames(libre_software)[2] <- "subject_id"
# Read in results from package, multiply
libre_package <- read.csv("Cleaned/libre_results.csv",stringsAsFactors = F)
# Merge
libre_package <- left_join(libre_package,libre_software,by = "subject_id")
# Select columns
libre_package <- libre_package %>% select(subject_id,
                                          percent_time_under_54,X.54,
                                          percent_time_under_70,X.70,
                                          percent_time_70_180,X70.180,
                                          percent_time_over_180,X.180,
                                          percent_time_over_250,X.250,
                                          cv,CV,
                                          standard_deviation,SD)
# Divide software CV by 100, round all columns
libre_package$CV <- libre_package$CV / 100
libre_package[,2:ncol(libre_package)] <- 
  lapply(libre_package[,2:ncol(libre_package)],round)
```

## Plots

### Linear Models

```{r libre lm plots,echo=FALSE,fig.width=8,fig.height=6}
# Make plots
under_54 <- ggplot(libre_package,aes(x = percent_time_under_54,y = X.54)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time Under 54 mg/dL")
under_70 <- ggplot(libre_package,aes(x = percent_time_under_70,y = X.70)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time Under 70 mg/dL")
tir_70_180 <- ggplot(libre_package,aes(x = percent_time_70_180,y = X70.180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time 70 - 180 mg/dL")
over_180 <- ggplot(libre_package,aes(x = percent_time_over_180,y = X.180)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time Over 180 mg/dL")
over_250 <- ggplot(libre_package,aes(x = percent_time_over_250,y = X.250)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("% Time Over 250 mg/dL")
sd <- ggplot(libre_package,aes(x = standard_deviation,y = SD)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Libre Software") + 
  ggtitle("Standard Deviation")

(under_54 | under_70 | tir_70_180) / (over_180 | over_250 | sd)
```

### Bland-Altman

```{r libre b-a plot,echo=FALSE,warning=F,fig.width=8,fig.height=6}
# Make plots
under_54 <- blandr.draw(libre_package$percent_time_under_54,libre_package$X.54,
                        ciDisplay = F) + 
  theme_bw() + ggtitle("% Time Under 54 mg/dL")
under_70 <- blandr.draw(libre_package$percent_time_under_70,libre_package$X.70,
                        ciDisplay = F) + 
  theme_bw() + ggtitle("% Time Under 70 mg/dL")
tir_70_180 <- blandr.draw(libre_package$percent_time_70_180,libre_package$X70.180,
                          ciDisplay = F) + 
  theme_bw() + ggtitle("% Time 70 - 180 mg/dL")
over_180 <- blandr.draw(libre_package$percent_time_over_180,libre_package$X.180,
                        ciDisplay = F) + 
  theme_bw() + ggtitle("% Time Over 180 mg/dL")
over_250 <- blandr.draw(libre_package$percent_time_over_250,libre_package$X.250,
                        ciDisplay = F) + 
  theme_bw() + ggtitle("% Time Over 250 mg/dL")
sd <- blandr.draw(libre_package$standard_deviation,libre_package$SD,
                  ciDisplay = F) + 
  theme_bw() + ggtitle("Standard Deviation")
# Layout
(under_54 | under_70 | tir_70_180) / (over_180 | over_250 | sd)
```

## Differences

```{r present libre,echo=FALSE,results='asis'}
# Calculate differences
libre_package <- libre_package %>%
  mutate(`Diff. in % Time Under 54` = X.54 - percent_time_under_54,
         `Diff. in % Time Under 70` = X.70 - percent_time_under_70,
         `Diff. in % Time 70 - 180` = X70.180 - percent_time_70_180,
         `Diff. in % Time Over 180` = X.180 - percent_time_over_180,
         `Diff. in % Time Over 250` = X.250 - percent_time_over_250,
         `Diff. in CV` = CV - cv,`Diff. in SD` = standard_deviation - SD)
# Results table
libre_table <- tableby(~ `Diff. in % Time Under 54` + `Diff. in % Time Under 70` + 
                         `Diff. in % Time 70 - 180` + `Diff. in % Time Over 180` + 
                         `Diff. in % Time Over 250` + `Diff. in CV` + `Diff. in SD`,
                       data = libre_package)
ps <- 
  sapply(c("Diff. in % Time Under 54","Diff. in % Time Under 70",
           "Diff. in % Time 70 - 180","Diff. in % Time Over 180",
           "Diff. in % Time Over 250","Diff. in CV","Diff. in SD"), 
         function(x){
           t = t.test(libre_package[,x])
           t$p.value
         })
summary(libre_table)
kable(as.data.frame(ps))
```

# Medtronic vs. cgmanalysis

```{r compare results medtronic,echo=FALSE}
# Read in results from Medtronic, format name
medtronic_software <- read.csv("Medtronic/Patient Sheet_Medtronic.csv",
                               stringsAsFactors = F)
medtronic_software$Name <- tolower(medtronic_software$Name)
colnames(medtronic_software)[2] <- "subject_id"
# Read in results from package, multiply
medtronic_package <- read.csv("Cleaned/medtronic_results.csv",stringsAsFactors = F)
# Merge
medtronic_package <- left_join(medtronic_package,medtronic_software,by = "subject_id")
medtronic_package <- medtronic_package[complete.cases(medtronic_package),]
# Select columns
medtronic_package <- medtronic_package %>% select(subject_id,
                                                  percent_time_40_50,X.40.50.,
                                                  percent_time_50_70,X.50.70.,
                                                  percent_time_70_180,X.70.180.TIR,
                                                  percent_time_180_250,X.180.250.,
                                                  percent_time_250_400,X.250.400.)
# Divide software CV by 100, round all columns
medtronic_package[,2:ncol(medtronic_package)] <- 
  lapply(medtronic_package[,2:ncol(medtronic_package)],round)
```

## Plots

### Linear Models

```{r medtronic lm plots,echo=FALSE,fig.width=8,fig.height=6}
# Make plots
tir_40_50 <- ggplot(medtronic_package,aes(x = percent_time_40_50,y = X.40.50.)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Medtronic Software") + 
  ggtitle("% Time 40 - 50 mg/dL")
tir_50_70 <- ggplot(medtronic_package,aes(x = percent_time_50_70,y = X.50.70.)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Medtronic Software") + 
  ggtitle("% Time 50 - 70 mg/dL")
tir_70_180 <- ggplot(medtronic_package,aes(x = percent_time_70_180,y = X.70.180.TIR)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Medtronic Software") + 
  ggtitle("% Time 70 - 180 mg/dL")
tir_180_250 <- ggplot(medtronic_package,aes(x = percent_time_180_250,y = X.180.250.)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Medtronic Software") + 
  ggtitle("% Time 180 - 250 mg/dL")
tir_250_400 <- ggplot(medtronic_package,aes(x = percent_time_250_400,y = X.250.400.)) +
  geom_point() + theme_bw() + geom_abline() + 
  xlab("cgmanalysis Package") + ylab("Medtronic Software") + 
  ggtitle("% Time 250 - 400 mg/dL")

(tir_40_50 | tir_50_70 | tir_70_180) / (tir_180_250 | tir_250_400)
```

### Bland-Altman

```{r medtronic b-a plot,echo=FALSE,warning=F,fig.width=8,fig.height=6}
# Make plots
tir_40_50 <- blandr.draw(medtronic_package$percent_time_40_50,
                         medtronic_package$X.40.50.,
                         ciDisplay = F) + 
  theme_bw() + ggtitle("% Time 40 - 50 mg/dL")
tir_50_70 <- blandr.draw(medtronic_package$percent_time_50_70,
                         medtronic_package$X.50.70.,
                         ciDisplay = F) + 
  theme_bw() + ggtitle("% Time 50 - 70 mg/dL")
tir_70_180 <- blandr.draw(medtronic_package$percent_time_70_180,
                          medtronic_package$X.70.180.TIR,
                          ciDisplay = F) + 
  theme_bw() + ggtitle("% Time 70 - 180 mg/dL")
tir_180_250 <- blandr.draw(medtronic_package$percent_time_180_250,
                           medtronic_package$X.180.250.,
                           ciDisplay = F) + 
  theme_bw() + ggtitle("% Time 180 - 250 mg/dL")
tir_250_400 <- blandr.draw(medtronic_package$percent_time_250_400,
                           medtronic_package$X.250.400.,
                           ciDisplay = F) + 
  theme_bw() + ggtitle("% Time 250 - 400 mg/dL")
# Layout
(tir_40_50 | tir_50_70 | tir_70_180) / (tir_180_250 | tir_250_400)
```

## Differences

```{r present medtronic,echo=FALSE,results='asis'}
# Calculate differences
medtronic_package <- medtronic_package %>%
  mutate(`Diff. in % Time 40 - 50` = X.40.50. - percent_time_40_50,
         `Diff. in % Time 50 - 70` = X.50.70. - percent_time_50_70,
         `Diff. in % Time 70 - 180` = X.70.180.TIR - percent_time_70_180,
         `Diff. in % Time 180 - 250` = X.180.250. - percent_time_180_250,
         `Diff. in % Time 250 - 400` = X.250.400. - percent_time_250_400)
# Results table
medtronic_table <- 
  tableby(~ `Diff. in % Time 40 - 50` + `Diff. in % Time 50 - 70` + 
            `Diff. in % Time 70 - 180` + `Diff. in % Time 180 - 250` + 
            `Diff. in % Time 250 - 400`,data = medtronic_package)
ps <- 
  sapply(c("Diff. in % Time 40 - 50","Diff. in % Time 50 - 70",
            "Diff. in % Time 70 - 180","Diff. in % Time 180 - 250",
            "Diff. in % Time 250 - 400"), 
         function(x){
           t = t.test(medtronic_package[,x])
           t$p.value
         })
summary(medtronic_table)
kable(as.data.frame(ps))
```

---
title: "Medicaid CGM"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tableone)
library(nortest)
library(knitr)
library(lubridate)
source('~/Documents/GitHub/Tim-and-Laura/tim_R_functions.R')
pathstart <- os.check()
```

```{r echo=FALSE}
# Read in demographic data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/Demographics.csv")
demographics <- read.csv(filename)
# Read in CGM data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/30 day CGM data missing studio.csv")
dat <- read.csv(filename,na.strings = c("","NULL"))
# Format CGM data
dat$EncounterDate <- mdy(as.character(dat$EncounterDate))
# Remove rows with no A1c
dat <- dat[which(!is.na(dat$HbA1c)),]
# Replace CGMUse = "No" with NA, fill down "Yes" values (by subject), set NAs back to "No"
# This ensures everything prior to a "Yes" is a "No" and every visit after the first "Yes" is also "Yes"
dat$CGMUse[dat$CGMUse=="No"] <- NA
dat <- dat %>% arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  fill(CGMUse)
dat$CGMUse[is.na(dat$CGMUse)] <- "No"
# Get the last "No" and all "Yes" for each subject
no <- dat[dat$CGMUse == "No",] %>%
  group_by(EPICMRN) %>%
  filter(row_number()==n())
yes <- dat[dat$CGMUse == "Yes",] %>%
  arrange(EPICMRN)
# Merge dataframes so that timediff between "No" and "Yes" can be calculated. Remove all rows with "Yes" < 75 days after "No"
difftimes <- left_join(yes,no,by = "EPICMRN")
difftimes$diff <- as.numeric(difftime(difftimes$EncounterDate.x,difftimes$EncounterDate.y,units = "days"))
difftimes <- difftimes[difftimes$diff >= 75,]
# Get first "Yes" by subject
yes <- difftimes[!is.na(difftimes$EPICMRN),] %>% 
  select(EPICMRN:Medtronic.CGM.Days.x) %>%
  group_by(EPICMRN) %>%
  filter(row_number()==1)
colnames(yes) <- colnames(no)
# Remove "No" subjects without corresponding "Yes" data
no <- no[no$EPICMRN %in% yes$EPICMRN,]
# In the darkness bind them
delta <- rbind(yes,no) %>% arrange(EPICMRN,EncounterDate)
delta <- as.data.frame(delta)
```

```{r echo=FALSE}
# Remove demographics participants who don't have with and without CGM data
demographics <- demographics[which(demographics$EPICMRN %in% unique(delta$EPICMRN)),]
# Format demographic data
demo_datecols <- c("DOB","DateOfDiabetesDiagnosis","FirstVisitDate") 
demographics[,demo_datecols] <- lapply(demographics[,demo_datecols], mdy)
# Age at first visit and diabetes duration
demographics$AgeFirstVisit <- as.numeric(round(difftime(demographics$FirstVisitDate,
                                             demographics$DOB,units = "days")/365.25,2))
demographics$DiabetesDuration <- as.numeric(round(difftime(demographics$DateOfDiabetesDiagnosis,
                                             demographics$DOB,units = "days")/365.25,2))
```

```{r echo=FALSE,include=FALSE}
# Table 1 for cohort of 200
vars <- c("AgeFirstVisit","DiabetesDuration","Gender","Race.Ethnicity")
nonnormal <- norm.check(demographics[,c("AgeFirstVisit","DiabetesDuration")])
t1_full <- CreateTableOne(vars,data = demographics)
t1_full <- as.data.frame(print(t1_full,nonnormal = nonnormal))
```

```{r echo=FALSE}
kable(t1_full,caption = "Descriptive Statistics for Full Cohort")
```

```{r echo=FALSE,include=FALSE}
# Table 1 by CGM = "Yes" vs CGM = "No"
f2l_comps <- CreateTableOne("HbA1c",strata = c("CGMUse","PumpUse"),delta)
f2l_comps <- print(f2l_comps,nonnormal = "HbA1c")
```

```{r echo=FALSE}
kable(f2l_comps,caption ="HbA1c Comparisons Stratified by CGMUse:PumpUse (Kruskal-Wallis Rank Sum Test)")
```

```{r echo=FALSE,include=FALSE}
delta$cgm_pump[delta$CGMUse == "No" & delta$PumpUse == "No"] <- "No CGM:No Pump"
delta$cgm_pump[delta$CGMUse == "No" & delta$PumpUse == "Yes"] <- "No CGM:Yes Pump"
delta$cgm_pump[delta$CGMUse == "Yes" & delta$PumpUse == "No"] <- "Yes CGM:No Pump"
delta$cgm_pump[delta$CGMUse == "Yes" & delta$PumpUse == "Yes"] <- "Yes CGM:Yes Pump"
delta$cgm_pump <- as.factor(delta$cgm_pump)
pwt <- pairwise.wilcox.test(delta$HbA1c,delta$cgm_pump,p.adjust.method = "none")
pwt <- as.data.frame(pwt$p.value)
```

```{r echo=FALSE}
kable(pwt,caption = "Pairwise comparison p values (Wilcoxon rank sum test)")
```

---
title: "Medicaid CGM"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(nlme)
library(tableone)
library(nortest)
library(knitr)
library(tidyverse)
# Check OS and alter file path accordingly.
if (.Platform$OS.type == "windows") {pathstart <- "//ucdenver.pvt/"} else if (.Platform$OS.type == "unix"){pathstart <- "/Volumes/"}
source('~/Documents/GitHub/Tim-and-Laura/tim_R_functions.R')
```

```{r echo=FALSE}
# Read in demographic data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/Demographics.csv")
demographics <- read.csv(filename)
# Read in CGM data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/30 day CGM data missing studio.csv")
dat <- read.csv(filename,na.strings = c("","NULL"))
# Format CGM data
dat$EncounterDate <- lubridate::mdy(as.character(dat$EncounterDate))
# Remove rows with no A1c
dat <- dat[which(!is.na(dat$HbA1c)),]
# Replace CGMUse = "No" with NA, fill down "Yes" values (by subject), set NAs back to "No"
# This ensures everything prior to a "Yes" is a "No" and every visit after the first "Yes" is also "Yes"
# Remove CGMUse column (not a good indicator because it's just a field in Epic)
# and Dexcom/Medtronic-specific columns.
dat$CGMUse <- NULL
dat$Dexcom.CGM.Days <- NULL
dat$Medtronic.CGM.Days <- NULL
# Fill pump use up (Use last encounter when adjusting for pump use)
dat <- dat %>%
  arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  mutate(PumpUse = PumpUse[n()])
# Get the first CGM use >0 for each participant. Set this CGMUse == "Yes"
temp <- dat %>% arrange(EPICMRN,EncounterDate) %>% 
  group_by(EPICMRN) %>%
  filter(X30.day.CGM.use > 0) %>%
  filter(row_number() == 1)
temp$CGMUse <- "Yes"
# Merge the yes dataframe back into the full data set. 
dat <- left_join(dat,temp,by = colnames(dat))
# Fill down CGM use == Yes by ID, replace remaining NAs with No
dat <- dat %>% arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  fill(CGMUse)
dat$CGMUse[is.na(dat$CGMUse)] <- "No"
# Make CMG usage a percentage
dat$CGM_Perc <- (dat$X30.day.CGM.use / 30)*100
# Get the last "No" and all "Yes" for each subject
no <- dat[dat$CGMUse == "No",] %>%
  arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  filter(row_number()==n())
yes <- dat[dat$CGMUse == "Yes",] %>%
  arrange(EPICMRN,EncounterDate)
# Filter out those without on/off data (all yes or all no)
no <- no[no$EPICMRN %in% yes$EPICMRN,]
yes <- yes[yes$EPICMRN %in% no$EPICMRN,]
# Bind together, calculate time difference, filter out all but last no and first yes > 75 days.
delta <- rbind(yes,no) %>%
  arrange(EPICMRN,EncounterDate) %>%
  mutate(diff = difftime(EncounterDate,EncounterDate[1],units = "days"))
yes <- delta %>% filter(CGMUse == "Yes",diff > 75) %>%
  group_by(EPICMRN) %>%
  filter(row_number()==1)
no <- no[no$EPICMRN %in% yes$EPICMRN,]
# Bind yes and no
delta <- rbind(yes, no) %>% arrange(EPICMRN,EncounterDate)
```

```{r echo=FALSE}
# Remove demographics participants who don't have with and without CGM data
demographicsyn <- demographics[which(demographics$EPICMRN %in% unique(delta$EPICMRN)),]
# Format demographic data
demo_datecols <- c("DOB","DateOfDiabetesDiagnosis","FirstVisitDate") 
demographicsyn[,demo_datecols] <- lapply(demographicsyn[,demo_datecols], lubridate::mdy)
# Age at first visit and diabetes duration
demographicsyn$AgeFirstVisit <- as.numeric(round(difftime(demographicsyn$FirstVisitDate,
                                             demographicsyn$DOB,units = "days")/365.25,2))
demographicsyn$DiabetesDuration <- as.numeric(round(difftime(demographicsyn$DateOfDiabetesDiagnosis,
                                             demographicsyn$DOB,units = "days")/365.25,2))
```

```{r echo=FALSE,include=FALSE}
# Table 1 for cohort of 134
vars <- c("AgeFirstVisit","DiabetesDuration","Gender","Race.Ethnicity")
nonnormal <- norm.check(demographicsyn[,c("AgeFirstVisit","DiabetesDuration")])
t1_full <- CreateTableOne(vars,data = demographicsyn)
t1_full <- as.data.frame(print(t1_full,nonnormal = nonnormal))
```

### Table 1: Descriptive statistics for full cohort with both on and off CGM data
```{r echo=FALSE}
kable(t1_full)
```

```{r echo=FALSE,include=FALSE}
# Table 1 by CGM = "Yes" vs CGM = "No"
f2l_comps <- CreateTableOne("HbA1c",strata = c("CGMUse","PumpUse"),delta)
f2l_comps <- print(f2l_comps,nonnormal = "HbA1c")
```

```{r echo=FALSE,include=FALSE}
delta <- delta %>% 
  unite(cgm_pump,CGMUse,PumpUse,remove = F)
# Mixed model testing last no/first yes
# Random intercept
mod_int <- lme(HbA1c ~ cgm_pump,random=~1|EPICMRN,data = delta,na.action = na.omit)
on_off_results <- as.data.frame(summary(mod_int)$tTable)
rownames(on_off_results) <- c("Intercept","cgmNo:pumpNo","cgmNo:pumpYes","cgmYes:pumpNA","cgmYes:pumpNo","cgmYes:pumpYes")
```

### Table 2: Mixed model comparing last HbA1c not on CGM to first HbA1c on CGM, by CGM and pump status
```{r echo=FALSE}
kable(on_off_results, caption = "Fixed Effects")
kable(anova.lme(mod_int), caption = "Type 3 Tests of Fixed Effects")
```

```{r echo=FALSE}
# For each person, average HbA1c on CGM and off
avg_on_off <- dat %>%
  group_by(EPICMRN,CGMUse) %>%
  summarise(mean(HbA1c))

```
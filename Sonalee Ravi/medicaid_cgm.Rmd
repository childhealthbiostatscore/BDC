---
title: "Medicaid CGM"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(nlme)
library(tableone)
library(nortest)
library(knitr)
library(tidyverse)
# Check OS and alter file path accordingly.
if (.Platform$OS.type == "windows") {pathstart <- "//ucdenver.pvt/"} else if (.Platform$OS.type == "unix"){pathstart <- "/Volumes/"}
source('~/Documents/GitHub/Tim-and-Laura/tim_R_functions.R')
```

```{r echo=FALSE,cache=TRUE,include=FALSE}
# Read in demographic data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/Demographics.csv")
demographics <- read.csv(filename)
# Read in CGM data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/30 day CGM data missing studio.csv")
dat <- read.csv(filename,na.strings = c("","NULL"))
# Format CGM data
dat$EncounterDate <- lubridate::mdy(as.character(dat$EncounterDate))
# Remove rows with no A1c
dat <- dat[which(!is.na(dat$HbA1c)),]
# Replace CGMUse = "No" with NA, fill down "Yes" values (by subject), set NAs back to "No"
# This ensures everything prior to a "Yes" is a "No" and every visit after the first "Yes" is also "Yes"
# Remove CGMUse column (not a good indicator because it's just a field in Epic)
# and Dexcom/Medtronic-specific columns.
dat$CGMUse <- NULL
dat$Dexcom.CGM.Days <- NULL
dat$Medtronic.CGM.Days <- NULL
# Fill down PumpUse "Yes", then change all NAs to no. So after first PumpUse "Yes"
# assume they were always on a pump, but not on pump before then.
dat$PumpUse[dat$PumpUse == "No"] <- NA
dat <- dat %>%
  arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  fill(PumpUse)
dat$PumpUse[is.na(dat$PumpUse)] <- "No"
# Get the first CGM use > 0 for each participant. Set this CGMUse == "Yes"
temp <- dat %>% arrange(EPICMRN,EncounterDate) %>% 
  group_by(EPICMRN) %>%
  filter(X30.day.CGM.use > 0) %>%
  filter(row_number() == 1)
temp$CGMUse <- "Yes"
# Merge the yes dataframe back into the full data set. 
dat <- left_join(dat,temp,by = colnames(dat))
# Fill down CGM use == Yes by ID, replace remaining NAs with No
dat <- dat %>% arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  fill(CGMUse)
dat$CGMUse[is.na(dat$CGMUse)] <- "No"
# Make CMG usage a percentage
dat$CGM_Perc <- (dat$X30.day.CGM.use / 30)*100
# Last off CGM to first on
# Get the last "No" and all "Yes" for each subject
no <- dat[dat$CGMUse == "No",] %>%
  arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  filter(row_number()==n())
yes <- dat[dat$CGMUse == "Yes",] %>%
  arrange(EPICMRN,EncounterDate)
# Filter out those without on/off data (all yes or all no)
no <- no[no$EPICMRN %in% yes$EPICMRN,]
yes <- yes[yes$EPICMRN %in% no$EPICMRN,]
# Bind together, calculate time difference, filter out all but last no and first yes > 75 days.
delta <- rbind(yes,no) %>%
  arrange(EPICMRN,EncounterDate) %>%
  mutate(diff = difftime(EncounterDate,EncounterDate[1],units = "days"))
yes <- delta %>% filter(CGMUse == "Yes",diff > 75) %>%
  group_by(EPICMRN) %>%
  filter(row_number()==1)
no <- no[no$EPICMRN %in% yes$EPICMRN,]
# Bind yes and no
delta <- rbind(yes, no) %>% arrange(EPICMRN,EncounterDate)

# Format demographic data
demo_datecols <- c("DOB","DateOfDiabetesDiagnosis","FirstVisitDate") 
demographics[,demo_datecols] <- lapply(demographics[,demo_datecols], lubridate::mdy)
# New variables
demographics$AgeFirstVisit <- as.numeric(round(difftime(demographics$FirstVisitDate,
                                             demographics$DOB,units = "days")/365.25,2))
demographics$DiabetesDuration <- as.numeric(round(difftime(demographics$DateOfDiabetesDiagnosis,
                                             demographics$DOB,units = "days")/365.25,2))
# Remove demographics participants who don't have with and without CGM data
demographicsyn <- demographics[which(demographics$EPICMRN %in% unique(delta$EPICMRN)),]
```

### Table 1: Descriptive statistics for all individuals with HbA1c readings both on and off CGM

```{r echo=FALSE,include=FALSE}
# For each person, average HbA1c on CGM and off, remove those without both
avg_on_off <- dat %>%
  group_by(EPICMRN,CGMUse) %>%
  summarise(mean(HbA1c)) %>%
  group_by(EPICMRN) %>% 
  filter(n() > 1) %>% 
  arrange(EPICMRN,CGMUse)
# Compare
on_off_avg_results <- CreateTableOne("mean(HbA1c)",strata = "CGMUse",data = avg_on_off,
                                     testNonNormal = wilcox.test,argsNonNormal = list(paired = T))
on_off_avg_results <- as.data.frame(print(on_off_avg_results, nonnormal = "mean(HbA1c)"))
p <- wilcox.test(formula = `mean(HbA1c)` ~ CGMUse, data = avg_on_off,paired = T)$p.value
rownames(on_off_avg_results)[2] <- "Mean HbA1c"
on_off_avg_results$p <- as.character(on_off_avg_results$p)
on_off_avg_results$p[2] <- round(p,5)
# Demographics
demographicsoo <- demographics[which(demographics$EPICMRN %in% unique(avg_on_off$EPICMRN)),]
vars <- c("AgeFirstVisit","DiabetesDuration","Gender","Race.Ethnicity")
nonnormal <- norm.check(demographicsoo[,c("AgeFirstVisit","DiabetesDuration")])
t1_on_off <- CreateTableOne(vars,data = demographicsoo)
t1_on_off <- as.data.frame(print(t1_on_off,nonnormal = nonnormal))
```

```{r echo=FALSE}
kable(t1_on_off)
```

### Table 2: Mean HbA1c on CGM and off CGM (CGM Use "Yes" or "No")
```{r echo=FALSE}
kable(on_off_avg_results[,1:3])
```

For this comparison we excluded participants who were never on CGM, and those who only had data while on CGM. HbA1c values while on and off CGM were averaged for each remaining participant. These average HbA1c values were compared using a Wilcoxon signed rank test with continuity correction. 

### Table 3: Descriptive statistics for all individuals with HbA1c reading on CGM >75 days after last HbA1c off CGM 

```{r echo=FALSE,include=FALSE}
# Table 1 for cohort of 134
vars <- c("AgeFirstVisit","DiabetesDuration","Gender","Race.Ethnicity")
nonnormal <- norm.check(demographicsyn[,c("AgeFirstVisit","DiabetesDuration")])
t1_last_first <- CreateTableOne(vars,data = demographicsyn)
t1_last_first <- as.data.frame(print(t1_last_first,nonnormal = nonnormal))
```

```{r echo=FALSE}
kable(t1_last_first)
```

This cohort is similar to the comparison above, but instead of using the average HbA1c on and off CGM, we compared each participant's last HbA1c off CGM to their first HbA1c on CGM (requiring at least 75 days between the two measurements). A total of 6 participants were excluded because they did not have an HbA1c measure more than 75 days after their last off CGM reading.  

### Table 4: Mixed model comparing last HbA1c not on CGM to first HbA1c on CGM, by CGM and pump status

```{r echo=FALSE,include=FALSE}
delta <- delta %>% 
  unite(cgm_pump,CGMUse,PumpUse,remove = F) %>%
  mutate(cgm_pump = factor(cgm_pump, levels = c("No_No","No_Yes","Yes_No","Yes_Yes")))
# Mixed model testing last no/first yes
# Random intercept
mod_int <- lme(HbA1c ~ cgm_pump-1,random=~1|EPICMRN,data = delta,na.action = na.omit)
on_off_results <- as.data.frame(summary(mod_int)$tTable)
rownames(on_off_results) <- c("cgmNo:pumpNo","cgmNo:pumpYes","cgmYes:pumpNo","cgmYes:pumpYes")
```

```{r echo=FALSE}
kable(on_off_results, caption = "Fixed Effects")
kable(anova.lme(mod_int), caption = "Type 3 Tests of Fixed Effects")
```

The above model effectively treats CGM and pump status as a treatment group, and examines the effect on HbA1c. "Value" refers to the average HbA1c for each group.  The type 3 test of fixed effects indicates that combined CGM and pump status was significant overall.

### Table 5: Mean HbA1c and descriptive statistics for individuals with some CGM time vs. those never on CGM

```{r echo=FALSE,include=FALSE}
# Compare A1c in those who never went on CGM to those on CGM
some_cgm_ids <- unique(dat$EPICMRN[which(dat$CGMUse == "Yes")])
dat$CGMUseSomeNever <- ifelse(dat$EPICMRN %in% some_cgm_ids,"Some","Never")
# Group into never CGM yes pump, etc.
dat <- dat %>% 
  unite(cgm_ever_pump,CGMUseSomeNever,PumpUse,remove = F)
# Mixed model with random intercept
mod_cgm_ever <- lme(HbA1c ~ cgm_ever_pump-1,random=~1|EPICMRN,data = dat,na.action = na.omit)
cgm_ever_results <- as.data.frame(summary(mod_cgm_ever)$tTable)
rownames(cgm_ever_results) <- c("cgmNever:pumpNo","cgmNever:pumpYes","cgmSome:pumpNo","cgmSome:pumpYes")
```

```{r echo=FALSE}
kable(cgm_ever_results)
```

CGM uptake = $\frac{177}{892}=19.84\text{ %}$

For this comparison we included those without any time on CGM and those with at least some time on CGM. We calculated average HbA1c for each participant never on CGM, and average HbA1c while on CGM for all those with CGM time. These average HbA1c values were compared using the Kruskal-Wallis Rank Sum Test.

### Figure 1: HbA1c by % CGM Use
```{r echo=FALSE,warning=FALSE,dpi=600}
dat$EPICMRN <- as.factor(dat$EPICMRN)
# Plot
mm_plot <- ggplot(data = dat, aes(x = CGM_Perc, y = HbA1c,group = EPICMRN)) +
  geom_line(size = 0.2,aes(color = EPICMRN)) +
  xlab("% CGM Use") + 
  ylab("HbA1c (%)") + 
  theme(legend.position = "none")
mm_plot
```

### Table 6: Mixed model HbA1c by % CGM Use, adjusted for age, race, diabetes duration, and pump use

```{r echo=FALSE,include=FALSE}
# Add demographic info to main data
dat <- left_join(dat,demographics,by = "EPICMRN")
dat$DiabetesDuration <- difftime(dat$EncounterDate,dat$DateOfDiabetesDiagnosis,units = "weeks")
dat$EPICMRN <- as.factor(dat$EPICMRN)
# Model A1c continuously vs. CGM percentage, adjusting for pump, age, diabetes duration
mod_adj_int <- lme(HbA1c ~ CGM_Perc + Age_AtEncounterDate + DiabetesDuration + PumpUse + Race.Ethnicity,
               random=~1|EPICMRN,data = dat, na.action = na.omit)
mod_adj_int_slp <- lme(HbA1c ~ CGM_Perc + Age_AtEncounterDate + DiabetesDuration + PumpUse + Race.Ethnicity,
               random=~1|EPICMRN/CGM_Perc,data = dat, na.action = na.omit)
# Model selection
summary(mod_adj_int)
summary(mod_adj_int_slp) # Best by AIC
```

```{r echo=FALSE}
kable(summary(mod_adj_int_slp)$tTable,caption = "Fixed Effects")
```

The interpretation of this mixed effects model is similar to a simple linear model. For example, on average each 1 point increase in % CGM use resulted in a decrease in HbA1c of 0.006 after adjusting for age, race, diabetes duration, and pump use. 

A mixed model using random intercept and random slope was compared to one only using random intercept. The model with random slope was chosen based on AIC. 

### Figure 2: % CGM Use Over Time

```{r echo=FALSE}
# Average CGM use change over time
dat <- dat %>%
  arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  mutate(Days = as.numeric(difftime(EncounterDate,EncounterDate[1],units = "days")))
# Plot
use_plot <- ggplot(data = dat, aes(x = Days, y = CGM_Perc,group = as.factor(EPICMRN))) +
  geom_line(size = 0.2,aes(color = EPICMRN)) +
  ylab("% CGM Use") + 
  xlab("Days from First Visit") + 
  theme(legend.position = "none")
```

```{r echo=FALSE,warning=FALSE,dpi=600}
use_plot
```

### Table 7: Mixed model % CGM Use by Days from First Visit

```{r echo=FALSE}
# Model
use_mod <- lme(CGM_Perc ~ Days,random = ~1|EPICMRN,data = dat,na.action = na.omit)
```

```{r echo=FALSE}
kable(summary(use_mod)$tTable,caption = "Fixed Effects")
```
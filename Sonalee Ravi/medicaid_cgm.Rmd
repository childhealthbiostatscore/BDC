---
title: "Medicaid CGM"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tableone)
library(knitr)
library(lubridate)
source('~/Documents/GitHub/Tim-and-Laura/tim_R_functions.R')
pathstart <- os.check()
```

```{r echo=FALSE}
# Read in demographic data
filename <- paste0(pathstart,"/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/Demographics.csv")
demographics <- read.csv(filename,na.strings = c("","NA","NULL"))
# Read in CGM data
filename <- paste0(pathstart,"/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/30 day CGM data missing studio.csv")
dat <- read.csv(filename,na.strings = c("","NA","NULL"))
# Remove rows with no A1c data
dat <- dat[which(!is.na(dat$HbA1c)),]
# If CGM data missing, set CGM use to 0
dat$CGMUse[is.na(dat$CGMUse)] <- "No"
# Remove demographics participants not in CGM data
demographics <- demographics[which(demographics$EPICMRN %in% unique(dat$EPICMRN)),]
# Format demographic data
demo_datecols <- c("DOB","DateOfDiabetesDiagnosis","FirstVisitDate") 
demographics[,demo_datecols] <- lapply(demographics[,demo_datecols], mdy)
# Age at first visit and diabetes duration
demographics$AgeFirstVisit <- as.numeric(round(difftime(demographics$FirstVisitDate,
                                             demographics$DOB,units = "days")/365.25,2))
demographics$DiabetesDuration <- as.numeric(round(difftime(demographics$DateOfDiabetesDiagnosis,
                                             demographics$DOB,units = "days")/365.25,2))
# Format CGM data
dat$EncounterDate <- mdy(as.character(dat$EncounterDate))
```

```{r echo=FALSE}
# Table 1 for full cohort
vars <- c("AgeFirstVisit","DiabetesDuration","Gender","Race.Ethnicity")
nonnormal <- norm.check(demographics[,c("AgeFirstVisit","DiabetesDuration")])
t1_full <- CreateTableOne(vars,data = demographics)
t1_full <- as.data.frame(print(t1_full,nonnormal = nonnormal))
```

```{r echo=FALSE}
# Question 1 - average A1c on and off CGM 
# Find MRNs of participants who have both on and off data
yes_ids <- unique(dat$EPICMRN[dat$CGMUse == "Yes"]) 
no_ids <- unique(dat$EPICMRN[dat$CGMUse == "No"])
yes_no_ids <- intersect(yes_ids,no_ids)
# Make a new dataframe
on_off <- dat[dat$EPICMRN %in% yes_no_ids,]
# Sort by MRN then date, filter to get first and last by CGMUse
on_off <- on_off %>%
  group_by(EPICMRN,CGMUse) %>%
  arrange(EPICMRN,EncounterDate) %>%
  filter(row_number() %in% c(1, n()))
  
last_yes <- on_off %>%
  group_by(EPICMRN) %>%
  transmute(first_yes_a1c = EncounterDate[max(which(CGMUse == "Yes"))]) %>%
  distinct()
```
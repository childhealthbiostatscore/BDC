---
title: "Medicaid CGM"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tableone)
library(knitr)
library(lubridate)
source('~/Documents/GitHub/Tim-and-Laura/tim_R_functions.R')
pathstart <- os.check()
```

```{r echo=FALSE}
# Read in demographic data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/Demographics.csv")
demographics <- read.csv(filename)
# Read in CGM data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Sonalee Ravi/Medicaid CGM/Data_Cleaned/30 day CGM data missing studio.csv")
dat <- read.csv(filename,na.strings = c("","NULL"))
# Format CGM data
dat$EncounterDate <- mdy(as.character(dat$EncounterDate))
# Remove rows with no A1c data
dat <- dat[which(!is.na(dat$HbA1c)),]
# Replace CGMUse = "No" with NA, fill down "Yes" values (by subject), set NAs back to "No"
# This ensures everything prior to a "Yes" is a "No" and every visit after the first "Yes" is also "Yes"
dat$CGMUse[dat$CGMUse=="No"] <- NA
dat <- dat %>% arrange(EPICMRN,EncounterDate) %>%
  group_by(EPICMRN) %>%
  fill(CGMUse)
dat$CGMUse[is.na(dat$CGMUse)] <- "No"
# Find the last "No" and all "Yes" for each subject
no <- dat[dat$CGMUse == "No",] %>%
  group_by(EPICMRN) %>%
  filter(row_number()==n())
no <- rbind(no,dat[dat$CGMUse == "Yes",]) %>%
  arrange(EPICMRN)
# Check which is the first "Yes" > 75 days from "No"



yes <- dat[dat$CGMUse == "Yes",] %>%
  group_by(EPICMRN) %>%
  filter(row_number()==n())
# Remove those without CGM = "Yes"
no <- no[no$EPICMRN %in% yes$EPICMRN,]
# Remove those with only CGMUse = "Yes"
yes <- yes[yes$EPICMRN %in% no$EPICMRN,]
# Join them
temp <- rbind(yes,no)
temp <- temp[order(temp$EPICMRN),]
# Remove demographics participants not in CGM data
demographics <- demographics[which(demographics$EPICMRN %in% unique(dat$EPICMRN)),]
# Format demographic data
demo_datecols <- c("DOB","DateOfDiabetesDiagnosis","FirstVisitDate") 
demographics[,demo_datecols] <- lapply(demographics[,demo_datecols], mdy)
# Age at first visit and diabetes duration
demographics$AgeFirstVisit <- as.numeric(round(difftime(demographics$FirstVisitDate,
                                             demographics$DOB,units = "days")/365.25,2))
demographics$DiabetesDuration <- as.numeric(round(difftime(demographics$DateOfDiabetesDiagnosis,
                                             demographics$DOB,units = "days")/365.25,2))
```

```{r echo=FALSE}
# Table 1 for full cohort
vars <- c("AgeFirstVisit","DiabetesDuration","Gender","Race.Ethnicity")
nonnormal <- norm.check(demographics[,c("AgeFirstVisit","DiabetesDuration")])
t1_full <- CreateTableOne(vars,data = demographics)
t1_full <- as.data.frame(print(t1_full,nonnormal = nonnormal))
```

```{r echo=FALSE}

```
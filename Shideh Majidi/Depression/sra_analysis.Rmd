---
title: "Suicide Risk Assessment"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("C:/Users/tim/Documents/GitHub/BDC-Code/Shideh Majidi/Depression/sra.r")
source("C:/Users/tim/Documents/GitHub/Tim-and-Laura/tim_r_functions.R")
a1cs <- read.csv("Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Shideh Majidi/Depression/Data_Cleaned/a1cs.csv")
library(arsenal)
library(VGAM)
library(nlme)
library(emmeans)
library(splines)
library(skimr)
library(knitr)
library(reshape2)
library(tidyverse)
```

```{r a1c data import,echo=FALSE}
a1cs$A1cResultDate <- lubridate::mdy(a1cs$A1cResultDate)
temp <- data
temp$record_id <- as.numeric(as.character(temp$record_id))
# Add screen date to A1c data, find days between
a1cs <- left_join(a1cs,temp[,c("record_id","screen_date",
                               "charttreatafter.factor",
                               "charttreatbefore.factor")],
                  by = "record_id")
a1cs$days_from_screen <- 
  round(as.numeric(difftime(a1cs$A1cResultDate,a1cs$screen_date,
                            units = "days")))
# 1 year pre-/post-screening
a1cs <- a1cs[abs(a1cs$days_from_screen) < 365.25,]
# Clean up
rm(temp)
```

# Table 1: Descriptive Characteristics

```{r table 1,echo=FALSE,results='asis'}
t1 <- tableby(charttreatafter.factor ~ age + diabetes_duration + a1c + 
                total_score_epic + followupscore + sex.factor + 
                race.factor + ethnicity.factor + insurance.factor + 
                pump_use.factor + cgm.factor + si_pos.factor + 
                followupphq9.factor + followupsi,data)
newlabels <- list(sex.factor = "Sex",race.factor = "Race",
                  ethnicity.factor = "Ethnicity",
                  insurance.factor = "Insurance",
                  insulin_type.factor = "Insulin Type",
                  pump_use.factor = "Pump Use", 
                  cgm.factor = "CGM Use",
                  followupphq9.factor = "Follow-Up PHQ 9?",
                  followupsi = "Follow-Up SI?")
summary(t1,pfootnote = T,labelTranslations = newlabels)
```

# HbA1c

## Pre-/post-Screening

HbA1c was not significantly different 1 year before and 1 year after screening (p = `r round(t.test(data$a1c_1yearbefore,data$a1c_1yearafter,paired = T)$p.value,3)`).

## HbA1c by Days From Screening

```{r echo=FALSE,warning=FALSE,message=FALSE,dpi=1200,fig.width=7}
ggplot(a1cs[a1cs$days_from_screen>=0,],
       aes(x = days_from_screen,y = A1cValue)) +
  geom_point(shape = ".") +
  geom_smooth(aes(linetype = charttreatafter.factor),
              se = F,color = "black") + 
  xlab("Days from Screening") + ylab("HbA1c (%)") +
  scale_linetype_discrete(name = "Mental Health Follow-up") +
  theme_bw() 
```

The teal and red lines indicate locally-smoothed (loess) curves for the two groups. It looks like there are two limits of detection in measuring HbA1c, which is why there appear to be horizontal lines at 14.1% and 15%. We probably do not need to worry about these censored results for the abstract, but Laura and I are looking into ways to deal with it for a manuscript.

About `r round(length(which(a1cs$A1cValue == 15))/length(a1cs$A1cValue),3)*100`% of the values are at 15% and another `r round(length(which(a1cs$A1cValue == 14.1))/length(a1cs$A1cValue),3)*100`% of the values are at 14.1%.

<!-- ## First, Screening, and Last A1cs -->

<!-- ```{r echo=FALSE,warning=FALSE,message=FALSE,include=FALSE} -->
<!-- random <- a1cs %>% group_by(record_id) %>%  -->
<!--   slice(which.min(days_from_screen),which(days_from_screen == 0),  -->
<!--         which.max(days_from_screen)) -->
<!-- ggplot(random,aes(x = days_from_screen,y = A1cValue)) +  -->
<!--   theme_bw() + -->
<!--   geom_line(aes(group = record_id,color = factor(charttreatafter))) -->
<!-- ``` -->

## Piecewise Regression

```{r echo=FALSE,include=FALSE}
# AR(1) is much better, so refit with REML and check polynomials. 
a1c_mod_poly <- lme(A1cValue ~ poly(days_from_screen,4),random = ~1|record_id,
               data = a1cs,correlation = corAR1())
# Can use linear time. Use splines for knot at 0. Random intercept and slope for subject.
a1cs$days_star <- ifelse(a1cs$days_from_screen < 0,0,a1cs$days_from_screen)
a1c_mod_ri <- lme(A1cValue ~ days_from_screen*charttreatafter.factor + 
                    days_star*charttreatafter.factor,
               random = ~1|record_id,data = a1cs,correlation = corAR1(),method = "ML")
a1c_mod_ris <- lme(A1cValue ~ days_from_screen*charttreatafter.factor + 
                     days_star*charttreatafter.factor,
               random = ~days_from_screen|record_id,data = a1cs,correlation = corAR1())
AIC(a1c_mod_ri,a1c_mod_ris) # RI only better by AIC
# Correlation structure
mod <- lme(A1cValue ~ days_from_screen*charttreatafter.factor + 
                    days_star*charttreatafter.factor,
           random = ~1|record_id,data = a1cs,method = "ML")
mod_ar1 <- lme(A1cValue ~ days_from_screen*charttreatafter.factor + 
                    days_star*charttreatafter.factor,random = ~1|record_id,data = a1cs,
               correlation = corAR1(),method = "ML")
AIC(mod,mod_ar1)
# Censored
a1cs$A1cCensored <- a1cs$A1cValue
a1cs$A1cCensored[a1cs$A1cCensored > 14.1] <- 14.1
cens <- vglm(A1cValue ~ days_from_screen*charttreatafter.factor + 
                     days_star*charttreatafter.factor, tobit(Upper = 14.1), 
             data = a1cs)
uncens <- glm(A1cValue ~ days_from_screen*charttreatafter.factor + 
                     days_star*charttreatafter.factor,data = a1cs)
```

```{r plot model,echo=FALSE,include=FALSE}
# Plot splines
ggplot(data = a1cs,aes_string(x = "days_from_screen",y = "A1cValue",
                                           group = "record_id")) + 
  geom_line(aes_string(x = "days_from_screen",y = fitted(a1c_mod_ri)),
            alpha = 0.05) +
  theme_bw() +
  xlab("Days from Start") + ylab("HbA1c (%)")
```

```{r model results, echo=FALSE}
# Adjust for previous treatment 
a1c_mod_ri <- lme(A1cValue ~ days_from_screen*charttreatafter.factor + 
                    days_star*charttreatafter.factor + charttreatbefore.factor,
               random = ~1|record_id,data = a1cs,correlation = corAR1(),
               method = "ML")
# Spline results
results <- format_nlme_out(a1c_mod_ri,kable = F)
vars <- c("Days","No Evidence of Psych. Treat.","Change in Slope",
          "No Previous Psych. Treat.")
format_nlme_out(a1c_mod_ri,varnames = vars)
# emmeans
em <- emmeans(a1c_mod_ri,~days_star*charttreatafter.factor)
```

On average, HbA1c changed by `r results["days_from_screen","Value"]` per day for all participants (p = `r results["days_from_screen","p-value"]`). HbA1c changed by an additional `r results["days_from_screen:charttreatafter.factorNo","Value"]` each day for those with no evidence of psychological treatment compared to those with evidence for treatment (p = `r results["days_from_screen:charttreatafter.factorNo","p-value"]`). In other words, the slopes for the two groups are significantly different and the "No Evidence" group was essentially flat.

The slope changed by `r results["days_star","Value"]` on average post-screening for all participants (p = `r results["days_star","p-value"]`). On average the change in slope post-screening visit was different by `r results["charttreatafter.factorNo:days_star","Value"]` for those with no evidence of psychological treatment compared to those with evidence for treatment (p = `r results["charttreatafter.factorNo:days_star","p-value"]`). So again, the two groups are significantly different and the "No Evidence" group stayed essentially flat post-screening.

The results above were not affected by adjustment for previous psychological treatment. However, on average those with no evidence of previous psychological treatment had HbA1c values different by `r results["charttreatbefore.factorNo","Value"]` compared to those with evidence of previous treatment (p = `r results["charttreatbefore.factorNo","p-value"]`).

# Predicting use of psych treatment

```{r logistic model,echo=FALSE}
data$charttreatafter.factor <- relevel(data$charttreatafter.factor,ref = "No")
# Check models
mod <- glm(charttreatafter.factor ~ sex.factor + race.factor + ethnicity.factor
           + insurance.factor + a1c + total_score_epic + pump_use.factor + cgm.factor +
             charttreatbefore.factor,
           data = data,family = binomial(link='logit'))
# Nice formatting
results <- format_logistic_out(mod,kable = F)
format_logistic_out(mod,varnames = c("Male","Non-white","Hispanic or Latino",
                                     "Private insurance","HbA1c at Screening",
                                     "PHQ9 score","No pump","No CGM",
                                     "No previous treat."))
```

In order to get this model to work, I had to combine levels of race (white vs. non-white), ethnicity (Hispanic vs. non-Hispanic or unknown), and insurance (private vs. other). 

Males were `r abs(results["sex.factorMale","Percent Change"])`% less likely to use psych resources after screening (p = `r results["sex.factorMale","p-value"]`). Hispanics were `r abs(results["ethnicity.factorHispanic or Latino","Percent Change"])`% less likely (p = `r results["ethnicity.factorHispanic or Latino","p-value"]`) and those with no previous treatment were `r abs(results["charttreatbefore.factorNo","Percent Change"])`% less likely (p = `r results["charttreatbefore.factorNo","p-value"]`) to get treatment after screening. For each one unit increase in PHQ9 score, participants were on average `r abs(results["total_score_epic","Percent Change"])`% more likely to get treatment (p = `r results["total_score_epic","p-value"]`).
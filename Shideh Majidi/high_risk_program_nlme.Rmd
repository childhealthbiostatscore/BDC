---
title: "High Risk Program"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tableone)
library(tidyverse)
library(nlme)
library(redcapAPI)
library(knitr)
# Check OS and alter file path accordingly.
if (.Platform$OS.type == "windows") {pathstart <- "//ucdenver.pvt/"} else if (.Platform$OS.type == "unix"){pathstart <- "/Volumes/"}
source("/Users/timvigers/Documents/GitHub/Tim-and-Laura/tim_R_functions.R")
```

```{r echo=FALSE, include=FALSE, eval=FALSE}
# REDCap R file
source(paste0(pathstart,'som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Shideh Majidi/High Risk Program/Data_Cleaned/HighRiskProgramClean_R_2018-11-20_1104.r'))
data$pt_status <- NULL
set.seed(1017)
```

```{r echo=FALSE,cache=TRUE}
# REDCap API data import
source("/Users/timvigers/Documents/GitHub/BDC-Code/api_tokens.R")
rcon <- redcapConnection(url = "https://redcap.ucdenver.edu/api/",
                         token = majidi_high_risk)
data_full <- exportRecords(rcon)
```

```{r echo=FALSE,include=FALSE}
data <- data_full
# import start and end dates, merge with data, fill down id columns
dates <- read.csv(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Shideh Majidi/High Risk Program/Data_Cleaned/StartEndDates.csv"))
dates <- dates %>% select(record_id,program_start_date,program_end_date,Gender)
dates$record_id <- as.character(dates$record_id)
data <- left_join(data,dates,by = "record_id") %>%
  fill(record_id,name,mrn,control,case_id,dob)
# Fix incorrect visit date and BG check value.
data$visitdate[which(data$visitdate == "2006-04-01")] <- "2016-04-01"
data$bgchecks[which(data$bgchecks == 47)] <- 7
# Re-format columns
data$Gender <- as.factor(data$Gender)
data$a1c <- as.numeric(data$a1c)
data$visitdate <- lubridate::ymd(as.character(data$visitdate))
data$dob <- lubridate::ymd(as.character(data$dob))
data$program_start_date <- lubridate::mdy(as.character(data$program_start_date))
data$program_end_date <- lubridate::mdy(as.character(data$program_end_date))
data$case_id <- as.factor(data$case_id)
data$control <- as.factor(data$control)
data$sw <- as.character(data$sw)
data$lowbg <- as.numeric(data$lowbg)
data$targetbg <- as.numeric(data$targetbg)
data$highbg <- as.numeric(data$highbg)
data$hospitalbefore <- as.numeric(data$hospitalbefore)
data$hosp_dur <- as.numeric(data$hosp_dur)
data$hospitalpost <- as.numeric(data$hospitalpost)
data$nsbefore <- as.numeric(data$nsbefore)
data$ns_dur <- as.numeric(data$ns_dur)
data$nspost <- as.numeric(data$nspost)
data$cancelbefore <- as.numeric(data$cancelbefore)
data$cancel_dur <- as.numeric(data$cancel_dur)
data$cancelpost <- as.numeric(data$cancelpost)
# Remove participants with unverifiable BGs
incorrect.bgs <- read.csv(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Shideh Majidi/High Risk Program/Data_Cleaned/NotVerifiedBG.csv"))
incorrect.bgs$Record.ID <- as.character(incorrect.bgs$Record.ID)
data <- data %>%
  filter(!(record_id %in% incorrect.bgs$Record.ID))
# Calculate days between visits, age, t1d duration. Find those with complete data.
data <- data %>% 
  arrange(record_id) %>%
  group_by(record_id) %>%
  mutate(days = visitdate - lag(visitdate)) %>%
  mutate(Age = round(as.numeric(difftime(visitdate,dob,units = "days")/365.2425),3)) %>%
  mutate(T1Dyears = round(as.numeric(difftime(dx,dob,units = "days")/365.2425),3)) %>%
  mutate(base_a1c = a1c[2]) %>%
  mutate(complete = length(which(!is.na(visitdate))))
```

```{r echo=FALSE}
# Match each case to 1 control
match <- data %>%
  group_by(record_id) %>%
  filter(row_number()==1)
match$treat <- ifelse(match$control == "No",1,0)
# find those with most data
match <- match %>%
  group_by(case_id,treat) %>%
  filter(complete == max(complete)) %>%
  arrange(case_id,desc(treat))
# Remove those case IDs without a case. If two are tied for amount of data, 
# use baseline A1c as a tiebreaker.
match <- match %>%
  group_by(case_id) %>%
  mutate(a1c_diff = abs(base_a1c - base_a1c[1])) %>% 
  filter(n() > 1) %>%
  slice(c(1,which(a1c_diff == min(a1c_diff[2:n()])))) %>%
  arrange(case_id,treat)
# 4 cases were excluded based on unverifiable BG values, 
# so should be 31 cases and 31 controls.

# Remove all unnecessary controls
data <- data %>%
  filter(record_id %in% match$record_id)
```

```{r echo=FALSE,include=FALSE}
# Format data table
t1vars <- c("Age","T1Dyears","a1c","hospitalbefore","hosp_dur","hospitalpost",
            "nsbefore","ns_dur","nspost","cancelbefore","cancel_dur",
            "cancelpost","Gender","race_ethnicity","insurance","treatment___1",
            "treatment___2","treatment___3")
demos1 <- filter(data, redcap_event_name == "event_1_arm_1") %>% 
  select("record_id","treatment___1","treatment___2","treatment___3",t1vars[-c(1,3)])
demos2 <- filter(data, redcap_event_name == "event_2_arm_1") %>%
  select("record_id","control","case_id","a1c","Age")
demos <- merge(demos1,demos2, by = "record_id") %>%
  arrange(case_id,control)
# Make table 1
t1 <- CreateTableOne(t1vars,strata = "control",data = demos,
                     testNonNormal = wilcox.test,
                     argsNonNormal = list(paired = TRUE),
                     testNormal = t.test,
                     argsNormal = list(paired = TRUE))

t1 <- print(t1,exact = c("insurance","race_ethnicity","treatment___3"),
            nonnormal = norm.check(demos,t1vars[1:12]))
```

# Background

The purpose of this analysis is to test whether the high risk program was successful in improving diabetes outcomes.  Outcomes of interest include frequency of visits, rates of no shows and cancellations, and measurements of glycemia.

# Methods

Participants who completed at least 5 visits were matched to controls.  Length of participation in the program varied, so for each participant, the same amount of time before and after the program was included in the analysis.  

For each outcome, the means before, during, and after the program were compared in participants and controls using linear mixed effects models.  

The rate of change (slopes) of each outcome was compared in participants and controls using interrupted time series models.  These models estimated the slopes during two time periods, and then compared the slopes between participants and controls.  Therefore, separate models were run for each of the three pairwise comparisons of time periods (before vs. during, during vs. after, and before vs. after).  

# Results

Table 1 shows descriptive statistics at baseline in participants and controls.

Comparisons of mean outcomes in participants and controls during the period before the intervention are shown in Table 2a.  Comparisons during the program are shown in Table 2b, and after the program are shown in Table 2c.

Each interrupted time series model (corresponding to one outcome and comparison of two time periods) is summarized in a separate table.  The estimates in the tables can be interpreted as in the following example:

- "Intercept: control" - this is the estimated value of the outcome in the controls at the earliest time period included in the model
- "Intercept: case" - this is the estimated value of the outcome in the participants at the earliest time period included in the model
- "Intercept: case-control" - this is the difference in the intercepts in the cases and participants
- "Slope(time) before k: control" - this is the estimate of the slope in the controls before the intervention
- "Slope(time) before k: case" - this is the estimate of the slope in the participants before the intervention
- "Slope(time) before k: case-con" - this is the difference in the slopes in the participants and controls before the intervention
- "Slope(time) after k: control" - this is the estimate of the slope in the controls after the intervention
- "Slope(time) after k: case" - this is the estimate of the slope in the participants after the intervention
- "Slope(time) after k: case-con" - this is the difference in the slopes in the participants and controls after the intervention
- "Slope(time) change k: control" - this is the estimate of the change in the slope (during-before) in controls
- "Slope(time) change k: case" - this is the estimate of the change in the slope (during-before) in participants
- "Slope(time) change k: case-con" - this is the estimate of the difference in the change in slopes between participants and controls

After the tables summarizing each of the interrupted time series models, there are figures which show the longitudinal trajectories of the outcomes over time, with regression lines for participants and controls superimposed.


Table 1: Descriptive Statistics at Baseline Stratified by Control
```{r echo=FALSE}
kable(t1[,1:3])
```


```{r echo=FALSE}

```


```{r echo=FALSE,eval=FALSE}
# Variables to be collapsed.
vars <- c("a1c","lowbg","targetbg","highbg","bgchecks","days","sw.factor")
# Split by date
before <- data.table(data[which(data$visitdate <= data$program_start_date),
                         c("record_id","control","case_id",vars)])
during <- data.table(data[which(data$visitdate > data$program_start_date & 
                                 data$visitdate <= data$program_end_date),
                          c("record_id","control","case_id",vars)])
after <- data.table(data[which(data$visitdate > data$program_end_date),
                        c("record_id","control","case_id",vars)])
# Format
# Find rows with demographic information.
demo.rows <- which(!is.na(data$cancelbefore) & 
                     data$record_id %in% before$record_id)
# Before
before$visits <- "Yes"
before <- before[,lapply(.SD,function(x) if(typeof(x) == "character") {length(which(x == "Yes"))} else {mean(x,na.rm = T)}),by = list(record_id,control,case_id)]
before <- as.data.frame(before)
before[is.na(before)] <- NA
before$case_id <- as.factor(before$case_id)
before$sw.factor <- as.numeric(before$sw.factor)
before$nsbefore <- data$nsbefore[demo.rows]
before$cancelbefore <- data$cancelbefore[demo.rows]
before$providersnum <- data$providersnum[demo.rows]
# During
demo.rows <- which(!is.na(data$cancel_dur) & 
                     data$record_id %in% during$record_id)
during$visits <- "Yes"
during <- during[,lapply(.SD,function(x) if(typeof(x) == "character") {length(which(x == "Yes"))} else {mean(x,na.rm = T)}),by = list(record_id,control,case_id)]
during <- as.data.frame(during)
during[is.na(during)] <- NA
during$case_id <- as.factor(during$case_id)
during$sw.factor <- as.numeric(during$sw.factor)
during$ns_dur <- data$ns_dur[demo.rows]
during$cancel_dur <- data$cancel_dur[demo.rows]
during$providersnumdur <- data$providersnumdur[demo.rows]
# After
demo.rows <- which(!is.na(data$cancelpost) & 
                     data$record_id %in% after$record_id)
after$visits <- "Yes"
after <- after[,lapply(.SD,function(x) if(typeof(x) == "character") {length(which(x == "Yes"))} else {mean(x,na.rm = T)}),by = list(record_id,control,case_id)]
after <- as.data.frame(after)
after[is.na(after)] <- NA
after$case_id <- as.factor(after$case_id)
after$sw.factor <- as.numeric(after$sw.factor)
after$nspost <- data$nspost[demo.rows]
after$cancelpost <- data$cancelpost[demo.rows]
after$providersnumpost <- data$providersnumpost[demo.rows]
```

```{r echo=FALSE,eval=FALSE}
# Mixed effects function.
mixed.effects <- function(vars, group = "control", random = "case_id", data) {
  results <- as.data.frame(matrix(nrow = length(vars),ncol = 4))
  colnames(results) <- c("Variable","Cases","Controls","P Value")
  for (v in 1:length(vars)) {
    form <- as.formula(paste0(vars[v]," ~ ", group))
    rand <- as.formula(paste0("~1|",random))
    LME <- lme(form, random = rand, data = data,na.action = na.omit)
    summarized <- summary(LME)
    fixed <- as.data.frame(summarized$tTable)
    results$Variable[v] <- vars[v]
    results$Cases[v] <- 
      paste0(round(fixed$Value[1],2)," (",round(fixed$Std.Error[1],2),")")
    results$Controls[v] <- 
      paste0(round(sum(fixed$Value),2)," (",round(fixed$Std.Error[2],2),")")
    results$`P Value`[v] <- fixed$`p-value`[2]
  }
  return(results)
}
```

Table 2a. Results of linear mixed effects models for cases vs. controls before starting the program. Mean (SD), unadjusted p values. 
```{r echo=FALSE,eval=FALSE}
results <- mixed.effects(c(vars,"visits","nsbefore","cancelbefore",
                           "providersnum"),data = before)
results$`P Value` <- format.pval(results$`P Value`,digits = 4,eps = 0.001)
kable(results)
```

Table 2b. Results of linear mixed effects models for cases vs. controls during the program. Mean (SD), unadjusted p values. 
```{r echo=FALSE,eval=FALSE}
results <- mixed.effects(c(vars,"visits","ns_dur","cancel_dur",
                           "providersnumdur"),data = during)
results$`P Value` <- format.pval(results$`P Value`,digits = 4,eps = 0.001)
kable(results)
```

Table 2c. Results of linear mixed effects models for cases vs. controls after the program. Mean (SD), unadjusted p values. 
```{r echo=FALSE,eval=FALSE}
results <- mixed.effects(c(vars,"visits","nspost","cancelpost",
                           "providersnumpost"),data = after)
results$`P Value` <- format.pval(results$`P Value`,digits = 4,eps = 0.001)
kable(results)
```
\pagebreak

```{r echo=FALSE,eval=FALSE}
# Format data for interrupted time series (done in SAS).
# Before vs. during.
bd <- data[which(data$visitdate <= data$program_end_date),
           c("record_id","control","case_id","visitdate",
             "program_start_date",vars)]
bd$time_to_start <- as.numeric(difftime(bd$visitdate,bd$program_start_date,
                                   units = "days"))
bd$k <- 0
bd$timespl1 <- ifelse(bd$time_to_start <= 0,0,bd$time_to_start)
bd$sw.factor <- ifelse(bd$sw.factor == "Yes",1,0)
colnames(bd)[which(colnames(bd)=="control")] <- "case_control"
# During vs. after.
da <- data[which(data$visitdate > data$program_start_date),
           c("record_id","control","case_id","visitdate",
             "program_end_date",vars)]
da$time_to_start <- as.numeric(difftime(da$visitdate,da$program_end_date,
                                   units = "days"))
da$k <- 0
da$timespl1 <- ifelse(da$time_to_start <= 0,0,da$time_to_start)
da$sw.factor <- ifelse(da$sw.factor == "Yes",1,0)
colnames(da)[which(colnames(da)=="control")] <- "case_control"
# Before vs. after.
ba <- data[c(which(data$visitdate <= data$program_start_date),
             which(data$visitdate > data$program_end_date)),
           c("record_id","control","case_id",vars,"visitdate",
             "program_start_date","program_end_date")]
ba <- ba[order(ba$record_id),]
ba$time_to_start <- as.numeric(difftime(ba$visitdate,ba$program_start_date,
                                   units = "days"))
ba$time_from_end <- as.numeric(difftime(ba$visitdate,ba$program_end_date,
                                   units = "days"))
ba$k <- 0
ba$timespl1 <- ifelse(ba$time_to_start <= 0,0,ba$time_from_end)
ba$sw.factor <- ifelse(ba$sw.factor == "Yes",1,0)
colnames(ba)[which(colnames(ba)=="control")] <- "case_control"
ba$plotx <- ifelse(ba$time_to_start <= 0,ba$time_to_start,ba$time_from_end)
```

```{r echo=FALSE,eval=FALSE}
# Write CSV files.
out.dir <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Laura Tim projects/Shideh Majidi/High Risk Program/Data_Cleaned/")
write.csv(bd,file = paste0(out.dir,"before_during.csv"),row.names = F,na = "")
write.csv(da,file = paste0(out.dir,"during_after.csv"),row.names = F,na = "")
write.csv(ba,file = paste0(out.dir,"before_after.csv"),row.names = F,na = "")
```

```{r echo=FALSE,warning=FALSE,dpi=600,eval=FALSE}
# Plots for before vs. during.
for (var in head(vars,-1)) {
  plot <- 
    ggplot(bd,aes_string(x = "time_to_start",y=var)) +
    geom_line(aes_string(group = "record_id", alpha = 0.1)) +
    xlab("Days from Program Start") +
    ylab(var) +
    ggtitle("Before and During Intervention") +
    stat_smooth(data=subset(bd,time_to_start <= 0),
                aes(color = case_control == 0),
                method = "lm",se = F) +
    stat_smooth(data=subset(bd,time_to_start > 0),
                aes(color = case_control == 0),
                method = "lm",se = F) +
    theme(legend.title = element_blank()) +
    scale_color_discrete(labels = c("Controls","Cases")) +
    scale_alpha(guide = "none")
  print(plot)
}
# Plots for during vs. after.
for (var in head(vars,-1)) {
  plot <- 
    ggplot(da,aes_string(x = "time_to_start",y=var)) +
    geom_line(aes_string(group = "record_id")) +
    xlab("Days from Program End") +
    ylab(var) +
    ggtitle("During and After Intervention") +
    stat_smooth(data=subset(da,time_to_start <= 0),
                aes(color = case_control == 0),
                method = "lm",se = F) +
    stat_smooth(data=subset(da,time_to_start > 0),
                aes(color = case_control == 0),
                method = "lm",se = F) +
    theme(legend.title = element_blank()) +
    scale_color_discrete(labels = c("Controls","Cases")) +
    scale_alpha(guide = "none")
  print(plot)
}
# Plots for before vs. after.
for (var in head(vars,-1)) {
  plot <- 
    ggplot(ba,aes_string(x = "plotx",y=var)) +
    geom_line(aes_string(group = "record_id")) +
    xlab("Days from Program Start and End") +
    ylab(var) +
    ggtitle("Before and After Intervention") +
    stat_smooth(data=subset(ba,plotx <= 0),
                aes(color = case_control == 0),
                method = "lm",se = F) +
    stat_smooth(data=subset(ba,plotx > 0),
                aes(color = case_control == 0),
                method = "lm",se = F) +
    theme(legend.title = element_blank()) +
    scale_color_discrete(labels = c("Controls","Cases")) +
    scale_alpha(guide = "none")
  print(plot)
}
```
---
title: "RIP-GC"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(arsenal)
library(skimr)
library(knitr)
library(Epi)
library(epiR)
library(tidyverse)
```

```{r data import,echo=FALSE}
source("/Users/timvigers/Documents/GitHub/BDC-Code/Shideh Majidi/RIP-GC/rip_gc_data.r")
```

# Table 1: Characteristics of patients with T1D stratified by RIPGC risk category

```{r table one,echo=FALSE,results='asis'}
table_one <- tableby(RiskCategory_coded ~ Duration + Age + 
                       Sex + RaceEthnicity_combined + notest(Insurance) + cgm_use + 
                       pump_use,
                     data = demographics)
summary(table_one,digits = 2)
```

# Sensitivity and Specificity

```{r sens spec,echo=FALSE}
# Define poor glycemic control as 9.5% - Schwartz et al. 2014
roc_data$glycemic_control <- cut(roc_data$a1c,c(-Inf,9.5,Inf),right = F,
                                 labels = c("Good","Poor"))
# For each level in RI-PGC score, get test metrics
sens_spec_results <- data.frame()
for(c in levels(roc_data$ripgc)) {
  l <- as.numeric(c)
  roc_data$ripgc_group <- cut(as.numeric(as.character(roc_data$ripgc)),
                              c(-Inf,l,Inf),labels = c("Low","High"),right = F)
  two_by_two <- t(table(roc_data$glycemic_control,roc_data$ripgc_group))
  two_by_two <- two_by_two[c("High","Low"),c("Poor","Good")]
  t <- epi.tests(two_by_two)
  t <- as.data.frame(sapply(t$rval, function(x) round(x,3)))
  sens_spec_results[l+1,"Cutoff"] <- l
  sens_spec_results[l+1,"Sensitivity"] <- 
    paste0(t$se$est," (",t$se$lower,", ",t$se$upper,")")
  sens_spec_results[l+1,"Specificity"] <- 
    paste0(t$sp$est," (",t$sp$lower,", ",t$sp$upper,")")
  sens_spec_results[l+1,"PPV"] <- 
    paste0(t$ppv$est," (",t$ppv$lower,", ",t$ppv$upper,")")
  sens_spec_results[l+1,"NPV"] <- 
    paste0(t$npv$est," (",t$npv$lower,", ",t$npv$upper,")")
}
kable(sens_spec_results,caption = "Poor Glycemic Control")
```

# ROC

```{r ROC,echo=FALSE}
ROC(form = glycemic_control ~ ripgc,data = roc_data,plot = "roc")
```
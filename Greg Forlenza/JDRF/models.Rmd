---
title: "JDRF Models"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Greg Forlenza/JDRF")
library(Hmisc)
library(arsenal)
library(skimr)
library(knitr)
library(glmnet)
library(tidyverse)
```

```{r import data,echo=FALSE}
source("/Users/timvigers/GitHub/BDC-Code/Greg Forlenza/JDRF/data_import.R")
# Exclude participants after 115 and those who never started AM
exclude <- data$record_id[which(data$gyl_timepoint==0 & is.na(data$automode_start))]
data <- data %>% filter(record_id <= 115,!(record_id %in% exclude))
```

```{r data cleaning,echo=FALSE}
# Binary endpoint and predictors
# The primary endpoint of interest will be percent time in closed loop at 1 year 
# captured as a continuous percentage for the 2 weeks prior to the 1 year clinical 
# follow up visit, and will be converted to a binary variable with â‰¥60% representing 
# successful AP use and <60% representing unsuccessful AP use.
df <- left_join(data %>% group_by(record_id) %>% 
                  filter(gyl_timepoint.factor =="12 Months" | 
                           gyl_timepoint.factor =="9 Months") %>%
                  filter(row_number() == n()) %>%
                  summarise(am_final = time_am), 
                data %>% filter(grepl("baseline",redcap_event_name)),
                by = "record_id")
# Remove duplicates
df <- df[-c(which(duplicated(df$record_id))-1),]
# PAID
df$c_paid_total <- 
  apply(df[,which(colnames(df)=="c_paid1"):
                  which(colnames(df)=="c_paid20")],1,
        function(x){mean(5-x)*25})
df$ya_paid_total <- 
  apply(df[,which(colnames(df)=="ya_paid1"):
                  which(colnames(df)=="ya_paid20")],1,
        function(x){sum(x)*1.25})
# HFS behave
df$c_hfs_behave_total <- 
  apply(df[,which(colnames(df)=="c_hfs_behave1"):
                  which(colnames(df)=="c_hfs_behave10")],1,
        function(x){sum(x)})
df$ya_hfs_behave_total <- 
  apply(df[,which(colnames(df)=="ya_hfs_b_behave1"):
                  which(colnames(df)=="ya_hfs_b_behave15")],1,
        function(x){sum(x)})
# HFS worry
df$c_hfs_worry_total <- 
  apply(df[,which(colnames(df)=="c_hfs_worry11"):
                  which(colnames(df)=="c_hfs_worry25")],1,
        function(x){sum(x)})
df$ya_hfs_worry_total <- 
  apply(df[,which(colnames(df)=="ya_hfs_b_worry16"):
                  which(colnames(df)=="ya_hfs_b_worry33")],1,
        function(x){sum(x)})
# Add 1 month variables, select relevant columns
df <- left_join(df,data %>% 
                  filter(gyl_timepoint.factor == "Month 1/ Training F/U") %>%
                  mutate(m1_sensor_wear = sensor_wear,
                         m1_time_am = time_am,
                         m1_tir = sensor_70_180) %>%
                  select(record_id,m1_sensor_wear,m1_time_am,m1_tir),
                by = "record_id") %>%
  select(record_id,am_final,hba1c,c_paid_total,ya_paid_total,
         c_hfs_behave_total,ya_hfs_behave_total,
         c_hfs_worry_total,ya_hfs_worry_total,
         m1_sensor_wear,m1_time_am,m1_tir,
         demographics_t1d_duration,demographics_age,
         demographics_sex.factor,demographics_insurance.factor,
         demographics_race.factor,demographics_ethnicity.factor,
         demographics_cgmhx.factor,demographics_pumphx.factor)
# Binary outcome
df$success <- as.factor(ifelse(df$am_final >= 60,"Success","Failure"))
# Categorical variables
df$demographics_age <- cut(df$demographics_age,c(5,13,18,Inf),right = T,
                           labels = c("6 - 13","14 - 18","18+"))
levels(df$demographics_race.factor) = 
  c("Non-white","Non-white","Non-white","Non-white","White","Non-white","Non-white")
levels(df$demographics_cgmhx.factor) = 
  c("<= 6 months","<= 6 months","6+ months","6+ months","6+ months","6+ months",
    "<= 6 months")
levels(df$demographics_pumphx.factor) = 
  c("<= 6 months","<= 6 months","6+ months","6+ months","6+ months","6+ months",
    "<= 6 months")
```

# Skim

```{r echo=FALSE}
skim(df)
```

# Table 1: Descriptive Characteristics

```{r table 1,echo=FALSE,results='asis'}
t1_form <- paste(colnames(df)[2:ncol(df)],collapse = "+")
t1 <- tableby(as.formula(paste("~",t1_form)),data = df)
summary(t1)
```

# Models

Using the lasso for model selection requires complete data, and the survey variables have a lot of missing data. The sample size of YA participants is too small to use the lasso, but none of the surveys are associated with the outcome based on simple logistic models of the form:

$$
logit(success) = \beta_0+\beta_1*paid+\beta_2*worry+\beta_3*behave + \epsilon
$$

So I think it's safe to exclude them from the final model

## Child Surveys

### Without interaction terms

```{r child without interact,echo=FALSE}
# Child surveys only
dfc <- df %>% select(-ya_paid_total,-ya_hfs_behave_total,-ya_hfs_worry_total)
# Lasso
# Make model matrix and outcome vector
form <- 
  as.formula(paste("success~",paste(colnames(dfc)[3:(ncol(dfc)-1)],
                                    collapse = "+")))
cc <- dfc[complete.cases(dfc),]
x <- model.matrix(form,cc)[,-1]
y <- cc$success
# Fit
fit <- glmnet(x,y,family = "binomial")
plot(fit,xvar = "lambda")
# Cross validation for lambda
cv.fit <- cv.glmnet(x, y, alpha=1, family = "binomial")
plot(cv.fit)
coef(cv.fit)
```

### With interaction terms

```{r child with interact,echo=FALSE}
# Lasso
# Make model matrix and outcome vector
form <- as.formula("success ~ hba1c + c_paid_total + c_hfs_behave_total + 
  c_hfs_worry_total + m1_sensor_wear + m1_time_am + m1_tir + 
  demographics_t1d_duration + demographics_age*demographics_sex.factor + 
  demographics_age*demographics_insurance.factor + demographics_race.factor + 
  demographics_ethnicity.factor + demographics_cgmhx.factor + 
  demographics_pumphx.factor")
cc <- dfc[complete.cases(dfc),]
x <- model.matrix(form,cc)[,-1]
y <- cc$success
# Fit
fit <- glmnet(x,y,family = "binomial")
plot(fit,xvar = "lambda")
# Cross validation for lambda
cv.fit <- cv.glmnet(x, y, alpha=1, family = "binomial")
plot(cv.fit)
coef(cv.fit)
```

## YA Surveys

### Without interaction terms

```{r ya without interact,echo=FALSE,warning=FALSE}
# YA surveys only
dfya <- df %>% select(-c_paid_total,-c_hfs_behave_total,-c_hfs_worry_total)
# Lasso
# Make model matrix and outcome vector
form <- 
  as.formula(paste("success~",paste(colnames(dfya)[3:(ncol(dfya)-1)],
                                    collapse = "+")))
cc <- dfya[complete.cases(dfya),]
x <- model.matrix(form,cc)[,-1]
y <- cc$success
# Fit
fit <- glmnet(x,y,family = "binomial")
plot(fit,xvar = "lambda")
# Cross validation for lambda
cv.fit <- cv.glmnet(x, y, alpha=1, family = "binomial")
plot(cv.fit)
coef(cv.fit)
```

### With interaction terms

```{r ya with interact,echo=FALSE,warning=FALSE}
# Lasso
# Make model matrix and outcome vector
form <- as.formula("success ~ hba1c + ya_paid_total + ya_hfs_behave_total + 
  ya_hfs_worry_total + m1_sensor_wear + m1_time_am + m1_tir + 
  demographics_t1d_duration + demographics_age*demographics_sex.factor + 
  demographics_age*demographics_insurance.factor + demographics_race.factor + 
  demographics_ethnicity.factor + demographics_cgmhx.factor + 
  demographics_pumphx.factor")
cc <- dfya[complete.cases(dfya),]
x <- model.matrix(form,cc)[,-1]
y <- cc$success
# Fit
fit <- glmnet(x,y,family = "binomial")
plot(fit,xvar = "lambda")
# Cross validation for lambda
cv.fit <- cv.glmnet(x, y, alpha=1, family = "binomial")
plot(cv.fit)
coef(cv.fit)
```

### Clarifying questions for Greg

1. Different split for pump history since n is very small for <= 6 months?
2. Ethnicity and race are also pretty unbalanced.

### Other

Baseline HbA1c should always be in the final model.
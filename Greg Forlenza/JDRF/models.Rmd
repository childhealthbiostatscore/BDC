---
title: "JDRF Models"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,dpi = 600)
knitr::opts_knit$set(root.dir = "~/Dropbox/Work/Greg Forlenza/JDRF")
library(Hmisc)
library(arsenal)
library(skimr)
library(knitr)
library(Epi)
library(glmnet)
library(emmeans)
library(tidyverse)
```

```{r import data,echo=FALSE}
source("~/GitHub/BDC-Code/Greg Forlenza/JDRF/data_import.R")
# Exclude participants after 115 and those who never started AM
exclude <- data$record_id[which(data$gyl_timepoint==0 & is.na(data$automode_start))]
data <- data %>% filter(record_id <= 115,!(record_id %in% exclude))
```

```{r data cleaning,echo=FALSE,message=FALSE}
# Binary endpoint and predictors
# The primary endpoint of interest will be percent time in closed loop at 1 year 
# captured as a continuous percentage for the 2 weeks prior to the 1 year clinical 
# follow up visit, and will be converted to a binary variable with â‰¥60% representing 
# successful AP use and <60% representing unsuccessful AP use.
df <- left_join(data %>% group_by(record_id) %>% 
                  filter(gyl_timepoint.factor =="12 Months" | 
                           gyl_timepoint.factor =="9 Months") %>%
                  filter(row_number() == n()) %>%
                  summarise(am_final = time_am), 
                data %>% filter(grepl("baseline",redcap_event_name)),
                by = "record_id")
# Remove duplicates
df <- df[-c(which(duplicated(df$record_id))-1),]
# PAID
df$c_paid_total <- 
  apply(df[,which(colnames(df)=="c_paid1"):
             which(colnames(df)=="c_paid20")],1,
        function(x){mean(5-x)*25})
df$ya_paid_total <- 
  apply(df[,which(colnames(df)=="ya_paid1"):
             which(colnames(df)=="ya_paid20")],1,
        function(x){sum(x)*1.25})
# HFS behave
df$c_hfs_behave_total <- 
  apply(df[,which(colnames(df)=="c_hfs_behave1"):
             which(colnames(df)=="c_hfs_behave10")],1,
        function(x){sum(x)})
df$ya_hfs_behave_total <- 
  apply(df[,which(colnames(df)=="ya_hfs_b_behave1"):
             which(colnames(df)=="ya_hfs_b_behave15")],1,
        function(x){sum(x)})
# HFS worry
df$c_hfs_worry_total <- 
  apply(df[,which(colnames(df)=="c_hfs_worry11"):
             which(colnames(df)=="c_hfs_worry25")],1,
        function(x){sum(x)})
df$ya_hfs_worry_total <- 
  apply(df[,which(colnames(df)=="ya_hfs_b_worry16"):
             which(colnames(df)=="ya_hfs_b_worry33")],1,
        function(x){sum(x)})
# Add 1 month variables, select relevant columns
df <- left_join(df,data %>% 
                  filter(gyl_timepoint.factor == "Month 1/ Training F/U") %>%
                  mutate(m1_sensor_wear = sensor_wear,
                         m1_time_am = time_am,
                         m1_tir = sensor_70_180,
                         m1_boluses = dailybolus) %>%
                  select(record_id,m1_sensor_wear,m1_time_am,m1_tir,m1_boluses),
                by = "record_id") %>%
  select(record_id,am_final,hba1c,c_paid_total,ya_paid_total,
         c_hfs_behave_total,ya_hfs_behave_total,
         c_hfs_worry_total,ya_hfs_worry_total,
         m1_sensor_wear,m1_time_am,m1_tir,m1_boluses,
         demographics_t1d_duration,demographics_age,
         demographics_sex.factor,demographics_insurance.factor,
         demographics_race.factor,demographics_ethnicity.factor,
         demographics_cgmhx.factor,demographics_pumphx.factor)
# Binary outcome
df$success <- as.factor(ifelse(df$am_final >= 60,1,0))
levels(df$success) <- c("Failure","Success")
# Categorical variables
df$Age <- df$demographics_age
df$demographics_age <- cut(df$demographics_age,c(5,13,18,Inf),right = T,
                           labels = c("6 - 13","14 - 18","18+"))
levels(df$demographics_race.factor) = 
  c("Non-white","Non-white","Non-white","Non-white","White","Non-white","Non-white")
levels(df$demographics_cgmhx.factor) = 
  c("<= 6 months","<= 6 months","6+ months","6+ months","6+ months","6+ months",
    "<= 6 months")
levels(df$demographics_pumphx.factor) = 
  c("<= 6 months","<= 6 months","6+ months","6+ months","6+ months","6+ months",
    "<= 6 months")
# Make df for lasso
lasso <- df %>% select(-ya_paid_total,-ya_hfs_behave_total,-ya_hfs_worry_total,
                       -c_paid_total,-c_hfs_behave_total,-c_hfs_worry_total)
```

# Lasso model selection

## M1 data

For model selection, I examined baseline HbA1c, sensor wear,AM use, TIR, daily boluses, T1D duration, age, sex, insurance status, race, ethnicity, CGM history, and pump history. Because some reviewers were concerned about using age as a categorical variable given the different cohorts in the model development and validation datasets, age was kept as a continuous variable in all models. 

### No constraints

```{r without interact,echo=FALSE,warning=FALSE}
# Make model matrix and outcome vector
form <- as.formula("success ~ hba1c + m1_sensor_wear + m1_time_am + m1_tir + m1_boluses +
demographics_t1d_duration + Age + demographics_sex.factor + 
demographics_insurance.factor + demographics_race.factor + 
demographics_ethnicity.factor + demographics_cgmhx.factor + 
demographics_pumphx.factor")
cc <- lasso[complete.cases(lasso),]
x <- model.matrix(form,cc)[,-1]
y <- cc$success
# Cross validation for lambda
cv.fit <- cv.glmnet(x, y, alpha=1, family = "binomial")
coef(cv.fit)
```

With no constraints on the lasso, baseline HbA1c, sensor wear, TIR, daily boluses, sex, ethnicity, and pump history were all selected. 

## Comparing AM Use to Sensor Wear

```{r echo=FALSE}
# Model formulas
model_sens_form <- 
  as.formula("success ~ scale(hba1c,scale=F) + scale(m1_sensor_wear,scale=F) +
             scale(m1_tir,scale=F) + scale(m1_boluses,scale=F) + demographics_sex.factor + 
             demographics_ethnicity.factor + demographics_pumphx.factor")
model_am_form <- 
  as.formula("success ~ scale(hba1c,scale=F) + scale(m1_time_am,scale=F) +
             scale(m1_tir,scale=F) + scale(m1_boluses,scale=F) + demographics_sex.factor + 
             demographics_ethnicity.factor + demographics_pumphx.factor")
# Fit
model_sens <- glm(model_sens_form,family = "binomial",df)
model_am <- glm(model_am_form,family = "binomial",df)
# Compare
kable(AIC(model_am,model_sens))
r_sens <- ROC(form = model_sens_form,data = df,MX=F,MI=F,PV=F,plot = "ROC",
              main = "Sensor Wear Model")
r_am <- ROC(form = model_am_form,data = df,MX=F,MI=F,PV=F,plot = "ROC",
            main = "AM Use Model")
```

Models using AM use at month 1 were compared to models using sensor wear at month 1. Technically, sensor wear was slightly better in terms of AIC and AUC, but the predictive abilities of the models were comparable and both excellent (AUC = 0.928 for sensor wear and AUC = 0.909 for AM use). So, the following models used time in AM instead of sensor wear, given that the validation cohort only has data for AM time.

## Comparing 1 month variables to 3 month variables

```{r echo=FALSE}
# Get three month data
three_month <- data %>% 
  filter(gyl_timepoint.factor == "3 Months") %>%
  mutate(m3_sensor_wear = sensor_wear,
         m3_time_am = time_am,
         m3_tir = sensor_70_180,
         m3_boluses = dailybolus) %>%
  select(record_id,m3_sensor_wear,m3_time_am,m3_tir,m3_boluses)
# Add to df
df <- left_join(df,three_month,by = "record_id")
# Compare 1 month to 3 month
model1 <- 
  as.formula("success ~ scale(hba1c,scale=F) + scale(m1_time_am,scale=F) +
             scale(m1_tir,scale=F) + scale(m1_boluses,scale=F) + demographics_sex.factor + 
             demographics_ethnicity.factor + demographics_pumphx.factor")
model3 <- 
  as.formula("success ~ scale(hba1c,scale=F) + scale(m3_time_am,scale=F) +
             scale(m3_tir,scale=F) + scale(m3_boluses,scale=F) + demographics_sex.factor + 
             demographics_ethnicity.factor + demographics_pumphx.factor")
# Fit
model_m1 <- glm(model1,family = "binomial",df)
model_m3 <- glm(model3,family = "binomial",df)
# Compare
r_sens <- ROC(form = model1,data = df,MX=F,MI=F,PV=F,plot = "ROC",
              main = "1-Month Model")
r_am <- ROC(form = model3,data = df,MX=F,MI=F,PV=F,plot = "ROC",
            main = "3-Month Model")
```

Interestingly, the month 3 model is now better than the month 1 model. There are 75 observations with month 1 data and 62 with month 3 data, so is it possible that dropout is already having an effect. 

## Results

```{r stanford,echo=FALSE,message=FALSE,warning=FALSE}
# Read in
stanford <- read.csv("./Data_Cleaned/stanford.csv",
                     na.strings = c("","NA","na","N/A"),stringsAsFactors = F)
stanford = stanford[-c(which(stanford$Participant.ID %in% c("24","56")))]
# Format variables to match BDC data
num_vars <- c("Baseline.A1c","Auto.Mode...1","Time.in.range.....1","Age")
stanford[,num_vars] <- lapply(stanford[,num_vars], as.numeric)
# Insurance - combine checkboxes
stanford$insurance <- 
  ifelse(stanford$Insurance.Type..choice.Private.HMO. == "Checked" | 
           stanford$Insurance.Type..choice.Private.PPO. == "Checked" |
           stanford$Insurance.Type..choice.Other.Private. == "Checked","Private",
         ifelse(stanford$Insurance.Type..choice.CCS. == "Checked" | 
                  stanford$Insurance.Type..choice.MediCal. == "Checked" |
                  stanford$Insurance.Type..choice.MediCare. == "Checked" |
                  stanford$Insurance.Type..choice.Other.government. == "Checked",
                "Public","Other"))
# Race
stanford$race <- 
  ifelse(stanford$Race..choice.White. == "Checked","White","Non-white")
# Age
stanford <- stanford %>% group_by(Participant.ID) %>%
  mutate(date_diff = lubridate::mdy(Visit.Date) - lubridate::mdy(Auto.Mode.Start[Event.Name == "Automode Start"]) ,
         age_HCL_start = Age[Event.Name == "Baseline"] + 
           (T1D.Duration[Event.Name == "670G Start"] - T1D.Duration[Event.Name == "Baseline"]),
         t = Age[Event.Name == "Baseline"] )
# Get variables from appropriate time points
stan_df <- stanford %>% group_by(Participant.ID) %>%
  summarise(hba1c = Baseline.A1c[Event.Name=="670G Start"],
            m3_time_am = Auto.Mode...1[Event.Name=="3 month visit"],
            m3_tir = Time.in.range.....1[Event.Name=="3 month visit"],
            m3_boluses = X..Boluses.day...Visit[Event.Name=="3 month visit"],
            Age = Age[Event.Name=="Baseline"],
            demographics_sex.factor = Gender[Event.Name=="Baseline"],
            demographics_t1d_duration = 
              as.numeric(T1D.Duration[Event.Name=="Baseline"]),
            demographics_insurance.factor = insurance[Event.Name=="Baseline"],
            demographics_race.factor = race[Event.Name=="Baseline"],
            demographics_ethnicity.factor = Ethnicity[Event.Name=="Baseline"],
            Age = Age[Event.Name=="Baseline"]) %>%
  filter(demographics_sex.factor != "Trans female")
# Correct factor levels
stan_df$demographics_sex.factor <- as.factor(stan_df$demographics_sex.factor)
stan_df$demographics_insurance.factor <- 
  factor(stan_df$demographics_insurance.factor,
         levels = levels(df$demographics_insurance.factor))
stan_df$demographics_race.factor <- 
  factor(stan_df$demographics_race.factor,
         levels = levels(df$demographics_race.factor))
stan_df$demographics_ethnicity.factor <- 
  factor(stan_df$demographics_ethnicity.factor)
levels(stan_df$demographics_ethnicity.factor) <- 
  levels(df$demographics_ethnicity.factor)
# Get am use at final timepoint
success <- stanford %>% group_by(Participant.ID) %>%
  filter(Event.Name == "12 month visit" | 
           Event.Name =="9 month visit") %>%
  filter(row_number() == n()) %>%
  summarise(am_final = Auto.Mode...1)
# Combine covariates and success dfs
stan_df <- left_join(stan_df,success,by = "Participant.ID")
stan_df$success <- as.factor(ifelse(stan_df$am_final >= 60,"Success","Failure"))
# Cohort
stan_df$cohort <- "Stanford"
colnames(stan_df)[1] <- "record_id"
df$cohort <- "BDC"
t1_df <- full_join(df,stan_df)
```

### Table 1a: Descriptive Characteristics by Cohort

```{r table 1,echo=FALSE,results='asis'}
# Table 1 design formula. Visually non-normal variables tested with K-W, categorical
# variables with < 5 in any cell tested with Fisher's exact
t1_form <- "cohort~Age+kwt(am_final)+hba1c+kwt(m1_sensor_wear)+kwt(m3_sensor_wear)+kwt(m1_time_am)+kwt(m3_time_am)+m1_tir+m3_tir+kwt(demographics_t1d_duration)+success+demographics_age+demographics_sex.factor+fe(demographics_insurance.factor)+demographics_race.factor+fe(demographics_ethnicity.factor)"

t1 <- tableby(as.formula(t1_form),data = t1_df[!is.na(t1_df$success),])
summary(t1,labelTranslations = 
          list(am_final = "AM Use at Final Visit",hba1c = "Baseline HbA1c",
               m1_sensor_wear = "M1 Sensor Wear",m3_sensor_wear = "M3 Sensor Wear",
               m1_time_am = "M1 Time in AM",m3_time_am = "M3 Time in AM",
               m1_tir = "M1 TIR",m3_tir = "M3 TIR",
               success = "Success",
               demographics_t1d_duration = "T1D Duration",
               demographics_age = "Age Group",demographics_sex.factor = "Sex",
               demographics_insurance.factor = "Insurance",
               demographics_race.factor = "Race",
               demographics_ethnicity.factor = "Ethnicity",
               demographics_cgmhx.factor = "CGM Hx.",
               demographics_pumphx.factor = "Pump Hx."),
        pfootnote=T)
```

### Table 1b: Descriptive Characteristics by Cohort and Sucess

```{r table 1b,echo=FALSE,results='asis'}
# Table 1 design formula. Visually non-normal variables tested with K-W, categorical
# variables with < 5 in any cell tested with Fisher's exact
t1_form <- "interaction(cohort,success)~Age+kwt(am_final)+hba1c+kwt(m1_sensor_wear)+kwt(m3_sensor_wear)+kwt(m1_time_am)+kwt(m3_time_am)+m1_tir+m3_tir+kwt(demographics_t1d_duration)+demographics_age+demographics_sex.factor+fe(demographics_insurance.factor)+demographics_race.factor+fe(demographics_ethnicity.factor)"

t1 <- tableby(as.formula(t1_form),data = t1_df[!is.na(t1_df$success),])
summary(t1,labelTranslations = 
          list(am_final = "AM Use at Final Visit",hba1c = "Baseline HbA1c",
               m1_sensor_wear = "M1 Sensor Wear",m3_sensor_wear = "M3 Sensor Wear",
               m1_time_am = "M1 Time in AM",m3_time_am = "M3 Time in AM",
               m1_tir = "M1 TIR",m3_tir = "M3 TIR",
               success = "Success",
               demographics_t1d_duration = "T1D Duration",
               demographics_age = "Age Group",demographics_sex.factor = "Sex",
               demographics_insurance.factor = "Insurance",
               demographics_race.factor = "Race",
               demographics_ethnicity.factor = "Ethnicity",
               demographics_cgmhx.factor = "CGM Hx.",
               demographics_pumphx.factor = "Pump Hx."),
        pfootnote=T)
```

### Final model (1 month variables)

```{r m1 time_am,echo=FALSE}
final_model <- 
  as.formula("success ~ scale(hba1c,scale=F) + 
  scale(m1_time_am,scale=F) + scale(m1_tir,scale=F) + 
  demographics_age + demographics_sex.factor")
final_mod = glm(final_model,family = "binomial",df)
t = broom::tidy(final_mod,conf.int = T,exponentiate=T)
t$term[2:nrow(t)] = c("Baseline HbA1c","M1 AM %","M1 TIR",
                      "Baseline Age 14 - 18","Baseline Age 18+","Male")
t[,2:ncol(t)] <- lapply(t[,2:ncol(t)],function(x){round(x,4)})

r = ROC(form = final_model,data = df,MX=F,MI=F,PV=F,plot = "ROC",
        main = "1-Month Model")
kable(t)
```

```{r m1 sensor,echo=FALSE}
final_model <- 
  as.formula("success ~ scale(hba1c,scale=F) + 
  scale(m1_sensor_wear,scale=F) + scale(m1_tir,scale=F) + 
  demographics_age + demographics_sex.factor")

final_mod = glm(final_model,family = "binomial",df)
t = broom::tidy(final_mod,conf.int = T,exponentiate=T)
t$term[2:nrow(t)] = c("Baseline HbA1c","M1 Sensor Wear %","M1 TIR",
                      "Baseline Age 14 - 18","Baseline Age 18+","Male")
t[,2:ncol(t)] <- lapply(t[,2:ncol(t)],function(x){round(x,4)})

r = ROC(form = final_model,data = df,MX=F,MI=F,PV=F,plot = "ROC",main = "1-Month Model")
kable(t)
```

### Final model (3 month variables)

```{r m3 time am model,echo=FALSE}
final_model <- 
  as.formula("success ~ scale(hba1c,scale=F) + 
  scale(m3_time_am,scale=F) + scale(m3_tir,scale=F) + 
  demographics_age + demographics_sex.factor")

final_mod = glm(final_model,family = "binomial",df)
t = broom::tidy(final_mod,conf.int = T)
t$term[2:nrow(t)] = c("Baseline HbA1c","M3 AM %","M3 TIR",
                      "Baseline Age 14 - 18","Baseline Age 18+","Male")
t[,2:ncol(t)] <- lapply(t[,2:ncol(t)],function(x){round(x,4)})

r = ROC(form = final_model,data = df,MX=F,MI=F,PV=F,plot = "ROC",main = "3-Month Model")
kable(t)
```

#### Comparisons between age groups

```{r}
co  <-  coef(final_mod)

age14_18 = c(0,0,0,0,1,0,0)
age18 = c(0,0,0,0,0,1,0)

cmat <- age18-age14_18

exp(cmat %*% co)-1

```

```{r m3 sensor model,echo=FALSE}
final_model <- 
  as.formula("success ~ scale(hba1c,scale=F) + 
  scale(m3_sensor_wear,scale=F) + scale(m3_tir,scale=F) + 
  demographics_age + demographics_sex.factor")

final_mod = glm(final_model,family = "binomial",df)
t = broom::tidy(final_mod,conf.int = T,exponentiate=T)
t$term[2:nrow(t)] = c("Baseline HbA1c","M3 Sensor Wear %","M3 TIR",
                      "Baseline Age 14 - 18","Baseline Age 18+","Male")
t[,2:ncol(t)] <- lapply(t[,2:ncol(t)],function(x){round(x,4)})

r = ROC(form = final_model,data = df,MX=F,MI=F,PV=F,plot = "ROC",main = "3-Month Model")
kable(t)
```

The coefficients above must be exponentiated in order to interpret them. So, the interpretation is that for each 1-unit increase in sensor wear at month 1, the odds of success increase $e^\beta$ = `r exp(t$estimate[t$term == "M3 Sensor Wear"])` times. Continuous variables have been mean-centered, so the intercept is interpreted as the average odds of success for a participant with average values of continuous variables and 0 (reference group) for all categorical.

### Validation

```{r test model,echo=FALSE}
# Model formula
final_model <- 
  as.formula("success ~ scale(hba1c,scale=F) + scale(m3_time_am,scale=F) + 
  scale(m3_tir,scale=F) + demographics_age + demographics_sex.factor")
# Fit
model_stanford <- glm(final_model,family = "binomial",stan_df)
# Results
t = broom::tidy(model_stanford,conf.int = T,exponentiate=T)
t$term[2:nrow(t)] = c("Baseline HbA1c","M3 AM %","M3 TIR",
                      "Baseline Age 14 - 18","Baseline Age 18+","Male")
t[,2:ncol(t)] <- lapply(t[,2:ncol(t)],function(x){round(x,4)})
kable(t)
# ROC
r = ROC(form = final_model,data = stan_df,MX=F,MI=F,PV=F,plot = "ROC",
        main = "Validation")
p = as.data.frame(model_stanford$data)
pred = predict(model_stanford,type = "response")
p[names(pred),"pred"] = pred
g <- roc(success ~ pred, data = p)
plot(g,print.auc=T)

roc_plot = ggplot(p, aes(d = success, m = pred)) + 
  geom_roc(n.cuts = 0) + geom_abline(intercept = 0,slope = 1) + 
  annotate(label = paste("Area under the curve:",round(g$auc,3)),
           x=0.75, y=0.2,family = "Helvetica",geom = "text") + 
  ylab("Sensitivity") + xlab("1 - Specificity") + theme_bw() + 
  ggtitle("Validation") + theme(plot.title = element_text(hjust = 0.5))
ggsave("validation_plot.eps",roc_plot,dpi = 300,device = "eps",
       width = 107, height = 107, units = "mm")
```

# References

1. 	Tibshirani R. Regression Shrinkage and Selection Via the Lasso. J R Stat Soc Ser B Methodol. 1996;58(1):267-288. doi:10.1111/j.2517-6161.1996.tb02080.x

2. 	Hastie T, Tibshirani R, Friedman JH. The Elements of Statistical Learning: Data Mining, Inference, and Prediction. 2nd ed. Springer; 2009

3. 	Friedman J, Hastie T, Tibshirani R. Regularization Paths for Generalized Linear Models via Coordinate Descent. J Stat Softw. 2010;33(1). doi:10.18637/jss.v033.i01

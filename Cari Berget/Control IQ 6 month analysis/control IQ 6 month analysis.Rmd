---
title: "Control IQ 6 Month Analysis"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(redcapAPI)
library(reshape2)
library(tidyverse)
library(skimr)
library(knitr)
library(tableone)
library(readxl)
library(nlme)
library(gridExtra)
library(psych)
library(stringr)
# Check OS and alter file path accordingly.
if (.Platform$OS.type == "windows") {pathstart <- "//ucdenver.pvt/"} else if (.Platform$OS.type == "unix"){pathstart <- "/Volumes/"}
```

```{r echo=FALSE,include=FALSE,cache=TRUE}
source("T:\\Cari Berget\\Control IQ 6 Month MS\\Data raw\\ClinicalObservationC_R_2020-11-18_0959.r")
child_full <- data

source("T:\\Cari Berget\\Control IQ 6 Month MS\\Data raw\\ClinicalObservationP_R_2020-11-18_1005.r")
parent_full <- data

# filter out control IQ users
child_full_iq <- child_full[child_full$record_id>=120,]

# make new visit variable
child_full_iq$visit <- ifelse(str_detect(child_full_iq$redcap_event_name,"baseline"),"B",
                              ifelse(str_detect(child_full_iq$redcap_event_name,"1_arm"),"T1",
                                     ifelse(str_detect(child_full_iq$redcap_event_name,"2_arm"),"T2",
                                                       ifelse(str_detect(child_full_iq$redcap_event_name,"3_arm"),"T3",NA))))

# convert to numeric 
child_full_iq$date_visit <- as.Date(as.character(child_full_iq$date_visit),format="%Y-%m-%d")
child_full_iq$demographics_age <- as.numeric(as.character(child_full_iq$demographics_age))
child_full_iq$hba1c <- as.numeric(as.character(child_full_iq$hba1c))

# keep 6 months of data
child_full_iq <- child_full_iq[child_full_iq$visit %in% c("B","T1","T2"),]

# use date of consent for baseline visit date
child_full_iq[child_full_iq$visit=="B",]$date_visit <- child_full_iq[child_full_iq$visit=="B",]$demographics_consent

# checking visit spacing
View(child_full_iq[,c("record_id","redcap_event_name","visit","date_visit")])

# read in prior insulin mode
ins <- read.csv("T:\\Cari Berget\\Control IQ 6 Month MS\\Data raw\\Prior_insulin_mode_11-16-2020.csv")
ins$a <- NULL
child_full_iq <- merge(child_full_iq,ins,by="record_id",all.x=T,all.y = F)
child_full_iq$prior.insulin.mode <- as.factor(child_full_iq$prior.insulin.mode)

# make baseline dataset
baseline <- child_full_iq[child_full_iq$visit=="B",]

# classify age and A1c
baseline$age_cat <- ifelse(baseline$demographics_age<=13,"<=13  years",ifelse(baseline$demographics_age<=17,
                                                                              "14-17 years","18+ years"))
baseline$base_a1c_cat <- ifelse(baseline$hba1c<=7,"<= 7%",ifelse(baseline$hba1c<=9,">7% and <9%",">= 9%"))

# questions 
# 1) confirm we are using B, T1, T2
# 2) do we need to classify into visit windows?
# 3) date of consent for baseline visit date
# 4) i assume if someone only has a baseline visit, we exclude them - what about "never trained"
# 5) what to do about missing baseline a1c - just exclude from stratified analysis?
# 6) race and ethnicity as is?
# 7) demo table stratified by age or A1c?
# 8) prior insulin mode - 92% Tandem to control IQ so we can't stratify


```

```{r echo=FALSE,include=FALSE,cache=TRUE}
# table of demographics
demovars <- c("demographics_age","age_cat","hba1c","base_a1c_cat","demographics_sex.factor",
              "demographics_ethnicity.factor","demographics_race.factor","demographics_insurance.factor",
              "prior.insulin.mode")
t1 <- CreateTableOne(vars=demovars,data=baseline)
t1 <- print(t1,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,nonnorm=c("hba1c","demographics_age"))

```

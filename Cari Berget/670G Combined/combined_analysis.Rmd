---
title: "670G Combined Analysis  "
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Cari Berget/670G Combined")
library(arsenal)
library(skimr)
library(knitr)
library(tidyverse)
```

```{r data import and clean,echo=FALSE}
# Kaan's data
# Read in
adult_demographics <- read.csv("./Data_Cleaned/adult_demographics.csv",
                               na.strings = na_strings)
adult <- read.csv("./Data_Cleaned/670Excel.csv",na.strings = na_strings)
adult_new <- read.csv("./Data_Cleaned/670Excel.new55patients.csv",
                      na.strings = na_strings)
adult_pump <- read.csv("./Data_Cleaned/pdf_summary.csv",
                       na.strings = na_strings)
# Format
adult$last_name <- tolower(adult$Last.Name)
adult$first_name <- tolower(sapply(strsplit(adult$First.Name," "),"[[",1))
adult_new$last_name <- tolower(sapply(strsplit(adult_new$Name," "),tail,1))
adult_new$first_name <- tolower(sapply(strsplit(adult_new$Name," "),"[[",1))
adult_demographics$last_name <- tolower(adult_demographics$LastName)
adult_demographics$first_name <- tolower(adult_demographics$FirstName)
adult_demographics <- adult_demographics %>% 
  select(first_name,last_name,Gender,DOB,Age_Diagnosis)
# HbA1c data wide to long
adult <- adult %>% 
  pivot_longer(cols = Date.M1:HbA1C.M12,
               names_to = c(".value","timepoint"),
               names_sep = "\\.")
adult_new <- adult_new %>%
  pivot_longer(HbA1c.M1:HbA1c.M12,
               names_to = "timepoint",
               names_prefix = ".*\\.",
               values_to = "HbA1C")
# Combine
adult_pump <- left_join(adult_pump,
                        adult[,c("first_name","last_name","timepoint","HbA1C")],
                        by = c("first_name","last_name","timepoint"))
adult_pump <- left_join(adult_pump,
                        adult_new[,c("first_name","last_name","timepoint","HbA1C")],
                        by = c("first_name","last_name","timepoint", "timepoint"))
# Merge 
adult_pump$hba1c <- pmax(adult_pump$HbA1C.x,adult_pump$HbA1C.y,na.rm = T)
adult_pump$HbA1C.x <- NULL
adult_pump$HbA1C.y <- NULL
# Add demographic info
adult_pump <- left_join(adult_pump,adult_demographics,
                        by = c("first_name","last_name"))
# Cari's data
source("/Users/timvigers/GitHub/BDC-Code/Cari Berget/670G Combined/data_clean.r")
# Remove non-670G subjects and select columns
data <- data %>% filter(record_id <= 115) %>%
  select(record_id,gyl_timepoint.factor,time_am,time_mm,sensor_wear,sensor_mean,
         sensor_sd,amexits,amexit_hyper,amexit_hypo,amexit_manual,amexit_manual,
         demographics_sex.factor,demographics_dob,demographics_diabetesdx)
# Clean up
rm(list = c("adult","adult_new","adult_demographics"))
```

# Table 1: Descriptive Characteristics

```{r table 1,echo=FALSE,results='asis'}
# Get demographics
demographics <- data %>% filter(gyl_timepoint == 0)
# Table 1 
t1 <- tableby(~ demographics_age + demographics_t1d_duration + 
          demographics_ethnicity.factor + demographics_race.factor,
          data = demographics)
# Print
summary(t1)
```
---
title: "6 Month Analysis"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tableone)
library(lme4)
library(lattice)
library(knitr)
library(reshape2)
library(tidyr)
library(lubridate)
library(dplyr)
library(ggplot2)
source('~/Documents/GitHub/Tim-and-Laura/tim_R_functions.R')
pathstart <- os.check()
```

```{r echo=FALSE,warning=FALSE,eval=FALSE}
# Read in glycemic data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura Tim projects/Cari Berget/6 Month Manuscript/Data_Cleaned/670GChild_GlycemicDATA_2019-01-07_.csv")
glycemicdata <- read.csv(filename,na.strings = "",stringsAsFactors = F)
# Format dates
datecols <- c("demographics_consent","demographics_dob","demographics_diabetesdx","automode_start",
              "hba1c_date_b","hba1c_date_m1","t1_date_m1","hba1c_date_t1","t1_date","hba1c_date_t2",
              "t2_date")
glycemicdata[,datecols] <- lapply(glycemicdata[,datecols], function(x) mdy(x,tz = "MST"))
```

```{r echo=FALSE, eval=FALSE}
# Re-assign visit dates based on Cari's decisions. CSV file manually edited for easier import.
# Notes:
# 1. Cari is double checking #14 dates, others in CSV file are correct. 
# 2. Baseline A1c can be 2 weeks after AM start.
# 3. "Date Questions.csv" manually edited for easier R import.
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura Tim projects/Cari Berget/6 Month Manuscript/Data_Cleaned/Date Questions.csv")
correct.dates <- read.csv(filename,stringsAsFactors = F,na.strings = c("","none"))
correct.dates[,2:5] <- lapply(correct.dates[,2:5],function(x) mdy(x,tz = "MST"))
# Split into separate data frames, rename columns.
m1cols <- c(grep("m1_",colnames(glycemicdata)),grep("_m1",colnames(glycemicdata)))
original.m1 <- glycemicdata[,c(1,m1cols)]
colnames(original.m1) <- sub("_m1","",colnames(original.m1))
colnames(original.m1) <- sub("t1_","",colnames(original.m1))
# T1
t1cols <- c(grep("t1_",colnames(glycemicdata)),grep("_t1",colnames(glycemicdata)))
original.t1 <- glycemicdata[,c(1,t1cols)]
colnames(original.t1) <- sub("t1_","",colnames(original.t1))
colnames(original.t1) <- sub("_t1","",colnames(original.t1))
# T2
t2cols <- c(grep("t2_",colnames(glycemicdata)),grep("_t2",colnames(glycemicdata)))
original.t2 <- glycemicdata[,c(1,t2cols)]
colnames(original.t2) <- sub("t2_","",colnames(original.t2))
colnames(original.t2) <- sub("_t2","",colnames(original.t2))
# Define variables of interest
vars <- c("hba1c","am_time","mm_time","sensor_wear","sensor_u54","sensor_55_69",
          "sensor_70_180","sensor_181_250","sensor_g250","mean_sg","sd",
          "bg_checks","calibrations","tdd","basal","bolus","amexit",
          "amexit_day","amexit_hyper","amexit_hypo","amexit_manual","amexit_other")
# Combine, remove duplicates and melt
allcols <- c("record_id","date",vars)
alldat <- rbind(original.m1[,allcols],original.t1[,allcols],original.t2[,allcols])
alldat <- alldat[which(duplicated(alldat[,c("record_id","date")])==F),]
alldat <- melt(alldat,id.vars = c("record_id","date"))
# Spread
alldat <- spread(alldat,key = variable,value = value)
# Get corrected M1 data
m1 <- correct.dates[,c("record_id","correct.m1.date")]
colnames(m1) <- c("record_id","date")
m1 <- left_join(m1,alldat,by = c("record_id","date"))
m1$tpoint <- "M1"
# Get corrected T1 data
t1 <- correct.dates[,c("record_id","correct.t1.date")]
colnames(t1) <- c("record_id","date")
t1 <- left_join(t1,alldat,by = c("record_id","date"))
t1$tpoint <- "T1"
# Get corrected T2 data
t2 <- correct.dates[,c("record_id","correct.t2.date")]
colnames(t2) <- c("record_id","date")
t2 <- left_join(t2,alldat,by = c("record_id","date"))
t2$tpoint <- "T2"
# Merge M1, T1, and T2
alldat <- bind_rows(m1,t1,t2)
alldat <- alldat[order(alldat$record_id),]
# Add autmode start and calculate days
alldat <- merge(alldat,glycemicdata[,c("record_id","automode_start")])
alldat$days <- as.numeric(difftime(alldat$date, alldat$automode_start,units = "days"))
# Import baseline data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura Tim projects/Cari Berget/6 Month Manuscript/Data_Cleaned/670GChild_BaselineGlycemicData_14JAN2019.csv")
baseline <- read.csv(filename)
colnames(baseline) <- sub("_b","",colnames(baseline))
baseline$tpoint <- "B"
# Merge everything, sort
alldat <- bind_rows(alldat,baseline)
alldat <- alldat[order(alldat$record_id),]
# Make record ID and timepoint factor
alldat$record_id <- as.factor(alldat$record_id)
alldat$tpoint <- as.factor(alldat$tpoint)
# Get baseline A1c
alldat$hba1c[alldat$tpoint == "B"] <- glycemicdata$hba1c_baseline

# Notes

# List of manual data changes
# Renames columns:
# sensor_54_69_m1 to sensor_55_69_m1
# baseline data sensor_54_69 to sensor_55_69
# all "amexits" to "amexit"

# Additional data notes
# Using a strict 3 month +/- 45 days window would have resulted in the loss of quite a bit of data, so visit dates were manually re-classified by Cari Berget. 
# The cleaned data was sent to Cari Berget due to several concerning outliers. She corrected the data and sent it back, so this chunk of code no longer needs to run. The cleaned data from Cari is just imported instead.  
```

```{r echo=FALSE}
# Import Cari's cleaned data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Cari Berget/6 Month Manuscript/Data_Cleaned/clean_glycemic_data.csv")
alldata <- read.csv(filename,na.strings = "")
# Define variables of interest.
vars <- c("hba1c","am_time","mm_time","sensor_wear","sensor_u54","sensor_55_69",
          "sensor_70_180","sensor_181_250","sensor_g250","mean_sg","sd",
          "bg_checks","calibrations","tdd","basal","bolus","amexit",
          "amexit_day","amexit_hyper","amexit_hypo","amexit_manual","amexit_other")
```

```{r dpi=600}
# LMM
lmer(hba1c ~ tpoint + (1 | record_id),data = alldata,REML = F)
lmer(hba1c ~ days + (1 | record_id),data = alldata,REML = F)
# Lattice plots
xyplot(hba1c ~ tpoint + (1 | record_id),alldata)
xyplot(hba1c ~ days + (1 | record_id),alldata)
```

```{r echo=FALSE,warning=FALSE,eval=FALSE}
# Plots for checking data.
for (v in vars) {
  plot <- ggplot(data = alldata, aes_string(x = "tpoint", y = v, group = "record_id")) +
    geom_line(aes_string(color = "record_id")) + 
    scale_color_discrete(guide=FALSE)
  print(plot)
}
```

```{r echo=FALSE}
# Read in survey data
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Cari Berget/6 Month Manuscript/Data_Cleaned/670GChildSurvey_DATA_2019-01-07_.csv")
paid_child <- read.csv(filename,na.strings = "",stringsAsFactors = F)
# Column names for each survey
b_cols_paid <- paste0("c_paid",seq(1:20))
t1_cols_paid <- paste0(b_cols_paid,"_t1")
t2_cols_paid <- paste0(b_cols_paid,"_t2")
b_cols_maintain <- paste0("c_hfs_behave",c(3,4,7))
t1_cols_maintain <- paste0(b_cols_maintain,"_t1")
t2_cols_maintain <- paste0(b_cols_maintain,"_t2")
b_cols_helpless <- paste0("c_hfs_worry",c(11,12,13,14,16,18,19,22,23))
t1_cols_helpless <- paste0(b_cols_helpless,"_t1")
t2_cols_helpless <- paste0(b_cols_helpless,"_t2")
b_cols_worry <- paste0("c_hfs_worry",c(15,17,20,21,25))
t1_cols_worry <- paste0(b_cols_worry,"_t1")
t2_cols_worry <- paste0(b_cols_worry,"_t2")
# Score by timepoint
paid_child$B_paid <- apply(paid_child[,b_cols],1,function(x) mean((5 - (x - 1)),na.rm = T) * 25)
paid_child$T1_paid <- apply(paid_child[,t1_cols],1,function(x) mean((5 - (x - 1)),na.rm = T) * 25)
paid_child$T2_paid <- apply(paid_child[,t2_cols],1,function(x) mean((5 - (x - 1)),na.rm = T) * 25)

paid_child$B_maintain <- apply(paid_child[,b_cols_maintain],1,function(x) sum((x - 1)))
paid_child$T1_maintain <- apply(paid_child[,t1_cols_maintain],1,function(x) sum((x - 1)))
paid_child$T2_maintain <- apply(paid_child[,t2_cols_maintain],1,function(x) sum((x - 1)))

paid_child$B_helpless <- apply(paid_child[,b_cols_helpless],1,function(x) sum((x - 1)))
paid_child$T1_helpless <- apply(paid_child[,t1_cols_helpless],1,function(x) sum((x - 1)))
paid_child$T2_helpless <- apply(paid_child[,t2_cols_helpless],1,function(x) sum((x - 1)))

paid_child$B_worry <- apply(paid_child[,b_cols_worry],1,function(x) sum((x - 1)))
paid_child$T1_worry <- apply(paid_child[,t1_cols_worry],1,function(x) sum((x - 1)))
paid_child$T2_worry <- apply(paid_child[,t2_cols_worry],1,function(x) sum((x - 1)))
# Remove unnecessary columns, gather, order
paid_child <- paid_child[,c("record_id","B","T1","T2")]
paid_child <- gather_(paid_child,tpoint, score, B:T2)
paid_child <- paid_child[order(paid_child$record_id),]



# Same as above for YAs
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Cari Berget/6 Month Manuscript/Data_Cleaned/670GYoungAdult_SurveyDATA_2019-01-07_.csv")
survey <- read.csv(filename,na.strings = "",stringsAsFactors = F)
paid_ya <- select(survey,record_id,ya_paid1_base:ya_paid20_base,
                  ya_paid1_t1:ya_paid20_t1,ya_paid1_t2:ya_paid20_t2)

```
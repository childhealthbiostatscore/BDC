---
title: "HCL Overnight Analysis"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Erin Cobry/670g obs sleep")
library(arsenal)
library(skimr)
library(knitr)
library(lme4)
library(nlme)
library(MASS)
library(tidyverse)
```

```{r data import and clean,echo=FALSE}
# Read in (manually converted to long format from Erin's Excel spreadsheet)
overnight_alarms <- read.csv("./Data_Cleaned/Overnight Alarm Data.csv",
                             na.strings = c("","No Data"))
# Format
colnames(overnight_alarms) <- c("id","timepoint","dates","num_nights",
                                "num_alarms","num_alarms_in_AM","perc_time_in_AM")
# Split date column
overnight_alarms$dates <- as.character(overnight_alarms$dates)
overnight_alarms$start_date <- as.character(map(strsplit(overnight_alarms$dates," "),1))
overnight_alarms$end_date <- as.character(map(strsplit(overnight_alarms$dates," "),3))
overnight_alarms$end_date[overnight_alarms$end_date == "NULL"] <- NA
# Calculate number of nights 
overnight_alarms$nights <- 
  difftime(as.POSIXct(overnight_alarms$end_date,format = "%m-%d",tz = "UTC"),
           as.POSIXct(overnight_alarms$start_date,format = "%m-%d",tz = "UTC"),
           units = "days")
# Order timepoints
overnight_alarms$timepoint <- factor(overnight_alarms$timepoint,
                                     levels = c("Baseline","2 weeks",
                                                "T1","T2","T3","T4" ))
# Numeric timepoints for SAS
overnight_alarms$numeric_time <- 
  car::recode(overnight_alarms$timepoint,
              "'Baseline' = 0;'2 weeks' = 0.5;'T1' = 3;'T2' = 6;'T3' = 9;'T4' = 12")
write.csv(overnight_alarms,file = "/Users/timvigers/Desktop/alarms.csv",
          row.names = F,na = "")
```

# Longitudinal Analysis

## Histogram of Number of Alarms 

```{r echo=FALSE}
hist(overnight_alarms$num_alarms,main = "",xlab = "Number of Alarms")
# This looks very much like a Poisson distribution
```

## Plot

```{r echo=FALSE,warning=FALSE}
alarms_over_time <- 
  ggplot(overnight_alarms,aes(x = timepoint, y = num_alarms,group = id)) + 
  geom_line() + theme_bw()
alarms_over_time
```

## Model

```{r echo=FALSE}
# Random intercept
mod_ri <- glmmPQL(num_alarms ~ timepoint + perc_time_in_AM,random = ~1|id,
               data = overnight_alarms,family = "poisson",
               correlation = corCAR1())
# Not enough data for a random slope
```

# Questions

1. Where is the daytime alarm information? 
2. Did 39RS really have alarms in the 90s?
3. How to compare models fit with PQL?
---
title: "Functional Data Analysis"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: beamer_presentation
header-includes:
  \usepackage{bm}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)
library(patchwork)
library(splines)
library(gam)
library(knitr)
library(kableExtra)
library(visreg)
data(WarsawApts, package = "HRW")
data(Wage,package = "ISLR")
dat = read.csv("/Users/timvigers/Dropbox/Work/Presentations/BDC/for_jm_v3_kaci.csv")
```

## What Is Functional Data Analysis (FDA)?

- Most statistics use some sort of parametric model $p(x|\bm{\theta})$.
  - We try to estimate the parameters of *p*.
- Assume the data are normally distributed $N(\mu,\sigma^2)$.
  - Can use the sample mean $\bar{x}$ as an estimate of the location parameter $\mu$.
- Sometimes we do not want to assume a density function in advance.
  - Interested in estimating $p$ itself.
    - What is the smooth function that generates our data?

## Goals and Uses

- The goals of FDA are essentially the same as other areas of statistics:
  1. Represent data to aid in analysis and to highlight characteristics
  2. Study patterns and sources of variation
  3. Explain variation in an outcome using independent variables

- Common uses of FDA:
  - Growth data
  - Imaging data 
  - Wearable device data
  - Accelerometry (physical activity) 
  - Heart rate
  - **Continuous glucose monitoring** (CGM)

## Semi- and Non-Parametric Regression

- The basic linear model is: $y_i= \beta_0+\beta_1 x_i+\epsilon_i$ for $1\leq i \leq n$
- Each predictor has a simple form, and 
  - The overall shape is determined by the model rather than the data
    - e.g. a straight line in a linear model, one bend in a quadratic model, etc.
- The non-parametric version of this model is: $y_i = f(x_i)+\epsilon_i$

## Semi- and Non-Parametric Regression

- $f(x_i)$ is an arbitrary function.
  - The only constraint is that $f(x_i)$ must be a smooth function.
  - This model is much more flexible than parametric.
- A semi-parametric model essentially uses parametric models for some predictors, and non-parametric models for others.

## Penalized Splines

- A natural question at this point is: "What do you mean $f(x_i)$ is an arbitrary smooth function? Can you give us an example?"
- A penalized spline model is one relatively simple option for $f(x_i)$: $$f(x)=\beta_0+\beta_1 x + \sum_{k=1}^K{u_k(x-\kappa_k)_+}$$ 
  - $x_+\equiv max(x,0)$ and the $\kappa_ks$ are pre-set values that we choose.
- We are fitting multiple short lines that meet at our $\kappa_ks$ (often called "knots").

## Penalized Splines (for Stats Nerds)

- Estimation of the model coefficients is a fairly straightforward constrained optimization problem where we want to minimize $$\sum_{i=1}^n{(y_i - f(x_i))^2}\text{ with }\sum_{k=1}^K{u_k^2}\leq C$$

- This is equivalent to penalized least squares with smoothing parameter $\lambda\geq0$, where we want to minimize: $$\sum_{i=1}^n{(y_i - f(x_i))^2}+\lambda\sum_{k=1}^K{u_k^2}$$

## Linear Model

```{r}
ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_smooth(method='lm',formula=y~x,se=F,color="blue",size=1) +
  theme_bw() + ggtitle("Linear") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Quadratic Model

```{r}
ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_smooth(method='lm',formula=y~x+I(x^2),se=F,color="blue",size=1) +
  theme_bw() + ggtitle("Quadratic") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Cubic Model

```{r}
ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_smooth(method='lm',formula=y~x+I(x^2)+I(x^3),se=F,color="blue",size=1) +
  theme_bw() + ggtitle("Quadratic") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Spline Model

```{r}
fit = gam(areaPerMzloty~bs(construction.date,knots = quantile(WarsawApts$construction.date,seq(0,1,1/19))),data = WarsawApts)

ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_line(aes(y = predict(fit)),color="blue",size=1) +
  theme_bw() + ggtitle("Splines with 20 Knots") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Spline Model

```{r}
fit = gam(areaPerMzloty~bs(construction.date,knots = quantile(WarsawApts$construction.date,seq(0,1,1/4))),data = WarsawApts)

ggplot(WarsawApts,aes(x=construction.date,y=areaPerMzloty)) +
  geom_point(alpha=0.3) + 
  geom_line(aes(y = predict(fit)),color="blue",size=1) +
  theme_bw() + ggtitle("Splines with 5 Knots") +
  ylab("Area per Million Zloty") + xlab("Date")
```

## Generalized Additive Models (GAMs)

- GAMs are a non-parametric extension of generalized linear models.
- Generalized linear models relax some of the assumptions of a linear model.
- We replace $E(\bm{Y}|\bm{X})=\sum_1^p\beta_j X_j$ with the additive model $E(\bm{Y}|\bm{X})=\sum_1^p s_j(X_j)$
  - The conditional mean of the response is modeled using the sum of smooth functions of the predictors. 
  
## Generalized Additive Models (GAMs)

- We can think of splines are an extension of simple linear regression (1 predictor) and GAMs as an extension of multiple linear regression.
- For the wage dataset we can adjust the model for year and education: $wage = \beta_0+f_1(year)+f_2(age)+f_3(education)+\epsilon$

## Application to Survival Analysis

- If we fit a GAM with no smoothed parameters, we obtain essentially the same results as the Cox PH model:

```{r}
# Race and age as factors
dat$age_group = cut(dat$age,breaks = c(-Inf,30,50,Inf),labels = c("Young","Middle","Old"),
                    right = F)
dat$race_ethnicity = factor(dat$Ethnic_group,labels = c("Caucasian","African American",
                                                        "Hispanic","Other"))
# Mean TAC to compare results to Kristen
dat = dat %>% group_by(idn) %>% mutate(mean_TAC = mean(TAC,na.rm=T))
# Fit
surv_gam = mgcv::gam(tac_months~hlamis+race_ethnicity+age_group+mean_TAC,
           family=mgcv::cox.ph(),data=dat,weights=dsa_yn)
# Format results
res = broom::tidy(surv_gam,parametric = T,conf.int = T)
res = res[,c("term","estimate")]
res$estimate = exp(res$estimate)
# Add KC's results
kc_res = read.csv("/Users/timvigers/Dropbox/Work/Presentations/BDC/cox model results_kc.csv")
res = cbind(res,kc_res$Odds.Ratio)
colnames(res) = c("Term","GAM","Cox")
# Print
kable(res,digits = 3)
```

## Application to Survival Analysis (Continued)

```{r}
par(mfrow=c(2, 2))
visreg(surv_gam)
```

## Smooth Function of TAC

\tiny

```{r}
# FDA
fda_gam = mgcv::gam(tac_months~hlamis+race_ethnicity+age_group+s(TAC),
           family=mgcv::cox.ph(),data=dat,weights=dsa_yn)
summary(fda_gam)
```

## Smooth Function of TAC (Continued)

```{r}
par(mfrow=c(2, 2))
visreg(fda_gam)
```

## Interpreting our GAM

- *Note*: This model was fit using the default settings in the `gam` package.
- The parameters that are not smoothed functions are interpreted the same way as a Cox regression.
- There appears to be reduced hazard for TAC in the 5 - 10 range.
  - This matches the therapeutic range recommended in other papers.


## References

1. Ramsay, J. O., and B. W. Silverman. Functional Data Analysis. 2nd ed. Springer Series in Statistics. New York: Springer, 2005.

2. Harezlak J, Ruppert D, Wand MP. Semiparametric Regression with R. 1st ed. 2018. Springer New York: Imprint: Springer; 2018. doi:10.1007/978-1-4939-8853-2

3. James G, Witten D, Hastie T, Tibshirani R, eds. An Introduction to Statistical Learning: With Applications in R. Springer; 2013.

4. Wood SN. Generalized Additive Models: An Introduction with R. Second edition. CRC Press/Taylor & Francis Group; 2017.
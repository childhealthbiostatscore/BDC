---
title: "NOVO Transition"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,dpi = 600)
knitr::opts_knit$set(root.dir = "Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/NOVO Transition")
library(arsenal)
library(skimr)
library(knitr)
library(cgmanalysis)
library(tidyverse)
library(XML)
library(Hmisc)
library(emmeans)
```

```{r import}
# Import
source("C:/Users/tim/Documents/GitHub/BDC-Code/Viral Shah/Transition/NOVOTransitionStudy_R_2020-10-29_1804.R")
```

```{r cgm,eval=FALSE}
# List patient folders
l = list.files("./Data_Raw/Patient data")
l_full = list.files("./Data_Raw/Patient data",full.names = T)
l = l_full[!is.na(suppressWarnings(as.numeric(l)))]
# Find randomization files in patient folders
f = lapply(l, function(f){
  files = list.files(f,full.names = T)
  w = which(grepl("random",tolower(files)))
  files[w]
})
f = unlist(f)
# Import randomization files and write as csv to clean data folder
outdir = "./Data_cleaned/Randomization/"
dir.create(outdir,showWarnings = FALSE)
lapply(f, function(file){
  ext = tools::file_ext(file)
  if(ext == "xml"){
    doc <- xmlParse(file)
    l <- xmlToList(doc)
    id = as.numeric(strsplit(file,"/")[[1]][4])
    l <- l[["GlucoseReadings"]]
    times <- lapply(l, function(x) {x[["DisplayTime"]]})
    times <- do.call(rbind,times)
    sensor <- lapply(l, function(x) {x[["Value"]]})
    sensor <- do.call(rbind,sensor)
    table <- as.data.frame(cbind(times,sensor))
    colnames(table) <- c("timestamp","sensorglucose")
    table$subjectid <- NA
    table$subjectid[1] <- id
    table <- table[,c("subjectid","timestamp","sensorglucose")]
    table$timestamp = lubridate::ymd_hms(table$timestamp)
    write.csv(table,file = paste0(outdir,id,"_randomization.csv"),
              row.names = F,na="")
  }
})
# CGM variables
cgmvariables(outdir,"./Data_Cleaned","cgm_randomization",printname = T)
```

```{r data clean}
# Subject id from record id (record_id = 1 dropped out)
data$subject_id = data$record_id + 1
# Import CGM data
cgm = read.csv("./Data_Cleaned/cgm_randomization.csv")
# Import insulin data
insulin = read.csv("./Data_Cleaned/insulin.csv",na.strings = "")
insulin$subject_id = as.numeric(sapply(strsplit(insulin$Id,"-"),"[[",2))
# Add to REDCap data
data = full_join(data,insulin,by = "subject_id")
data = full_join(data,cgm,by = "subject_id")
# Check if they have CGM data
data$cgm_randomization = factor(!is.na(data$date_cgm_placement),
                                labels = c("No","Yes"))
# Surveys
# IDSS score: mean of items 1-14 (reverse code items: 1, 3-4, 7-13)
reverse = c("idss_complicated","idss_embarrassing","idss_hassle_to_use",
            "idss_expensive","idss_spontaneous","idss_many_pieces",
            "idss_benefit","idss_inconvinient","idss_time",
            "idss_hassle_to_carry")
reverse_v2 = paste0(reverse,"_randomization_v2")
data[,reverse_v2] = lapply(data[,reverse_v2], function(x){6-x})
all_idss = c(reverse,"idss_good_control","idss_control",
             "idss_works_well","idss_future")
all_idss_v2 = paste0(all_idss,"_randomization_v2")
data$idss_randomization_v2 = 
  apply(data,1,function(r){mean(as.numeric(r[all_idss_v2]))})
# Percent overall work impairment due to problem: Q2/(Q2+Q4)+[(1-(Q2/(Q2+Q4)))x(Q5/10)]
```

# Table 1: Descriptive Characteristics

```{r results='asis',warning=FALSE}
# Table 1
t1_vars = c("age","gender.factor","bmi","gold_score.factor",
            "diabetes_duration","a1c","insulin_pump.factor",
            "V1.Basal.dose","V1.Bolus.dose","education.factor",
            "insurance_private.factor","insurance_medicaid.factor",
            "insurance_medicare.factor","insurance_medical.factor",
            "insurance_no_answer.factor","household_income.factor",
            "diab_conditions___1.factor","diab_conditions___2.factor",
            "diab_conditions___3.factor","diab_conditions___4.factor",
            "diab_conditions___5.factor","cgm_randomization")
t1_form = as.formula(paste0("randomization_group.factor~",
                            paste0(t1_vars,collapse = "+")))
table_1 = 
  tableby(t1_form,data = 
            droplevels(data[!is.na(data$randomization_group.factor),]))
# Print
summary(table_1,labelTranslations = 
          list(age="Age",gender.factor="Gender",
               gold_score.factor = "Gold Score",
               insulin_pump.factor = "Insulin Pump",
               V1.Basal.dose = "Basal Dose",V1.Bolus.dose="Bolus Dose",
               education.factor = "Education",
               insurance_medicaid.factor = "Medicaid",
               insurance_medical.factor="No Medical Insurance",
               insurance_medicare.factor="Medicare",
               insurance_medicaid.factor="Medicaid",
               insurance_private.factor="Private",
               insurance_no_answer.factor="No Answer",
               household_income.factor="Household Income",
               diab_conditions___1.factor="Diabetic Retinopathy",
               diab_conditions___2.factor="Diabetic Neuropathy",
               diab_conditions___3.factor="Diabetic Nephropathy",
               diab_conditions___4.factor="High Cholesterol",
               diab_conditions___5.factor="High Blood Pressure",
               cgm_randomization = "CGM Data at Randomization"))
```

# Figure 1: Percent time spent > 180 mg/dL

```{r fig 1,warning=FALSE}
ggplot(data[!is.na(data$randomization_group.factor),],
       aes(x=randomization_group.factor,y=percent_time_over_180))+
  geom_boxplot() + 
  theme_bw() + xlab("") + ylab("% Time Above 180 mg/dL")
```

# Table 2: Differences between treatment group adjusted for BMI and Medicaid status

Means and standard errors (SE) are averaged over the levels of Medicaid status and reported for the average BMI in each treatment group. All outcomes were compared using linear regression except for the number of correction boluses, which was modeled using Poisson regression.

```{r table 2}
data$no_of_corrections = 
  suppressWarnings(
    as.numeric(
      data$No.of.correction.boluses.in.first.72.hours.of.randomization))
vars = list("% TIR"="percent_time_70_180",
            "% Time < 70 mg/dL"="percent_time_under_70",
            "% Time < 54 mg/dL"="percent_time_under_54",
            "Number of correction boluses in first 72 hours"=
              "no_of_corrections","IDSS"="idss_randomization_v2")
group = "randomization_group.factor"
table_2 = lapply(vars,function(var){
  form = 
    as.formula(paste0(var,"~",group,"+bmi+insurance_medicaid.factor"))
  mod = lm(form,data = data)
  if(grepl("no",var)){
    mod = glm(form,data = data,family = "poisson")
  }
  res = as.data.frame(summary(mod)$coefficients)
  p = res[2,4]
  means = as.data.frame(emmeans(mod,as.formula(paste0("~",group))))
  return(c(means[1,2],means[1,3],means[2,2],means[2,3],p))
})
table_2 = as.data.frame(do.call(rbind,table_2))
rownames(table_2) = names(vars)
kable(table_2,col.names = c("SOC Mean","SOC SE","OLP Mean","OLP SE","p"),
      digits = 3)
```

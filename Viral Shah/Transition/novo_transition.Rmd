---
title: "NOVO Transition"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,dpi = 600)
knitr::opts_knit$set(root.dir = "Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/NOVO Transition")
library(arsenal)
library(skimr)
library(knitr)
library(cgmanalysis)
library(tidyverse)
library(XML)
library(Hmisc)
```

```{r import}
# Import
source("C:/Users/tim/Documents/GitHub/BDC-Code/Viral Shah/Transition/NOVOTransitionStudy_R_2020-10-29_1804.R")
```

```{r cgm,eval=FALSE}
# List patient folders
l = list.files("./Data_Raw/Patient data")
l_full = list.files("./Data_Raw/Patient data",full.names = T)
l = l_full[!is.na(suppressWarnings(as.numeric(l)))]
# Find randomization files in patient folders
f = lapply(l, function(f){
  files = list.files(f,full.names = T)
  w = which(grepl("random",tolower(files)))
  files[w]
})
f = unlist(f)
# Import randomization files and write as csv to clean data folder
outdir = "./Data_cleaned/Randomization/"
dir.create(outdir,showWarnings = FALSE)
lapply(f, function(file){
  ext = tools::file_ext(file)
  if(ext == "xml"){
    doc <- xmlParse(file)
    l <- xmlToList(doc)
    id = as.numeric(strsplit(file,"/")[[1]][4])
    l <- l[["GlucoseReadings"]]
    times <- lapply(l, function(x) {x[["DisplayTime"]]})
    times <- do.call(rbind,times)
    sensor <- lapply(l, function(x) {x[["Value"]]})
    sensor <- do.call(rbind,sensor)
    table <- as.data.frame(cbind(times,sensor))
    colnames(table) <- c("timestamp","sensorglucose")
    table$subjectid <- NA
    table$subjectid[1] <- id
    table <- table[,c("subjectid","timestamp","sensorglucose")]
    table$timestamp = lubridate::ymd_hms(table$timestamp)
    write.csv(table,file = paste0(outdir,id,"_randomization.csv"),
              row.names = F,na="")
  }
})
# CGM variables
cgmvariables(outdir,"./Data_Cleaned","cgm_randomization",printname = T)
```

# Table 1: Descriptive Characteristics

```{r results='asis',warning=FALSE}
# Subject id from record id (record_id = 1 dropped out)
data$subject_id = data$record_id + 1
# Import CGM data
cgm = read.csv("./Data_Cleaned/cgm_randomization.csv")
# Import insulin data
insulin = read.csv("./Data_Cleaned/insulin.csv",na.strings = "")
insulin$subject_id = as.numeric(sapply(strsplit(insulin$Id,"-"),"[[",2))
# Add to REDCap data
data = full_join(data,insulin,by = "subject_id")
# Table 1
t1_vars = c("age","gender.factor","bmi","gold_score.factor",
            "diabetes_duration","a1c","insulin_pump.factor",
            "V1.Basal.dose","V1.Bolus.dose","education.factor",
            "insurance_private.factor","insurance_medicaid.factor",
            "insurance_medicare.factor","insurance_medical.factor",
            "insurance_no_answer.factor","household_income.factor",
            "diab_conditions___1.factor","diab_conditions___2.factor",
            "diab_conditions___3.factor","diab_conditions___4.factor",
            "diab_conditions___5.factor")
t1_form = as.formula(paste0("randomization_group.factor~",
                            paste0(t1_vars,collapse = "+")))
table_1 = 
  tableby(t1_form,data = 
            droplevels(data[!is.na(data$randomization_group.factor),]))
# Print
summary(table_1,labelTranslations = 
          list(age="Age",gender.factor="Gender",
               gold_score.factor = "Gold Score",
               insulin_pump.factor = "Insulin Pump",
               V1.Basal.dose = "Basal Dose",V1.Bolus.dose="Bolus Dose",
               education.factor = "Education",
               insurance_medicaid.factor = "Medicaid",
               insurance_medical.factor="No Medical Insurance",
               insurance_medicare.factor="Medicare",
               insurance_medicaid.factor="Medicaid",
               insurance_private.factor="Private",
               insurance_no_answer.factor="No Answer",
               household_income.factor="Household Income",
               diab_conditions___1.factor="Diabetic Retinopathy",
               diab_conditions___2.factor="Diabetic Neuropathy",
               diab_conditions___3.factor="Diabetic Nephropathy",
               diab_conditions___4.factor="High Cholesterol",
               diab_conditions___5.factor="High Blood Pressure"))
```

---
title: "Insulin Bone Marker Manuscript"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tableone)
library(knitr)
library(tidyverse)
library(reshape2)
library(gridExtra)
source("/Users/timvigers/Documents/GitHub/Tim-and-Laura/tim_R_functions.R")
```

```{r echo=FALSE,warning=FALSE}
# Read in dataset (approved by Viral and Vanessa)
full_data <- read.csv("/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Manuscript/Data_Cleaned/full_data.csv")
# Calculate albumin-corrected calcium
full_data$CA_Corrected.0 <- 0.8*(4.5 - full_data$ALBS.0) + full_data$CA.0
# Correct osteocalcin units
full_data$Osteocalcin.0 <- full_data$Osteocalcin.0 / 1000
full_data$Osteocalcin.120 <- full_data$Osteocalcin.120 / 1000
```

```{r echo=FALSE,include=FALSE}
# Table 1
vars = c("AgeAtVisit0","Gender","Ethnicity","Race","T1DDuration","BMI",
         "UnitsInsPerKg","HbA1c","InsDeliveryMethod","CurrUseCGM","Vitamin.D.0",
         "CA.0","ALBS.0","CA_Corrected.0","eGFR.0","CREA.S.0","ALP.0")
nonnormal <- norm.check(full_data,c("AgeAtVisit0","T1DDuration","BMI",
                                    "UnitsInsPerKg","HbA1c","Vitamin.D.0",
                                    "CA.0","ALBS.0","CA_Corrected.0","eGFR.0",
                                    "CREA.S.0","ALP.0"))
t1a <- CreateTableOne(vars,data = full_data)
t1a <- print(t1a, nonnormal = nonnormal, exact = c("Ethnicity","Race","CurrUseCGM"),
            printToggle = F)
t1b <- CreateTableOne(vars,strata = "group",data = full_data)
t1b <- print(t1b, nonnormal = nonnormal, exact = c("Ethnicity","Race","CurrUseCGM"),
            printToggle = F)
t1c <- CreateTableOne(vars = vars[-c(which(vars == "Gender"))],strata = "Gender",data = full_data)
t1c <- print(t1c, nonnormal = nonnormal, exact = c("Ethnicity","Race"),
            printToggle = F)
```

### Table 1a: Descriptive Statistics for Full Cohort

```{r echo=FALSE}
kable(t1a)
```

### Table 1b: Descriptive Statistics by C-Peptide Group

```{r echo=FALSE}
kable(t1b[,1:5])
```

### Table 1c: Descriptive Statistics by Gender

```{r echo=FALSE}
kable(t1c[,1:3])
```

### Figure 1: Change in BTM and related hormones

```{r echo=FALSE}
baseline_btm <- c("P1NP.0","CTX1.0","Osteocalcin.0","ON.0","OPG.0","IGF.0")
min_120_btm <- c("P1NP.120","CTX1.120","Osteocalcin.120","ON.120","OPG.120","IGF.120")
# Calculate percent change for BTMs and insulin
full_data$perc_change_P1NP <- ((full_data$P1NP.120 - full_data$P1NP.0)/full_data$P1NP.0)*100
full_data$perc_change_CTX1 <- ((full_data$CTX1.120 - full_data$CTX1.0)/full_data$CTX1.0)*100
full_data$perc_change_Osteocalcin <- ((full_data$Osteocalcin.120 - full_data$Osteocalcin.0)/full_data$Osteocalcin.0)*100
full_data$perc_change_ON <- ((full_data$ON.120 - full_data$ON.0)/full_data$ON.0)*100
full_data$perc_change_OPG <- ((full_data$OPG.120 - full_data$OPG.0)/full_data$OPG.0)*100
full_data$perc_change_IGF <- ((full_data$IGF.120 - full_data$IGF.0)/full_data$IGF.0)*100
full_data$perc_change_Insulin <- ((full_data$Insulin.120 - full_data$Insulin.0)/full_data$Insulin.0)*100
# Mke plotting dataframe
perc_change_data <- full_data %>%
  select(PtID,group,Gender,perc_change_P1NP:perc_change_Insulin)
perc_change_data <- melt(perc_change_data,id.vars = c("PtID","group","Gender","perc_change_Insulin"))
perc_change_data$variable <- gsub("perc_change_","",perc_change_data$variable)
# Full cohort plot
perc_change_plot_all <- ggplot(perc_change_data,aes(x=value,y=perc_change_Insulin)) + 
  geom_point()+
  facet_wrap(~variable,nrow = 1) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.y = element_blank(),
        axis.title.x = element_blank())
# By gender
perc_change_plot_gender <- ggplot(perc_change_data,aes(x=value,y=perc_change_Insulin)) + 
  geom_point(aes(shape=Gender))+
  facet_wrap(~variable,nrow = 1) +
  ylab("% Change in Insulin") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.x = element_blank())
# By group
perc_change_plot_group <- ggplot(perc_change_data,aes(x=value,y=perc_change_Insulin)) + 
  geom_point(aes(shape=group))+
  facet_wrap(~variable,nrow = 1) +
  xlab("% Change in BTM") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90),
        axis.title.y = element_blank()) +
  labs(shape = "C-Peptide Group")
```

```{r echo=FALSE,warning=FALSE,fig.width=8,fig.height=10,dpi=1200}
grid.arrange(perc_change_plot_all,perc_change_plot_gender,perc_change_plot_group, nrow = 3)
```

### Table 2: Comparison of Baseline BTMs by C-Peptide Group

```{r echo=FALSE}
t2 <- CreateTableOne(vars = baseline_btm,strata="group",data=full_data)
nonnormal <- norm.check(full_data,baseline_btm)
t2 <- print(t2,nonnormal = nonnormal,printToggle = F)
kable(t2[,1:5])
```

### Table 3: Comparison of % Change in BTMs by C-Peptide Group

```{r echo=FALSE}
percvars <- c("perc_change_P1NP","perc_change_CTX1","perc_change_Osteocalcin",
              "perc_change_ON","perc_change_OPG","perc_change_IGF")
t3 <- CreateTableOne(vars = percvars,strata="group",data=full_data)
nonnormal <- norm.check(full_data,percvars)
t3 <- print(t3,nonnormal = nonnormal,printToggle = F)
kable(t3[,1:5])
```

```{r echo=FALSE}

```
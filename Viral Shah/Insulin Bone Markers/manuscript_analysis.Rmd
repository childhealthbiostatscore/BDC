---
title: "Insulin Bone Marker Manuscript"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tableone)
library(knitr)
library(tidyverse)
library(gridExtra)
source("/Users/timvigers/Documents/GitHub/Tim-and-Laura/tim_R_functions.R")
```

```{r echo=FALSE,warning=FALSE}
# Read in dataset (approved by Viral and Vanessa)
full_data <- read.csv("/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Manuscript/Data_Cleaned/full_data.csv")
# Calculate albumin-corrected calcium
full_data$CA_Corrected.0 <- 0.8*(4.5 - full_data$ALBS.0) + full_data$CA.0
```

```{r echo=FALSE,include=FALSE}
# Table 1
vars = c("AgeAtVisit0","Gender","Ethnicity","Race","T1DDuration","BMI",
         "UnitsInsPerKg","HbA1c","InsDeliveryMethod","CurrUseCGM","Vitamin.D.0",
         "CA.0","ALBS.0","CA_Corrected.0","eGFR.0","CREA.S.0","ALP.0")
nonnormal <- norm.check(full_data,c("AgeAtVisit0","T1DDuration","BMI",
                                    "UnitsInsPerKg","HbA1c","Vitamin.D.0",
                                    "CA.0","ALBS.0","CA_Corrected.0","eGFR.0",
                                    "CREA.S.0","ALP.0"))
t1a <- CreateTableOne(vars,data = full_data)
t1a <- print(t1a, nonnormal = nonnormal, exact = c("Ethnicity","Race","CurrUseCGM"),
            printToggle = F)
t1b <- CreateTableOne(vars,strata = "group",data = full_data)
t1b <- print(t1b, nonnormal = nonnormal, exact = c("Ethnicity","Race","CurrUseCGM"),
            printToggle = F)
t1c <- CreateTableOne(vars = vars[-c(which(vars == "Gender"))],strata = "Gender",data = full_data)
t1c <- print(t1c, nonnormal = nonnormal, exact = c("Ethnicity","Race"),
            printToggle = F)
```

### Table 1a: Descriptive Statistics for Full Cohort

```{r echo=FALSE}
kable(t1a)
```

### Table 1b: Descriptive Statistics by C-Peptide Group

```{r echo=FALSE}
kable(t1b[,1:5])
```

### Table 1c: Descriptive Statistics by Gender

```{r echo=FALSE}
kable(t1c[,1:3])
```

### Figure 1: Change in BTM and related hormones

```{r echo=FALSE}
baseline_btm <- c("P1NP.0","CTX1.0","Osteocalcin.0","ON.0","OPG.0","IGF.0")
min_120_btm <- c("P1NP.120","CTX1.120","Osteocalcin.120","ON.120","OPG.120","IGF.120")
# Calculate percent change for BTMs and insulin
full_data$perc_change_P1NP <- ((full_data$P1NP.120 - full_data$P1NP.0)/full_data$P1NP.0)*100
full_data$perc_change_CTX1 <- ((full_data$CTX1.120 - full_data$CTX1.0)/full_data$CTX1.0)*100
full_data$perc_change_Osteocalcin <- ((full_data$Osteocalcin.120 - full_data$Osteocalcin.0)/full_data$Osteocalcin.0)*100
full_data$perc_change_ON <- ((full_data$ON.120 - full_data$ON.0)/full_data$ON.0)*100
full_data$perc_change_OPG <- ((full_data$OPG.120 - full_data$OPG.0)/full_data$OPG.0)*100
full_data$perc_change_IGF <- ((full_data$IGF.120 - full_data$IGF.0)/full_data$IGF.0)*100
full_data$perc_change_Insulin <- ((full_data$Insulin.120 - full_data$Insulin.0)/full_data$Insulin.0)*100
# Full cohort plots
p1np_plot <- ggplot(full_data,aes(x=perc_change_P1NP,y=perc_change_Insulin)) + 
  geom_point() + 
  xlab("P1NP") +
  theme_bw() + 
  theme(axis.title.y = element_blank())
ctx1_plot <- ggplot(full_data,aes(x=perc_change_CTX1,y=perc_change_Insulin)) + 
  geom_point() + 
  xlab("CTX1") +
  theme_bw() + 
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank())
osteo_plot <- ggplot(full_data,aes(x=perc_change_Osteocalcin,y=perc_change_Insulin)) + 
  geom_point() + 
  xlab("Osteocalcin") +
  theme_bw() + 
  theme(axis.title.y = element_blank())
on_plot <- ggplot(full_data,aes(x=perc_change_ON,y=perc_change_Insulin)) + 
  geom_point() + 
  xlab("ON") +
  theme_bw() + 
  theme(axis.title.y = element_blank())
opg_plot <- ggplot(full_data,aes(x=perc_change_OPG,y=perc_change_Insulin)) + 
  geom_point() + 
  xlab("OPG") +
  theme_bw() + 
  theme(axis.title.y = element_blank())
igf_plot <- ggplot(full_data,aes(x=perc_change_IGF,y=perc_change_Insulin)) + 
  geom_point() + 
  xlab("IGF") +
  theme_bw() + 
  theme(axis.title.y = element_blank())
```

```{r echo=FALSE,warning=FALSE,fig.width=8}
grid.arrange(p1np_plot,ctx1_plot,osteo_plot,on_plot,opg_plot,igf_plot,nrow=1,
             left = "% Change in Insulin",bottom = "% Change in BTM")
```
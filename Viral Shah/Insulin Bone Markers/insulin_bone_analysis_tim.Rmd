---
title: "Insulin Bone Markers"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tableone)
library(nortest)
library(knitr)
library(psych)
library(sas7bdat)
library(reshape2)
library(tidyverse)
# Check OS and alter file path accordingly.
if (.Platform$OS.type == "windows") {pathstart <- "//ucdenver.pvt/"} else if (.Platform$OS.type == "unix"){pathstart <- "/Volumes/"}
source("/Users/timvigers/Documents/GitHub/Tim-and-Laura/tim_R_functions.R")
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
# Read in data 
phys <- read.sas7bdat(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Data_Raw/Second_Analysis/kphysexamrechealth_subset.sas7bdat"))
sample <- read.sas7bdat(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Data_Raw/Second_Analysis/ksampleresults_subset.sas7bdat"))
screen <- read.sas7bdat(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Data_Raw/Second_Analysis/kvisit0screening_subset.sas7bdat"))
visit <- read.sas7bdat(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Data_Raw/Second_Analysis/kvisitinfo_subset.sas7bdat"))
bone <- read.csv(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Data_Cleaned/bone_injury.csv"),skip = 1)
bone$TimePoint <- sapply(strsplit(as.character(bone$Row.Labels)," "),`[`,2)
bone$Row.Labels <- sub(" 0","",bone$Row.Labels)
bone$Row.Labels <- sub(" 120","",bone$Row.Labels)
colnames(bone) <- c("PtID","ALP","ON","OPG","OPN","Osteocalcin","SOST","Grand.Total","TimePoint")
# Long to wide
bone <- reshape(bone[-c(which(bone$PtID == "Grand Total")),c("PtID","ALP","ON","OPG","OPN","Osteocalcin","SOST","TimePoint")],
              idvar = "PtID",timevar = "TimePoint",direction = "wide",sep = "_")
previous <- read.csv(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Data_Cleaned/full_data_bone_turnover.csv"))
age <- read.csv(paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Viral Shah/Insulin bone marker/Data_Cleaned/age at consent.csv"))
# Combine
alldata <- dcast(sample[,c("PtID","TimePoint","Analyte","Value_Update_n")],PtID ~ Analyte + TimePoint,value.var = "Value_Update_n")
alldata <- left_join(alldata,phys[,c("PtID","Weight_kg","Height_cm")])
alldata <- 
  left_join(alldata,screen[,c("PtID","Gender","Ethnicity","Race","DiagT1DAge","HbA1c","CurrUseCGM","InsDeliveryMethod","UnitsInsTotal")])
alldata <- left_join(alldata,bone)
alldata <- left_join(alldata,previous[,c("PtID","IGF0","CTX0","P1NP0","VitD0","IGF120","CTX120","P1NP120","VitD120",
                                           "calcium","po4")])
alldata <- left_join(alldata,age)
# New variables
alldata$Height_cm <- as.numeric(as.character(alldata$Height_cm))
alldata$HbA1c <- as.numeric(as.character(alldata$HbA1c))
alldata$UnitsInsPerKg <- alldata$UnitsInsTotal/alldata$Weight_kg
alldata$BMI <- alldata$Weight_kg / ((alldata$Height_cm / 100)^2)
alldata$T1DDuration <- alldata$AgeAtConsent - alldata$DiagT1DAge
```


################################################################################


```{r echo=FALSE,include=FALSE}
contvars <- c("AgeAtConsent","T1DDuration","UnitsInsPerKg","HbA1c","BMI","INS_TOSOH_0",
              "calcium","po4","CPEP_0")
nonnormvars <- norm.check(alldata,contvars)
catvars <- c("Gender","InsDeliveryMethod","CurrUseCGM")
t1vars <- c(catvars,contvars)
t1a <- CreateTableOne(t1vars,data = alldata)
t1a <- as.data.frame(print(t1a,nonnormal = nonnormvars,exact = catvars))
# Need c-peptide groups
# t1b <- CreateTableOne(t1vars,strata = "cpep_group",data = alldata)
# t1b <- as.data.frame(print(t1b,nonnormal = nonnormvars,exact = catvars))
```

```{r echo=FALSE}
kable(t1a, caption = "Descriptive statistics of full cohort at baseline")
```

```{r echo=FALSE}
# kable(t1b, caption = "Descriptive statistics by c-peptide concentration at baseline. There was only one 'medium' c-peptide participant, so they were included in the high c-peptide group.")
```

# Correlations

```{r echo=FALSE,include=FALSE}
# Correlation matrix at time 0
corrvars0 <- c("INS_TOSOH_0","P1NP0","CTX0","Osteocalcin_0","IGF0","CPEP_0","ON_0","SOST_0","calcium","po4")
corrall <- alldata[,corrvars0]
corrlow <- alldata[alldata$cpep_group == "low",corrvars0]
corrhigh <- alldata[alldata$cpep_group == "high",corrvars0]
corrneg <- alldata[alldata$cpep_group == "negative",corrvars0]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvars0)-1),]
rownames(allcorrs) <- corrvars0[2:length(corrvars0)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvars0)-1),]
rownames(lowcorrs) <- corrvars0[2:length(corrvars0)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvars0)-1),]
rownames(highcorrs) <- corrvars0[2:length(corrvars0)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvars0)-1),]
rownames(negcorrs) <- corrvars0[2:length(corrvars0)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "Baseline insulin correlated with bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "Baseline insulin correlated with bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],caption = "Baseline insulin correlated with bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],caption = "Baseline insulin correlated with bone markers, negative c-peptide group")
```

```{r echo=FALSE,include=FALSE}
# Correlation matrix at time 120
corrvars120 <- c("INS_TOSOH_120","P1NP120","CTX120","Osteocalcin_120","IGF120","CPEP_120","ON_120","SOST_120")
corrall <- alldata[,corrvars120]
corrlow <- alldata[alldata$cpep_group == "low",corrvars120]
corrhigh <- alldata[alldata$cpep_group == "high",corrvars120]
corrneg <- alldata[alldata$cpep_group == "negative",corrvars120]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvars120)-1),]
rownames(allcorrs) <- corrvars120[2:length(corrvars120)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvars120)-1),]
rownames(lowcorrs) <- corrvars120[2:length(corrvars120)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvars120)-1),]
rownames(highcorrs) <- corrvars120[2:length(corrvars120)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvars120)-1),]
rownames(negcorrs) <- corrvars120[2:length(corrvars120)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "120 min insulin correlated with bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "120 min insulin correlated with bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],caption = "120 min insulin correlated with bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],caption = "120 min insulin correlated with bone markers, negative c-peptide group")
```

```{r echo=FALSE,include=FALSE}
# Correlation matrix percent change
corrvarsperc <- c("ins_perc_change","P1NP_perc_change","CTX_perc_change",
              "osteocalcin_perc_change","IGF_perc_change","cpep_perc_change",
              "ON._perc_change","SOST._perc_change")
corrall <- alldata[,corrvarsperc]
corrlow <- alldata[alldata$cpep_group == "low",corrvarsperc]
corrhigh <- alldata[alldata$cpep_group == "high",corrvarsperc]
corrneg <- alldata[alldata$cpep_group == "negative",corrvarsperc]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvarsperc)-1),]
rownames(allcorrs) <- corrvarsperc[2:length(corrvarsperc)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvarsperc)-1),]
rownames(lowcorrs) <- corrvarsperc[2:length(corrvarsperc)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvarsperc)-1),]
rownames(highcorrs) <- corrvarsperc[2:length(corrvarsperc)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvarsperc)-1),]
rownames(negcorrs) <- corrvarsperc[2:length(corrvarsperc)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "Percent change in insulin correlated with bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "Percent change in insulin correlated with bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],
      caption = "Percent change in insulin correlated with bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],
      caption = "Percent change in insulin correlated with bone markers, negative c-peptide group")
```

```{r echo=FALSE,include=FALSE}
# 120 minute GIR correlations
corrvarsgir120 <- c("gir120","P1NP120","CTX120","osteocalcin120","IGF120","cpep120","ON.120","SOST.120")
corrall <- alldata[,corrvarsgir120]
corrlow <- alldata[alldata$cpep_group == "low",corrvarsgir120]
corrhigh <- alldata[alldata$cpep_group == "high",corrvarsgir120]
corrneg <- alldata[alldata$cpep_group == "negative",corrvarsgir120]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvarsgir120)-1),]
rownames(allcorrs) <- corrvarsgir120[2:length(corrvarsgir120)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvarsgir120)-1),]
rownames(lowcorrs) <- corrvarsgir120[2:length(corrvarsgir120)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvarsgir120)-1),]
rownames(highcorrs) <- corrvarsgir120[2:length(corrvarsgir120)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvarsgir120)-1),]
rownames(negcorrs) <- corrvarsgir120[2:length(corrvarsgir120)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "Minute 120 GIR correlated with bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "Minute 120 GIR correlated with bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],caption = "Minute 120 GIR correlated with bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],caption = "Minute 120 GIR correlated with bone markers, negative c-peptide group")
```

```{r echo=FALSE,include=FALSE}
# GIR by percent change in bone markers
corrvarsgirauc <- c("girAUC","P1NP_perc_change","CTX_perc_change",
              "osteocalcin_perc_change","IGF_perc_change","cpep_perc_change",
              "ON._perc_change","SOST._perc_change")
corrall <- alldata[,corrvarsgirauc]
corrlow <- alldata[alldata$cpep_group == "low",corrvarsgirauc]
corrhigh <- alldata[alldata$cpep_group == "high",corrvarsgirauc]
corrneg <- alldata[alldata$cpep_group == "negative",corrvarsgirauc]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvarsgirauc)-1),]
rownames(allcorrs) <- corrvarsgirauc[2:length(corrvarsgirauc)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvarsgirauc)-1),]
rownames(lowcorrs) <- corrvarsgirauc[2:length(corrvarsgirauc)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvarsgirauc)-1),]
rownames(highcorrs) <- corrvarsgirauc[2:length(corrvarsgirauc)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvarsgirauc)-1),]
rownames(negcorrs) <- corrvarsgirauc[2:length(corrvarsgirauc)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "GIR-AUC correlated with percent change in bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "GIR-AUC correlated with percent change in bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],caption = "GIR-AUC correlated with percent change in bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],caption = "GIR-AUC correlated with percent change in bone markers, negative c-peptide group")
```

```{r echo=FALSE,dpi=600}
# New data frame for plotting
plot(alldata$cpep_group,alldata$INS_TOSOH_0,
     main = "Baseline Insulin Concentration by C-Peptide Group",
     ylab = "Insulin units")
plot(alldata$cpep_group,alldata$ins120,
     main = "120 Minute Insulin Concentration by C-Peptide Group",
     ylab = "Insulin units")
plot(alldata$cpep_group,alldata$ins_diff,
     main = "Percent Change in Insulin Concentration by C-Peptide Group",
     ylab = "Percent Change in Insulin")
```

```{r echo=FALSE}
# New data frame for spaghetti plots of bone markers.
plotvars0 <- c("PtID","cpep_group",corrvars0)
plotvars0 <- 
  plotvars0[-c(which(plotvars0 == "calcium"|plotvars0 == "po4"|plotvars0 == "INS_TOSOH_0"))]
df1 <- alldata[,plotvars0]
colnames(df1) <- sub("0","",colnames(df1))
colnames(df1) <- sub("\\.","",colnames(df1))
df1$Timepoint <- 0
plotvars120 <- c("PtID","cpep_group",corrvars120[-c(which(corrvars120 == "ins120"))])
df2 <- alldata[,plotvars120]
colnames(df2) <- sub("120","",colnames(df2))
colnames(df2) <- sub("\\.","",colnames(df2))
df2$Timepoint <- 120
plot <- rbind(df1,df2)
plot$Timepoint <- as.factor(plot$Timepoint)
```

# Plots of bone marker change 0 minute to 120 minute, by c-peptide group.

```{r echo=FALSE, dpi=600, warning=FALSE}
for (c in colnames(plot)[3:(ncol(plot)-1)]) {
  markerplot <- 
    ggplot(data = plot,aes_string(x = "Timepoint", y = c, group = "PtID")) +
    geom_point() + 
    geom_line() + 
    scale_color_discrete(guide=FALSE) +
    facet_grid(. ~ cpep_group)
  print(markerplot)
}
```

# Linear models of percent change in bone markers and percent change in insulin, adjusted for c-peptide group 

### P1NP
```{r echo=FALSE,results='asis'}
p1np <- lm(P1NP_perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(p1np)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(p1np)$adj.r.squared,4)))
```

### CTX
```{r echo=FALSE,results='asis'}
ctx <- lm(CTX_perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(ctx)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(ctx)$adj.r.squared,4)))
```

### Osteocalcin
```{r echo=FALSE,results='asis'}
ost <- lm(osteocalcin_perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(ost)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(ost)$adj.r.squared,4)))
```

### IGF
```{r echo=FALSE,results='asis'}
igf <- lm(IGF_perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(igf)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(igf)$adj.r.squared,4)))
```

### ON
```{r echo=FALSE,results='asis'}
on <- lm(ON._perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(on)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(on)$adj.r.squared,4)))
```

### SOST
```{r echo=FALSE,results='asis'}
sost <- lm(SOST._perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(sost)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(sost)$adj.r.squared,4)))
```

# Linear models of percent change in bone markers and percent change in insulin, adjusted for baseline c-peptide concentration

### P1NP
```{r echo=FALSE,results='asis'}
p1np <- lm(P1NP_perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(p1np)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(p1np)$adj.r.squared,4)))
```

### CTX
```{r echo=FALSE,results='asis'}
ctx <- lm(CTX_perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(ctx)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(ctx)$adj.r.squared,4)))
```

### Osteocalcin
```{r echo=FALSE,results='asis'}
ost <- lm(osteocalcin_perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(ost)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(ost)$adj.r.squared,4)))
```

### IGF
```{r echo=FALSE,results='asis'}
igf <- lm(IGF_perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(igf)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(igf)$adj.r.squared,4)))
```

### ON
```{r echo=FALSE,results='asis'}
on <- lm(ON._perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(on)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(on)$adj.r.squared,4)))
```

### SOST
```{r echo=FALSE,results='asis'}
sost <- lm(SOST._perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(sost)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(sost)$adj.r.squared,4)))
```
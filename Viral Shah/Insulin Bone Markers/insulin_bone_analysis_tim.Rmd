---
title: "Insulin Bone Markers"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  word_document:
    fig_width: 6
    fig_height: 3.5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, include=FALSE}
# Load libraries and functions
library(tableone)
library(knitr)
library(ggplot2)
library(psych)
source('~/Documents/GitHub/Tim-and-Laura/tim_R_functions.R')
pathstart <- os.check()
```

```{r echo=FALSE}
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura Tim projects/Viral Shah/Insulin bone marker/Data_Cleaned/Bet cell study_Visit3Clamp.csv")
clamp <- read.csv(filename,na.strings = "NULL")
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura Tim projects/Viral Shah/Insulin bone marker/Data_Cleaned/updated_full_data_bone_turnover.csv")
alldata <- read.csv(filename,na.strings = "NULL")
# Weight and basal insulin per kilo
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura Tim projects/Viral Shah/Insulin bone marker/Data_Cleaned/KPhysExamRecHealth.csv")
phys <- read.csv(filename)
phys <- phys[which(phys$Visit == "Visit 0"),]
phys <- phys[,c("PtID","Weight")]
alldata <- merge(alldata,phys)
alldata$insulin_kilo <- alldata$UnitsInsTotal / alldata$Weight
# ON and SOST data formatting
filename <- paste0(pathstart,"som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura Tim projects/Viral Shah/Insulin bone marker/Data_Cleaned/bone_injury.csv")
boneinj <- read.csv(filename,skip = 1)
boneinj <- boneinj[-c(which(boneinj$Row.Labels == "Grand Total")),]
boneinj$timepoint <- as.numeric(sub(".* ","",boneinj$Row.Labels))
boneinj$Row.Labels <- sub(" .*","",boneinj$Row.Labels)
boneinj <- reshape(boneinj,idvar = "Row.Labels",timevar = "timepoint",direction = "wide")
colnames(boneinj)[colnames(boneinj) == "Row.Labels"] <- "PtID"
# Change medium cpep to high
levels(alldata$cpep_group) <- c("high","low","high","negative")
# GIR AUC
isoremvars <- c("Tmpoint0D20IsoRem","Tmpoint30D20IsoRem","Tmpoint60D20IsoRem",
             "Tmpoint90D20IsoRem","Tmpoint105D20IsoRem","Tmpoint120D20IsoRem")
girvars <- c("gir0","gir30","gir60","gir90","gir105","gir120")
clamp[,girvars] <- 1000 - clamp[,isoremvars]
alldata <- merge(alldata,clamp[,c("PtID",girvars)])
aucnonmissing <- which(rowSums(!is.na(alldata[,girvars])) >= 2)
times <- c(0,30,60,90,105,120)
alldata$girAUC <- NA
alldata$girAUC[aucnonmissing] <- apply(alldata[aucnonmissing,girvars],1,
                                       function(x) MESS::auc(times,x))
alldata$gir_diff <- alldata$gir120 - alldata$gir0
# Add ON and SOST data and differences
alldata <- merge(alldata,boneinj[,c("PtID","ON.0","ON.120","SOST.0","SOST.120")])
alldata$ON_diff <- alldata$ON.120 - alldata$ON.0
alldata$SOST_diff <- alldata$SOST.120 - alldata$SOST.0
# Percent changes
diffvars <- colnames(alldata)[grep("diff",colnames(alldata))]
diffvars <- diffvars[-c(which(diffvars == "OPN_diff" | diffvars == "OPG_diff"))]
basevars <- c("ins0","P1NP0","CTX0","osteocalcin0","glucagon0","IGF0","VitD0",
              "cpep0","ON.0","SOST.0","gir0")
percvars <- sub("0","_perc_change",basevars)
alldata[,percvars] <- (alldata[,diffvars] / alldata[,basevars]) * 100
```

```{r echo=FALSE,include=FALSE}
contvars <- c("AgeAtConsent","t1dduration","insulin_kilo","hba1c","bmi","ins0",
              "calcium","po4","cpep0","girAUC")
nonnormvars <- norm.check(alldata,contvars)
catvars <- c("Gender","InsDeliveryMethod","CurrUseCGM")
t1vars <- c(catvars,contvars)
t1a <- CreateTableOne(t1vars,data = alldata)
t1a <- as.data.frame(print(t1a,nonnormal = nonnormvars,exact = catvars))
t1b <- CreateTableOne(t1vars,strata = "cpep_group",data = alldata)
t1b <- as.data.frame(print(t1b,nonnormal = nonnormvars,exact = catvars))
```

```{r echo=FALSE}
kable(t1a, caption = "Descriptive statistics of full cohort at baseline")
```

```{r echo=FALSE}
kable(t1b, caption = "Descriptive statistics by c-peptide concentration at baseline. There was only one 'medium' c-peptide participant, so they were included in the high c-peptide group.")
```

# Correlations

```{r echo=FALSE,include=FALSE}
# Correlation matrix at time 0
corrvars0 <- c("ins0","P1NP0","CTX0","osteocalcin0","IGF0","cpep0","ON.0","SOST.0","calcium","po4")
corrall <- alldata[,corrvars0]
corrlow <- alldata[alldata$cpep_group == "low",corrvars0]
corrhigh <- alldata[alldata$cpep_group == "high",corrvars0]
corrneg <- alldata[alldata$cpep_group == "negative",corrvars0]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvars0)-1),]
rownames(allcorrs) <- corrvars0[2:length(corrvars0)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvars0)-1),]
rownames(lowcorrs) <- corrvars0[2:length(corrvars0)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvars0)-1),]
rownames(highcorrs) <- corrvars0[2:length(corrvars0)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvars0)-1),]
rownames(negcorrs) <- corrvars0[2:length(corrvars0)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "Baseline insulin correlated with bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "Baseline insulin correlated with bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],caption = "Baseline insulin correlated with bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],caption = "Baseline insulin correlated with bone markers, negative c-peptide group")
```

```{r echo=FALSE,include=FALSE}
# Correlation matrix at time 120
corrvars120 <- c("ins120","P1NP120","CTX120","osteocalcin120","IGF120","cpep120","ON.120","SOST.120")
corrall <- alldata[,corrvars120]
corrlow <- alldata[alldata$cpep_group == "low",corrvars120]
corrhigh <- alldata[alldata$cpep_group == "high",corrvars120]
corrneg <- alldata[alldata$cpep_group == "negative",corrvars120]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvars120)-1),]
rownames(allcorrs) <- corrvars120[2:length(corrvars120)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvars120)-1),]
rownames(lowcorrs) <- corrvars120[2:length(corrvars120)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvars120)-1),]
rownames(highcorrs) <- corrvars120[2:length(corrvars120)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvars120)-1),]
rownames(negcorrs) <- corrvars120[2:length(corrvars120)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "120 min insulin correlated with bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "120 min insulin correlated with bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],caption = "120 min insulin correlated with bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],caption = "120 min insulin correlated with bone markers, negative c-peptide group")
```

```{r echo=FALSE,include=FALSE}
# Correlation matrix percent change
corrvarsperc <- c("ins_perc_change","P1NP_perc_change","CTX_perc_change",
              "osteocalcin_perc_change","IGF_perc_change","cpep_perc_change",
              "ON._perc_change","SOST._perc_change")
corrall <- alldata[,corrvarsperc]
corrlow <- alldata[alldata$cpep_group == "low",corrvarsperc]
corrhigh <- alldata[alldata$cpep_group == "high",corrvarsperc]
corrneg <- alldata[alldata$cpep_group == "negative",corrvarsperc]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvarsperc)-1),]
rownames(allcorrs) <- corrvarsperc[2:length(corrvarsperc)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvarsperc)-1),]
rownames(lowcorrs) <- corrvarsperc[2:length(corrvarsperc)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvarsperc)-1),]
rownames(highcorrs) <- corrvarsperc[2:length(corrvarsperc)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvarsperc)-1),]
rownames(negcorrs) <- corrvarsperc[2:length(corrvarsperc)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "Percent change in insulin correlated with bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "Percent change in insulin correlated with bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],
      caption = "Percent change in insulin correlated with bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],
      caption = "Percent change in insulin correlated with bone markers, negative c-peptide group")
```

```{r echo=FALSE,include=FALSE}
# 120 minute GIR correlations
corrvarsgir120 <- c("gir120","P1NP120","CTX120","osteocalcin120","IGF120","cpep120","ON.120","SOST.120")
corrall <- alldata[,corrvarsgir120]
corrlow <- alldata[alldata$cpep_group == "low",corrvarsgir120]
corrhigh <- alldata[alldata$cpep_group == "high",corrvarsgir120]
corrneg <- alldata[alldata$cpep_group == "negative",corrvarsgir120]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvarsgir120)-1),]
rownames(allcorrs) <- corrvarsgir120[2:length(corrvarsgir120)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvarsgir120)-1),]
rownames(lowcorrs) <- corrvarsgir120[2:length(corrvarsgir120)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvarsgir120)-1),]
rownames(highcorrs) <- corrvarsgir120[2:length(corrvarsgir120)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvarsgir120)-1),]
rownames(negcorrs) <- corrvarsgir120[2:length(corrvarsgir120)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "Minute 120 GIR correlated with bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "Minute 120 GIR correlated with bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],caption = "Minute 120 GIR correlated with bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],caption = "Minute 120 GIR correlated with bone markers, negative c-peptide group")
```

```{r echo=FALSE,include=FALSE}
# GIR by percent change in bone markers
corrvarsgirauc <- c("girAUC","P1NP_perc_change","CTX_perc_change",
              "osteocalcin_perc_change","IGF_perc_change","cpep_perc_change",
              "ON._perc_change","SOST._perc_change")
corrall <- alldata[,corrvarsgirauc]
corrlow <- alldata[alldata$cpep_group == "low",corrvarsgirauc]
corrhigh <- alldata[alldata$cpep_group == "high",corrvarsgirauc]
corrneg <- alldata[alldata$cpep_group == "negative",corrvarsgirauc]
allcorrs <- corr.test(corrall)
allcorrs <- data.frame(print(allcorrs,short = F))[1:(length(corrvarsgirauc)-1),]
rownames(allcorrs) <- corrvarsgirauc[2:length(corrvarsgirauc)]
colnames(allcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
lowcorrs <- corr.test(corrlow)
lowcorrs <- data.frame(print(lowcorrs,short = F))[1:(length(corrvarsgirauc)-1),]
rownames(lowcorrs) <- corrvarsgirauc[2:length(corrvarsgirauc)]
colnames(lowcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
highcorrs <- corr.test(corrhigh)
highcorrs <- data.frame(print(highcorrs,short = F))[1:(length(corrvarsgirauc)-1),]
rownames(highcorrs) <- corrvarsgirauc[2:length(corrvarsgirauc)]
colnames(highcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
negcorrs <- corr.test(corrneg)
negcorrs <- data.frame(print(negcorrs,short = F))[1:(length(corrvarsgirauc)-1),]
rownames(negcorrs) <- corrvarsgirauc[2:length(corrvarsgirauc)]
colnames(negcorrs) <- c("raw.l","R","raw.u","P-Value","lower.adj","upper.adj")
```

```{r echo=FALSE}
kable(allcorrs[,c(2,4)],caption = "GIR-AUC correlated with percent change in bone markers, full cohort")
kable(lowcorrs[,c(2,4)],caption = "GIR-AUC correlated with percent change in bone markers, low c-peptide group")
kable(highcorrs[,c(2,4)],caption = "GIR-AUC correlated with percent change in bone markers, high c-peptide group")
kable(negcorrs[,c(2,4)],caption = "GIR-AUC correlated with percent change in bone markers, negative c-peptide group")
```

```{r echo=FALSE,dpi=600}
# New data frame for plotting
plot(alldata$cpep_group,alldata$ins0,
     main = "Baseline Insulin Concentration by C-Peptide Group",
     ylab = "Insulin units")

plot(alldata$cpep_group,alldata$ins120,
     main = "120 Minute Insulin Concentration by C-Peptide Group",
     ylab = "Insulin units")

plot(alldata$cpep_group,alldata$ins_diff,
     main = "Percent Change in Insulin Concentration by C-Peptide Group",
     ylab = "Percent Change in Insulin")
```

```{r echo=FALSE}
# New data frame for spaghetti plots of bone markers.
plotvars0 <- c("PtID","cpep_group",corrvars0)
plotvars0 <- 
  plotvars0[-c(which(plotvars0 == "calcium"|plotvars0 == "po4"|plotvars0 == "ins0"))]
df1 <- alldata[,plotvars0]
colnames(df1) <- sub("0","",colnames(df1))
colnames(df1) <- sub("\\.","",colnames(df1))
df1$Timepoint <- 0

plotvars120 <- c("PtID","cpep_group",corrvars120[-c(which(corrvars120 == "ins120"))])
df2 <- alldata[,plotvars120]
colnames(df2) <- sub("120","",colnames(df2))
colnames(df2) <- sub("\\.","",colnames(df2))
df2$Timepoint <- 120

plot <- rbind(df1,df2)
plot$Timepoint <- as.factor(plot$Timepoint)
```

# Plots of bone marker change 0 minute to 120 minute, by c-peptide group.

```{r echo=FALSE, dpi=600, warning=FALSE}
for (c in colnames(plot)[3:(ncol(plot)-1)]) {
  markerplot <- 
    ggplot(data = plot,aes_string(x = "Timepoint", y = c, group = "PtID")) +
    geom_point() + 
    geom_line() + 
    scale_color_discrete(guide=FALSE) +
    facet_grid(. ~ cpep_group)
  print(markerplot)
}
```

# Linear models of percent change in bone markers and percent change in insulin, adjusted for c-peptide group 

### P1NP
```{r echo=FALSE,results='asis'}
p1np <- lm(P1NP_perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(p1np)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(p1np)$adj.r.squared,4)))
```

### CTX
```{r echo=FALSE,results='asis'}
ctx <- lm(CTX_perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(ctx)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(ctx)$adj.r.squared,4)))
```

### Osteocalcin
```{r echo=FALSE,results='asis'}
ost <- lm(osteocalcin_perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(ost)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(ost)$adj.r.squared,4)))
```

### IGF
```{r echo=FALSE,results='asis'}
igf <- lm(IGF_perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(igf)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(igf)$adj.r.squared,4)))
```

### ON
```{r echo=FALSE,results='asis'}
on <- lm(ON._perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(on)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(on)$adj.r.squared,4)))
```

### SOST
```{r echo=FALSE,results='asis'}
sost <- lm(SOST._perc_change ~ ins_perc_change + cpep_group, data = alldata)
kable(round(summary(sost)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(sost)$adj.r.squared,4)))
```

# Linear models of percent change in bone markers and percent change in insulin, adjusted for baseline c-peptide concentration

### P1NP
```{r echo=FALSE,results='asis'}
p1np <- lm(P1NP_perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(p1np)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(p1np)$adj.r.squared,4)))
```

### CTX
```{r echo=FALSE,results='asis'}
ctx <- lm(CTX_perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(ctx)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(ctx)$adj.r.squared,4)))
```

### Osteocalcin
```{r echo=FALSE,results='asis'}
ost <- lm(osteocalcin_perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(ost)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(ost)$adj.r.squared,4)))
```

### IGF
```{r echo=FALSE,results='asis'}
igf <- lm(IGF_perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(igf)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(igf)$adj.r.squared,4)))
```

### ON
```{r echo=FALSE,results='asis'}
on <- lm(ON._perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(on)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(on)$adj.r.squared,4)))
```

### SOST
```{r echo=FALSE,results='asis'}
sost <- lm(SOST._perc_change ~ ins_perc_change + cpep0, data = alldata)
kable(round(summary(sost)$coefficients,3))
cat(paste("Adjusted R Squared:",round(summary(sost)$adj.r.squared,4)))
```
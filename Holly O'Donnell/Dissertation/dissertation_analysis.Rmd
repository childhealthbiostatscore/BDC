---
title: "Holly's Dissertation"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tableone)
library(car)
library(skimr)
library(knitr)
library(tidyverse)
library(lme4)
library(nlme)
library(glmmLasso)
```

```{r echo=FALSE,include=FALSE}
# Import data
dat <- read.csv("/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Holly O'Donnell/Dissertation/Data_Raw/data_7.7.19.csv",na.strings = "")
# format and fill down dates and income level
dat$DateofBirth <- lubridate::mdy(dat$DateofBirth)
dat$DiagnosisDate <- lubridate::mdy(dat$DiagnosisDate)
dat$PumpStartDate <- lubridate::mdy(dat$PumpStartDate)
dat$VisitDate <- lubridate::mdy(dat$VisitDate)
dat <- dat %>% group_by(ID) %>% fill(DateofBirth,IncomeLevel,DiagnosisDate,
                                     PumpStartDate,Insurance,Sex) 
# Calculate age, T1D duration, and pump duration at each visit
dat$age_days <- difftime(dat$VisitDate,dat$DateofBirth,units = "days")
dat$age_years <- as.numeric(dat$age_days / 365.25)
dat$T1D_dur_days <- difftime(dat$VisitDate,dat$DiagnosisDate,units = "days")
dat$T1D_dur_years <- as.numeric(dat$T1D_dur_days / 365.25)
dat$pump_dur_days <- difftime(dat$VisitDate,dat$PumpStartDate,units = "days")
dat$pump_dur_yrs <- as.numeric(dat$pump_dur_days / 365.25)
# Add site field
dat$Site <- ifelse(as.numeric(dat$ID) < 300,"Florida","Colorado")
# Make study visit and treatment categorical
dat$StudyVisit <- as.factor(dat$StudyVisit)
dat$Treatment <- as.factor(dat$Treatment)
# Days from baseline, baseline levels of outcome
dat <- dat %>% group_by(ID) %>% 
  mutate(Days_since_baseline = 
           as.numeric(difftime(VisitDate,VisitDate[1],units = "days")),
         readings_per_day_b = readings_per_day[1],
         highBG_without_carb_with_bolus_b = highBG_without_carb_with_bolus[1],
         carb_inputs_per_day_b = carb_inputs_per_day[1],
         boluses_per_day_b = boluses_per_day[1])
```

# Model Selection (BG checks per day)

## Which time variable produces a better model fit?

```{r}
cat_time_mod <- lmer(readings_per_day ~ StudyVisit + (1|ID), data = dat)
cont_time_mod <- lmer(readings_per_day ~ Days_since_baseline + (1|ID), 
                      data = dat)
```

```{r echo=FALSE}
kable(AIC(cat_time_mod,cont_time_mod))
```

The model with visit number is a better fit than one using days from baseline (AIC is lower), so we'll use visit number for the rest of the models. 

## Check the full model

```{r echo=FALSE,include=FALSE}
#LME4 model to check convergence
full_mod_l <- lmer(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit + 
                     Sex + age_years + T1D_dur_years + Treatment*IncomeLevel +
                     Treatment*Insurance + readings_per_day_b + (1|Site/ID), 
                   data = dat)

full_mod_no_interact <- lme(readings_per_day ~ Treatment + HbA1c + StudyVisit + 
                              Sex + age_years + T1D_dur_years + IncomeLevel + 
                              Insurance + readings_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)
```

```{r}
full_mod <- lme(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit + 
                  Sex + age_years + T1D_dur_years + Treatment*IncomeLevel + 
                  Treatment*Insurance + readings_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)
```

### Check variance inflation factor

```{r echo=FALSE}
vif <- as.data.frame(vif(full_mod_no_interact))
kable(vif)
```

In general, VIF > 10 is a concern so it looks like we don't need to worry about multicollinearity here.

## Reduced model

Check the reduced model with only significant covariates from the full model. 

```{r}
reduced_mod <- lme(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit + 
                     age_years + readings_per_day_b,
                   random =~1|Site/ID, data = dat,na.action = na.omit) 
```

### Compare AIC

```{r warning=FALSE}
kable(AIC(full_mod,reduced_mod))
```

This indicates that the full model is actually a better fit. Now compare to models with single covariates added back in. 

## Semi-reduced models

```{r echo=FALSE,include=FALSE}
no_t1d_dur_mod <- lmer(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit
                       + Sex + age_years + Treatment*IncomeLevel + 
                         Treatment*Insurance + readings_per_day_b + (1|Site/ID), 
                    data = dat,na.action = na.omit)
no_income_mod <- lmer(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit + Sex + 
                     age_years + T1D_dur_years + Treatment*Insurance + 
                       readings_per_day_b + (1|Site/ID), 
                   data = dat,na.action = na.omit)
no_sex_mod <- lmer(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit + 
                     age_years + T1D_dur_years + Treatment*IncomeLevel +
                     Treatment*Insurance + readings_per_day_b + (1|Site/ID), 
                   data = dat,na.action = na.omit)
no_insurance_mod <- lmer(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit + Sex + 
                     age_years + T1D_dur_years + Treatment*IncomeLevel + 
                       readings_per_day_b + (1|Site/ID), data = dat,na.action = na.omit)
no_t1d_no_insur_mod <- lmer(readings_per_day ~ Treatment*HbA1c + 
                              Treatment*StudyVisit + Sex + age_years + 
                              IncomeLevel + readings_per_day_b+ (1|Site/ID), 
                            data = dat,na.action = na.omit)
no_t1d_no_income_mod <- lmer(readings_per_day ~ Treatment*HbA1c + 
                              Treatment*StudyVisit + Sex + age_years + 
                              Treatment*Insurance + readings_per_day_b+ (1|Site/ID), 
                            data = dat,na.action = na.omit)
AIC(no_t1d_no_insur_mod,no_t1d_no_income_mod)
```

```{r}
no_t1d_dur_mod <- lme(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit
                      + Sex + age_years + Treatment*IncomeLevel + 
                        Treatment*Insurance + readings_per_day_b,
                   random =~1|Site/ID, data = dat,na.action = na.omit)

no_sex_mod <- lme(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit + 
                     age_years + T1D_dur_years + Treatment*IncomeLevel +
                     Treatment*Insurance + readings_per_day_b,
                  random =~1|Site/ID, data = dat,na.action = na.omit)

no_income_mod <- lme(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit 
                     + Sex + age_years + T1D_dur_years + Treatment*Insurance + 
                       readings_per_day_b,
                  random =~1|Site/ID, data = dat,na.action = na.omit)

no_insurance_mod <- lme(readings_per_day ~ Treatment*HbA1c + 
                          Treatment*StudyVisit + Sex + age_years + T1D_dur_years
                        + Treatment*IncomeLevel + readings_per_day_b,
                  random =~1|Site/ID, data = dat,na.action = na.omit)

no_t1d_no_insur_mod <- lme(readings_per_day ~ Treatment*HbA1c + 
                              Treatment*StudyVisit + Sex + age_years + 
                              IncomeLevel + readings_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)

no_t1d_no_income_mod <- lme(readings_per_day ~ Treatment*HbA1c + 
                              Treatment*StudyVisit + Sex + age_years + 
                              Insurance + readings_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)

no_t1d_no_income_no_ins_mod <- lme(readings_per_day ~ Treatment*HbA1c + 
                              Treatment*StudyVisit + Sex + age_years + 
                                readings_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)
```

### Compare AIC

```{r echo=FALSE,warning=FALSE}
kable(AIC(full_mod,no_t1d_dur_mod,no_sex_mod,no_insurance_mod,no_income_mod,no_t1d_no_insur_mod,no_t1d_no_income_mod,reduced_mod,no_t1d_no_income_no_ins_mod))
```

The model without T1D duration or insurance is the best by AIC, but we need insurance in the model because the groups were different at baseline. So, we'll stick with the model without T1D duration, but including both insurance and income: 

```{r echo=FALSE}
kable(summary(no_t1d_dur_mod)$tTable)
```

## Without interaction terms

Since the HbA1c, insurance, and income interaction terms are not significant, let's check and see if the model improves without them:

```{r}
bg_mod_trt_visit <- lme(readings_per_day ~ HbA1c + Treatment*StudyVisit + Sex + 
                     age_years + IncomeLevel + Insurance + readings_per_day_b,
                   random =~1|Site/ID, data = dat,na.action = na.omit)

bg_mod_a1c <- lme(readings_per_day ~ Treatment*HbA1c + Treatment*StudyVisit + 
                    Sex + age_years + IncomeLevel + Insurance + 
                    readings_per_day_b,
                   random =~1|Site/ID, data = dat,na.action = na.omit)

bg_mod_inc <- lme(readings_per_day ~ HbA1c + Treatment*StudyVisit + Sex + 
                     age_years + Treatment*IncomeLevel + Insurance + 
                    readings_per_day_b,
                   random =~1|Site/ID, data = dat,na.action = na.omit)

bg_mod_ins <- lme(readings_per_day ~ HbA1c + Treatment*StudyVisit + Sex + 
                     age_years + IncomeLevel + Treatment*Insurance + 
                    readings_per_day_b,
                   random =~1|Site/ID, data = dat,na.action = na.omit)
```

### Compare AIC

```{r echo=FALSE,warning=FALSE}
kable(AIC(bg_mod_trt_visit,bg_mod_a1c,bg_mod_inc,bg_mod_ins))
```

The model with only the treatment by visit interaction is the best and is the interaction effect that we care most about. So, our final model for BG checks per day is:

```{r}
bg_mod <- lme(readings_per_day ~ Treatment*StudyVisit + HbA1c + Sex + 
                age_years + IncomeLevel + Insurance + readings_per_day_b,
              random =~1|Site/ID, data = dat,na.action = na.omit)
```

### Plot the residuals

```{r echo=FALSE,dpi=600}
plot(bg_mod,main="BG Readings per Day")
```

These are pretty nice looking residuals! Not exactly normal but I don't think they violate any assumptions, so I think this model is good to go.

### Results

```{r echo=FALSE}
kable(anova(bg_mod),caption = "Overall Effects")
kable(summary(bg_mod)$tTable,caption = "Fixed Effects")
```

So, the overall effects of treatment, HbA1c, sex, and age were significant. There was also a significant interaction between treatment and study visit. Let's go over the interpretation for these numbers in more detail over Zoom.

# Check similar models for another outcome (% high boluses without carb)

## Compare full model to reduced models

```{r}
bolus_mod_full <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + 
                        Treatment*StudyVisit + Sex + age_years + T1D_dur_years + 
                        Treatment*IncomeLevel + Treatment*Insurance + 
                        highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)

bolus_mod_no_t1d <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + 
                          Treatment*StudyVisit + Sex + age_years + 
                          Treatment*IncomeLevel + Treatment*Insurance + 
                          highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)

bolus_mod_reduced <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + 
                           Sex + Treatment*StudyVisit + age_years + 
                           highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
```

```{r echo=FALSE,warning=FALSE}
kable(AIC(bolus_mod_full,bolus_mod_no_t1d,bolus_mod_reduced))
```

Again, the model without T1D duration is the best, but let's check the models without insurance and income as well. 

```{r echo=FALSE,warning=FALSE}
bolus_mod_no_ins <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + 
                          Treatment*StudyVisit + Sex + age_years + 
                          T1D_dur_years + Treatment*IncomeLevel + 
                        highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
bolus_mod_no_inc <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + Treatment*StudyVisit + Sex + 
                        age_years + T1D_dur_years + 
                        Treatment*Insurance + highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
bolus_mod_neither <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + Treatment*StudyVisit + Sex + 
                        age_years + T1D_dur_years + highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
kable(AIC(bolus_mod_no_ins,bolus_mod_no_inc,bolus_mod_neither))
```

Unfortunately, the model without insurance is the best again, but we need to keep it in there (mostly so reviewers don't ask why you didn't control for it). Let's check the models with and without interaction terms as well, just to be sure:

```{r echo=FALSE,warning=FALSE}
bolus_mod_trt_visit <- lme(highBG_without_carb_with_bolus ~ Treatment*StudyVisit + HbA1c + Sex +
                                      age_years + IncomeLevel + Insurance + highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
bolus_mod_a1c <- lme(highBG_without_carb_with_bolus ~ Treatment*StudyVisit + Treatment*HbA1c + Sex +
                                      age_years + IncomeLevel + Insurance + highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
bolus_mod_inc <- lme(highBG_without_carb_with_bolus ~ Treatment*StudyVisit + HbA1c + Sex +
                                      age_years + Treatment*IncomeLevel + Insurance + highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
bolus_mod_ins <- lme(highBG_without_carb_with_bolus ~ Treatment*StudyVisit + HbA1c + Sex +
                                      age_years + IncomeLevel + Treatment*Insurance + highBG_without_carb_with_bolus_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
kable(AIC(bolus_mod_trt_visit,bolus_mod_a1c,bolus_mod_inc,bolus_mod_ins))
```

These are essentially the same in terms of AIC (as a rule of thumb an AIC difference > 2 is significant), so for consistency it makes sense to stick with the same model structure as for BG checks per day. So, the final model for % high boluses without carb is:

```{r}
bolus_mod <- lme(highBG_without_carb_with_bolus ~ Treatment*StudyVisit + 
                   HbA1c + Sex + age_years + IncomeLevel + Insurance + 
                   highBG_without_carb_with_bolus_b,
                 random =~1|Site/ID, data = dat,na.action = na.omit)
```

### Check the residuals

```{r echo=FALSE,dpi=600}
plot(bolus_mod,main="% bolused when high (150-250) and no carb")
```

These residuals are okay, but not great. I tried log transforming the outcome to see if it helps, but it didn't make much difference (plus controlling for the baseline value of the outcome complicates things because I think you also need to transform those values and it's hard to interpret on the log scale). I wouldn't say these violate assumptions though, and I've certainly seen worse. 

### Results

```{r echo=FALSE}
kable(anova(bolus_mod),caption = "Overall Effects")
kable(summary(bolus_mod)$tTable,caption = "Fixed Effects")
```

There was an overall effect of time on % high boluses without carb, but neither visit on its own was significantly different from baseline (I know this is a little odd, so we can chat about it when we go over the results). There was also an overall HbA1c effect, but nothing else was significant.

# Other outcomes

## Carb inputs per day

```{r echo=FALSE}
carb_mod <- lme(carb_inputs_per_day ~ Treatment*StudyVisit + HbA1c + Sex + 
                  age_years + IncomeLevel + Insurance + carb_inputs_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)
plot(carb_mod,main="Carb Inputs per Day")
```

Residuals look pretty good! It looks like there might be a couple of outliers though, so let's check those. To identify outliers we usually use something called Cook's distance:

```{r echo=FALSE}
carb_mod_lin <- lm(carb_inputs_per_day ~ Treatment*StudyVisit + HbA1c + Sex + age_years + IncomeLevel + Insurance + carb_inputs_per_day_b,data = dat)
plot(carb_mod_lin,which=4)
```

Here it looks like observations 171, 264, and 291 are potential outliers. these correspond to:

```{r echo=FALSE}
dat[171,c("ID","StudyVisit")]
dat[264,c("ID","StudyVisit")]
dat[291,c("ID","StudyVisit")]
```

```{r echo=FALSE}
kable(anova(carb_mod),caption = "Overall Effects")
kable(summary(carb_mod)$tTable,caption = "Fixed Effects")
```

There was an overall effect of study visit, HbA1c, sex, age, and income level. Study visit 3 was significantly different from baseline (p = 0.043), and on average there were 0.369 fewer carb inputs per day. 

## Boluses per day

```{r echo=FALSE}
bolus_day_mod <- lme(boluses_per_day ~ Treatment*StudyVisit + HbA1c + Sex + 
                  age_years + IncomeLevel + Insurance + boluses_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)
plot(bolus_day_mod,main="Boluses per Day")
```

Residuals look okay. It looks like there might be a couple of outliers, so 

```{r echo=FALSE}
bolus_day_mod <- lm(boluses_per_day ~ Treatment*StudyVisit + HbA1c + Sex + 
                  age_years + IncomeLevel + Insurance + boluses_per_day_b,
                  data = dat)

```

```{r echo=FALSE}
kable(anova(carb_mod),caption = "Overall Effects")
kable(summary(carb_mod)$tTable,caption = "Fixed Effects")
```
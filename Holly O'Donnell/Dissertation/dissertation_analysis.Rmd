---
title: "Holly's Dissertation"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tableone)
library(car)
library(skimr)
library(knitr)
library(tidyverse)
library(lme4)
library(nlme)
library(glmmLasso)
```

```{r echo=FALSE,include=FALSE}
# Import data
dat <- read.csv("/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Holly O'Donnell/Dissertation/Data_Raw/data_7.7.19.csv",na.strings = "")
# format and fill down dates and income level
dat$DateofBirth <- lubridate::mdy(dat$DateofBirth)
dat$DiagnosisDate <- lubridate::mdy(dat$DiagnosisDate)
dat$PumpStartDate <- lubridate::mdy(dat$PumpStartDate)
dat$VisitDate <- lubridate::mdy(dat$VisitDate)
dat <- dat %>% group_by(ID) %>% fill(DateofBirth,IncomeLevel,DiagnosisDate,
                                     PumpStartDate,Insurance,Sex) 
# Calculate age, T1D duration, and pump duration at each visit
dat$age_days <- difftime(dat$VisitDate,dat$DateofBirth,units = "days")
dat$age_years <- as.numeric(dat$age_days / 365.25)
dat$T1D_dur_days <- difftime(dat$VisitDate,dat$DiagnosisDate,units = "days")
dat$T1D_dur_years <- as.numeric(dat$T1D_dur_days / 365.25)
dat$pump_dur_days <- difftime(dat$VisitDate,dat$PumpStartDate,units = "days")
dat$pump_dur_yrs <- as.numeric(dat$pump_dur_days / 365.25)
# Add site field
dat$Site <- ifelse(as.numeric(dat$ID) < 300,"Florida","Colorado")
# Make study visit and treatment categorical
dat$StudyVisit <- as.factor(dat$StudyVisit)
dat$Treatment <- as.factor(dat$Treatment)
# Days from baseline, baseline levels of outcome
dat <- dat %>% group_by(ID) %>% 
  mutate(Days_since_baseline = as.numeric(difftime(VisitDate,VisitDate[1],units = "days")),
         readings_per_day_b = readings_per_day[1])
# Write CSV
write.csv(dat,file = "/Users/timvigers/Desktop/Holly_data.csv",row.names = F,na="")
```

# Model Selection (BG checks per day)

## Which time variable produces a better model fit?

```{r}
cat_time_mod <- lmer(readings_per_day ~ StudyVisit + (1|ID), data = dat)
cont_time_mod <- lmer(readings_per_day ~ Days_since_baseline + (1|ID), data = dat)
kable(AIC(cat_time_mod,cont_time_mod))
```

The model with visit number is a better fit than one using days from baseline, so we'll use visit number for the rest of the models. 

## Check the full model

```{r echo=FALSE,include=FALSE}
#LME4 model to check convergence
full_mod_l <- lmer(readings_per_day ~ Treatment + StudyVisit + Sex + HbA1c + Treatment:HbA1c + 
                     age_years + T1D_dur_years + IncomeLevel + Treatment:IncomeLevel +
                     Insurance + readings_per_day_b + (1|Site/ID), data = dat)
```

```{r}
full_mod <- lme(readings_per_day ~ Treatment*HbA1c + StudyVisit + Sex + 
                     age_years + T1D_dur_years + IncomeLevel + Treatment:IncomeLevel +
                     Insurance + readings_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)
```

### Check variance inflation factor

```{r echo=FALSE}
vif <- as.data.frame(vif(full_mod))
kable(vif)
```

In general, VIF > 10 is a concern so it looks like we don't need to worry about multicollinearity here. You can ignore the high values for treatment, since it's involved in interaction terms and obviously the interactions term will be correlated with the direct effect term. Also, VIF is < 10 when interaction terms are removed.

### Full model results

```{r echo=FALSE}
kable(summary(full_mod)$tTable)
```

Check the reduced model with only significant covariates from the full model. 

## Reduced model

```{r}
reduced_mod <- lme(readings_per_day ~ Treatment*HbA1c + StudyVisit + age_years + readings_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit) 
```

### Compare AIC

```{r warning=FALSE}
kable(AIC(full_mod,reduced_mod))
```

Lower AIC is better, so  this indicates that the full model is actually a better fit. Now compare to models with single covariates added back in. 

## Semi-reduced models

```{r echo=FALSE}
no_t1d_dur_mod <- lmer(readings_per_day ~ Treatment*HbA1c + StudyVisit + Sex + 
                     age_years + IncomeLevel + Treatment:IncomeLevel +
                     Insurance + readings_per_day_b + (1|Site/ID), 
                    data = dat,na.action = na.omit)
no_income_mod <- lmer(readings_per_day ~ Treatment*HbA1c + StudyVisit + Sex + 
                     age_years + T1D_dur_years + Insurance + readings_per_day_b + (1|Site/ID), 
                   data = dat,na.action = na.omit)
no_sex_mod <- lmer(readings_per_day ~ Treatment*HbA1c + StudyVisit + 
                     age_years + T1D_dur_years + IncomeLevel + Treatment:IncomeLevel +
                     Insurance + readings_per_day_b + (1|Site/ID), data = dat,na.action = na.omit)
no_insurance_mod <- lmer(readings_per_day ~ Treatment*HbA1c + StudyVisit + Sex + 
                     age_years + T1D_dur_years + IncomeLevel + Treatment:IncomeLevel +
                     readings_per_day_b + (1|Site/ID), data = dat,na.action = na.omit)
```

```{r}
no_t1d_dur_mod <- lme(readings_per_day ~ Treatment*HbA1c + StudyVisit + Sex + 
                     age_years + IncomeLevel + Treatment:IncomeLevel +
                     Insurance + readings_per_day_b,
                   random =~1|Site/ID, data = dat,na.action = na.omit)
no_income_mod <- lme(readings_per_day ~ Treatment*HbA1c + StudyVisit + Sex + 
                     age_years + T1D_dur_years + Insurance + readings_per_day_b,
                  random =~1|Site/ID, data = dat,na.action = na.omit)
no_sex_mod <- lme(readings_per_day ~ Treatment*HbA1c + StudyVisit + 
                     age_years + T1D_dur_years + IncomeLevel + Treatment:IncomeLevel +
                     Insurance + readings_per_day_b,
                  random =~1|Site/ID, data = dat,na.action = na.omit)
no_insurance_mod <- lme(readings_per_day ~ Treatment*HbA1c + StudyVisit + Sex + 
                     age_years + T1D_dur_years + IncomeLevel + Treatment:IncomeLevel +
                     readings_per_day_b,
                  random =~1|Site/ID, data = dat,na.action = na.omit)
```

### Compare AIC

```{r echo=FALSE,warning=FALSE}
kable(AIC(full_mod,no_t1d_dur_mod,no_sex_mod,no_insurance_mod,reduced_mod))
```

```{r echo=FALSE,warning=FALSE}
no_t1d_or_sex_mod <- lme(readings_per_day ~ Treatment + StudyVisit + HbA1c + Treatment:HbA1c + 
                     age_years + IncomeLevel + Treatment:IncomeLevel +
                     Insurance + readings_per_day_b,
                random =~1|Site/ID, data = dat,na.action = na.omit)
kable(AIC(full_mod,no_t1d_dur_mod,no_sex_mod,no_insurance_mod,no_t1d_or_sex_mod,reduced_mod))
```

The model without T1D duration or sex is the best by AIC.

# LASSO Variable Selection

```{r echo=FALSE,cache=TRUE,include=FALSE}
# Select only the necessary columns
lasso_data <- dat %>% dplyr::select(ID,Site,readings_per_day,Treatment,StudyVisit,
                                    HbA1c,age_years,T1D_dur_years,IncomeLevel,
                                    Sex,Insurance,readings_per_day_b)
# Complete cases
lasso_data <- lasso_data[complete.cases(lasso_data),]
# ID as a factor
lasso_data$ID <- as.factor(lasso_data$ID)
# Convert from tibble to dataframe
lasso_data <- as.data.frame(lasso_data)
# Use BIC to find optimal tuning parameter lambda (from glmmLasso demo)
lambda <- seq(500,0,by=-1)
AIC_vec<-rep(Inf,length(lambda))
for(j in 1:length(lambda)){
glm1 <- try(glmmLasso(readings_per_day ~ as.factor(Treatment) + as.factor(StudyVisit) + 
                        as.factor(Sex) + HbA1c + age_years + 
                        T1D_dur_years + as.factor(IncomeLevel) + 
                        as.factor(Insurance) + readings_per_day_b,
            data = lasso_data,rnd = list(ID=~1),lambda = lambda[j],final.re=TRUE))  
if(class(glm1)!="try-error"){AIC_vec[j]<-glm1$aic}}
opt<-which.min(AIC_vec)
```

```{r}
lasso <- glmmLasso(readings_per_day ~ as.factor(Treatment) + as.factor(StudyVisit) + 
                        as.factor(Sex) + HbA1c + age_years + 
                        T1D_dur_years + as.factor(IncomeLevel) + 
                        as.factor(Insurance) + readings_per_day_b,
            data = lasso_data,rnd = list(ID=~1),lambda = lambda[opt],final.re=TRUE)
```

```{r echo=FALSE}
kable(summary(lasso)$coefficients)
```

LASSO regression using AIC to determine the optimal shrinkage parameter agrees with our original model selection (without interaction terms or nested random effects), which is a good sign. It removes the visit variable from the model, but this makes sense since study visit wasn't significant in our model. It also agrees that sex and T1D duration are not necessary to include in the model.

# Check similar models for another outcome (% high boluses without carb)

```{r}
bolus_mod_full <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + StudyVisit + Sex + 
                        age_years + T1D_dur_years + IncomeLevel + Treatment:IncomeLevel + 
                        Insurance + readings_per_day_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)

no_t1d_or_sex_bolus_mod_full <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + StudyVisit + 
                                      age_years + IncomeLevel + Treatment:IncomeLevel + 
                                      Insurance + readings_per_day_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)

bolus_mod_reduced <- lme(highBG_without_carb_with_bolus ~ Treatment*HbA1c + StudyVisit + age_years + readings_per_day_b,
                     random =~1|Site/ID, data = dat,na.action = na.omit)
```

```{r echo=FALSE,warning=FALSE}
kable(AIC(bolus_mod_full,no_t1d_or_sex_bolus_mod_full,bolus_mod_reduced))
```

Technically the full model is better than the income model, because AIC is lower by 2.618 (the general rule of thumb is that a difference of 2 is significant). However, since they are pretty close I think it makes sense to use the same model structure for all of your outcomes, to help with the interpretation of the results. 

### To Do 

- Interaction effects between treatment, A1c, and income
- Control for gender, insurance, and baseline level of the outcome
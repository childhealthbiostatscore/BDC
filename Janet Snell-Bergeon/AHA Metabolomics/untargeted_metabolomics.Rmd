---
title: "AHA Untargeted Metabolomics"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Janet Snell-Bergeon/AHA collaborative grant/Metabolomics")
library(arsenal)
library(skimr)
library(knitr)
library(NormalizeMets)
library(sva)
library(metabomxtr)
library(mixOmics)
library(tidyverse)
```

# Data Summary

```{r missing data,echo=FALSE}
# Read in raw data
raw_data <- read.csv("./Data_Cleaned/metabolomics_without_imputation.csv",
                     stringsAsFactors = F,na.strings = c("","NA"))
# Format
data <- raw_data %>% 
  mutate(compound = coalesce(HMDB.No.,LI.Library.No.),
         neutralmass = Neutral.Mass..Da.,
         rt = RT..s.,
         masserror = coalesce(Mass.Error..ppm.,Mass.Error..ppm..1),
         rterror = coalesce(RT.Error..s.,RT.Error..s..1)) %>%
  select(compound,neutralmass,rt,masserror,rterror,
                IsoMS_results_QC01_190618171010_converted.csv:
                  IsoMS_results_S227_Batch07_1400_RA8_converted.csv)
data$compound <- paste(data$compound,data$neutralmass,data$rt,sep = "")
# Rename columns
colnames(data) <- gsub("IsoMS_results_","",colnames(data))
colnames(data) <- gsub("*_.*","",colnames(data))
# Import clinical data and sample list
clinical <- read.csv("./Data_Cleaned/targeted.csv",stringsAsFactors = F)
# Three progression groups
cac_groups <- read.table("./Data_Raw/CAC Trajectories 3 groups.txt",sep = "\t",
                         header = T)
# CAC progression - increase in square root calcium volume >= 2.5 between baseline and visit 3
clinical$CACp <- as.factor(ifelse(clinical$c3 - clinical$c1 >= 2.5,"Progression","No Progression"))
# New CAC groups
clinical <- left_join(clinical,cac_groups[,c("StudyID","GROUP")],by = "StudyID")
samples <- read.csv("./Data_Cleaned/sample_list.csv")
# Match sample number to subject ID
clinical$GlobalSampleID <- as.character(samples$Injection[match(clinical$StudyID,samples$SampleID)])
clinical$Batch <- samples$Batch[match(clinical$StudyID,samples$SampleID)]
# Relevant columns
clinical <- clinical %>%
  select(GlobalSampleID,age,sex,race,CACp,GROUP,Batch) %>%
  filter(!is.na(GlobalSampleID))
# Names
names <- data$compound
# Data matrix
data <- data %>% select(QC01:S227) %>%
  t(.) %>% as.data.frame(.) # Transpose - samples in rows
# Format columns
colnames(data) <- names
data$GlobalSampleID <- as.character(rownames(data))
# Add clinical data
data <- left_join(data,clinical,by = "GlobalSampleID")
data <- data %>% select(GlobalSampleID:Batch,everything())
data$GROUP[grepl("QC",data$GlobalSampleID)] <- "QC"
data$GROUP <- as.factor(data$GROUP)
# Remove QC
X <- data %>% select(GlobalSampleID,age:Batch,everything()) %>% 
  filter(!(grepl("QC",GlobalSampleID)))
# Column formats
X[,c("GlobalSampleID","sex","race")] <- lapply(X[,c("GlobalSampleID","sex","race")],as.factor)
# Check distributions - log transform
logged <- X
logged[,8:ncol(logged)] <- lapply(logged[,8:ncol(logged)], log)
skim(logged)
```

# Mixture Models

```{r cache=TRUE}
# Try mixture model with first two metabolites
# Basic models
fullModel <- ~ GROUP|GROUP + age + sex + race + Batch
reducedModel <- ~ 1|age + sex + race + Batch
# Metabolites
Y = colnames(X)[8:ncol(X)]
# Full model results
fullModelResults <- mxtrmod(ynames=Y,mxtrModel=fullModel,data=logged)
# Reduced model results
reducedModelResults<-mxtrmod(ynames=Y,mxtrModel=reducedModel,fullModel=fullModel,
                             data=logged)
# LRT
raw_results <- mxtrmodLRT(fullModelResults,reducedModelResults,adj = "BH")
raw_results <- raw_results[order(raw_results$p),]
kable(raw_results,row.names = F)
```

## Normalization

```{r mixnorm,echo=FALSE,eval=FALSE}

```

```{r normalizemets,echo=FALSE,eval=FALSE}
# Metabolite data
featuredata <- df_qc[,9:(ncol(df_qc)-1)]
rownames(featuredata) <- df_qc$GlobalSampleID
# Injection order
sampledata <- read.csv("./Data_Cleaned/injection_seq.csv",stringsAsFactors = F) %>%
  select(Injection,SampleName,Position) %>%
  filter(Injection %in% rownames(featuredata))
# Format sample data
sampledata$batch <- sapply(strsplit(sampledata$SampleName,"_"),`[`,2)
sampledata$batch[nrow(sampledata)] <- sampledata$batch[(nrow(sampledata)-1)]
sampledata$batch <- sub("Batch0","",sampledata$batch)
sampledata <- sampledata %>% fill(batch,.direction = "up") %>%
  mutate(order = 1:n())
rownames(sampledata) <- sampledata$GlobalSampleID
sampledata$class <- df_qc$GROUP[match(sampledata$Injection,df_qc$GlobalSampleID)]
sampledata$class[sampledata$class == "QC"] <- 0
# Match sample and feature data, set rownames
featuredata <- featuredata[match(sampledata$Injection,rownames(featuredata)),]
featuredata <- as.data.frame(featuredata)
rownames(sampledata) <- sampledata$Injection
sampledata <- sampledata %>% select(batch,class,order) %>% as.data.frame()
# Normalize - saves output in working directory
normalized <- NormQcsamples(featuredata, sampledata, method = c("rlsc"), span = 0,
  deg = 2, lg = TRUE, saveoutput = T)
```

```{r combat,echo=FALSE,eval=FALSE}

```

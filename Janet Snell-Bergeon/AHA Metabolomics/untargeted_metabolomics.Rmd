---
title: "AHA Untargeted Metabolomics"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/Tim/metabolomics")
library(tableone)
library(skimr)
library(knitr)
library(sas7bdat)
library(NormalizeMets)
library(mixOmics)
library(tidyverse)
```

```{r echo=FALSE,include=FALSE,cache=TRUE}
# Read in
# Manually changed HMDB library for 292 from "314" to "HMDB314
raw_metab <- read.csv("./Data_Cleaned/metabolomics.csv",na.strings = "",
                      stringsAsFactors = F) 
# Subset
metab <- raw_metab %>% 
  mutate(compound = coalesce(HMDB.No.,LI.Library.No.),
         neutralmass = Neutral.Mass..Da.,
         rt = RT..s.,
         masserror = coalesce(Mass.Error..ppm.,Mass.Error..ppm..1),
         rterror = coalesce(RT.Error..s.,RT.Error..s..1)) %>% 
  dplyr::select(compound,neutralmass,rt,masserror,rterror,
                IsoMS_results_QC01_190618171010_converted.csv:
                  IsoMS_results_S227_Batch07_1400_RA8_converted.csv)
metab$compound <- paste(metab$compound,metab$neutralmass,metab$rt,sep = "")
# Rename columns by sample number
colnames(metab) <- gsub("IsoMS_results_","",colnames(metab))
colnames(metab) <- gsub("*_.*","",colnames(metab))
# Import clinical data and sample list
targeted <- read.csv("./Data_Cleaned/targeted.csv")
# Three progression groups
cac_groups <- read.table("./Data_Raw/CAC Trajectories 3 groups.txt",sep = "\t",
                         header = T)
# CAC progression - increase in square root calcium volume >= 2.5 between baseline and visit 3
targeted$CACp <- as.factor(ifelse(targeted$c3 - targeted$c1 >= 2.5,"Progression","No Progression"))
# New CAC groups
targeted <- left_join(targeted,cac_groups[,c("StudyID","GROUP")],by = "StudyID")
samples <- read.csv("./Data_Cleaned/sample_list.csv")
# Match sample number to subject ID
targeted$GlobalSampleID <- samples$Injection[match(targeted$StudyID,samples$SampleID)]
targeted$Batch <- samples$Batch[match(targeted$StudyID,samples$SampleID)]
# Select relevant columns
df <- targeted %>% 
  select(GlobalSampleID,gender,age,sex,race,CACp,GROUP,Batch) %>% 
  filter(!is.na(GlobalSampleID))
# Combine sex and group
df$sex_and_group <- paste(df$gender,df$GROUP)
# Metabolite matrix
X <- metab %>% dplyr::select(compound,QC01:S227)
X <- t(X)
colnames(X) <- X[1,]
X <- X[-c(1),]
X <- as.data.frame(X)
X$GlobalSampleID <- rownames(X)
df$GlobalSampleID <- as.character(df$GlobalSampleID)
df <- left_join(X,df,by = "GlobalSampleID")
df$GROUP[grep("QC",df$GlobalSampleID)] <- "QC"
df <- df %>% select(GlobalSampleID,gender,age,sex,race,CACp,GROUP,sex_and_group,everything())
# As numeric
metabolites <- setdiff(names(df),c("GlobalSampleID","gender","age","sex","race","CACp","GROUP","sex_and_group","Batch"))
df[,metabolites] <- lapply(df[,metabolites], function(x) as.numeric(as.character(x)))
df$sex_and_group[df$GROUP == "QC"] <- "QC"
df_qc <- df
df <- df[df$GROUP != "QC",]
X <- df %>% select(-GlobalSampleID,-gender,-age,-sex,-race,-CACp,-GROUP,-sex_and_group,-Batch)
X <- as.matrix(X)
class(X) <- "numeric"
```

# PCA

```{r}
# Try PCA
pca <- pca(X,ncomp=5,center=T,scale=T)
plot(pca)
# Plots
plotIndiv(pca,group = df$GROUP,legend = T,ind.names = F,ellipse = TRUE,
          title = "PCA comp 1-2 by CAC Group",pch = 20)

# PCA by batch
pca <- pca(X,ncomp=5,center=T,scale=T)
plot(pca)
# Plots
plotIndiv(pca,group = df$Batch,legend = T,ind.names = F,ellipse = TRUE,
          title = "PCA comp 1-2 by Batch",pch = 20)
```

# PLS-DA

## Group

### Performance and Results

```{r group plsda}
# Outcome
Y <- factor(df$GROUP)
# PLSDA
plsda <- plsda(X, Y, ncomp = 10,scale = T)
# Evaluate
perf.plsda <- perf(plsda, validation = "loo", folds = 5,
                  progressBar = FALSE, auc = TRUE)
plot(perf.plsda, sd = TRUE, legend.position = "horizontal")
# Plots
plotIndiv(plsda,group = df$GROUP, ind.names = FALSE,pch = 20,
          ellipse = TRUE, legend = TRUE, title = 'PLSDA on GROUP')
```

### Heatmap

```{r echo=FALSE,fig.width=8,fig.height=8}
cim(plsda)
```

## Group and Sex

### Performance and Results

```{r sex and group plsda}
# Outcome
Y <- factor(df$sex_and_group)
# PLSDA
plsda <- plsda(X, Y, ncomp = 10,scale = T)
# Evaluate
perf.plsda <- perf(plsda, validation = "loo", folds = 5,
                  progressBar = FALSE, auc = TRUE)
plot(perf.plsda, sd = TRUE, legend.position = "horizontal")
# Plots
plotIndiv(plsda,group = df$sex_and_group, ind.names = FALSE,pch = 20,
          ellipse = TRUE, legend = TRUE, title = 'PLSDA on Sex and GROUP')
```

### Heatmap

```{r echo=FALSE,fig.width=8,fig.height=8}
cim(plsda)
```

## Sex Only

### Performance and Results

```{r sex plsda}
# Outcome
Y <- factor(df$gender)
# PLSDA
plsda <- plsda(X, Y, ncomp = 10,scale = T)
# Evaluate
perf.plsda <- perf(plsda, validation = "loo", folds = 5,
                  progressBar = FALSE, auc = TRUE)
plot(perf.plsda, sd = TRUE, legend.position = "horizontal")
# Plots
plotIndiv(plsda,group = df$gender, ind.names = FALSE,pch = 20,
          ellipse = TRUE, legend = TRUE, title = 'PLSDA on Sex')
```

# sPLS-DA

## Group

### Performance and Results

```{r group splsda}
Y <- factor(df$GROUP)
# sPLSDA tuning
tune.splsda <- tune.splsda(X, Y, ncomp = 4, validation = 'Mfold', folds = 5,
                           progressBar = FALSE, dist = 'max.dist',
                           nrepeat = 10)
choice.ncomp <- tune.splsda$choice.ncomp$ncomp
choice.keepX <- tune.splsda$choice.keepX[1:choice.ncomp]
# sPLS-DA
splsda.res <- splsda(X, Y, ncomp = choice.ncomp, keepX = choice.keepX)
# Model performance
perf.splsda <- perf(splsda.res, validation = "Mfold", folds = 5,
                  progressBar = FALSE, auc = TRUE, nrepeat = 10)
plot(perf.splsda, sd = TRUE, legend.position = "horizontal")
perf.splsda$error.rate
plotIndiv(splsda.res,group = df$GROUP, ind.names = FALSE,pch = 20,
          ellipse = TRUE, legend = TRUE, title = 'sPLSDA on GROUP')
```

## Heatmap

```{r echo=FALSE,fig.width=8,fig.height=8}
cim(splsda.res)
```

## Group and Sex

### Performance and Results

```{r sex and group splsda}
Y <- factor(df$sex_and_group)
# sPLSDA tuning
tune.splsda <- tune.splsda(X, Y, ncomp = 4, validation = 'Mfold', folds = 5,
                           progressBar = FALSE, dist = 'max.dist',
                           nrepeat = 10)
choice.ncomp <- 2
choice.keepX <- tune.splsda$choice.keepX[1:choice.ncomp]
# sPLS-DA
splsda.res <- splsda(X, Y, ncomp = choice.ncomp, keepX = choice.keepX)
# Model performance
perf.splsda <- perf(splsda.res, validation = "Mfold", folds = 5,
                  progressBar = FALSE, auc = TRUE, nrepeat = 10)
plot(perf.splsda, sd = TRUE, legend.position = "horizontal")
perf.splsda$error.rate
plotIndiv(splsda.res,group = df$sex_and_group, ind.names = FALSE,pch = 20,
          ellipse = TRUE, legend = TRUE, title = 'sPLSDA on Sex and GROUP')
```

## Heatmap

```{r echo=FALSE,fig.width=8,fig.height=8}
cim(splsda.res)
```

## Sex Only

### Performance and Results

```{r sex splsda}
# Outcome
Y <- factor(df$gender)
# sPLSDA tuning
tune.splsda <- tune.splsda(X, Y, ncomp = 4, validation = 'Mfold', folds = 5,
                           progressBar = FALSE, dist = 'max.dist',
                           nrepeat = 10)
choice.ncomp <- tune.splsda$choice.ncomp$ncomp
choice.keepX <- tune.splsda$choice.keepX[1:choice.ncomp]
# sPLS-DA
splsda.res <- splsda(X, Y, ncomp = choice.ncomp, keepX = choice.keepX)
# Model performance
perf.splsda <- perf(splsda.res, validation = "Mfold", folds = 5,
                  progressBar = FALSE, auc = TRUE, nrepeat = 10)
plot(perf.splsda, sd = TRUE, legend.position = "horizontal")
perf.splsda$error.rate
plotIndiv(splsda.res,group = df$gender, ind.names = FALSE,pch = 20,
          ellipse = TRUE, legend = TRUE, title = 'sPLSDA on Sex')
```

## Heatmap

```{r echo=FALSE,fig.width=8,fig.height=8}
cim(splsda.res)
```

## ANOVA

### Sex Only

P values adjusted using the FDR method

```{r anova sex,echo=FALSE}
anova_results <- lapply(metabolites, function(x){
  form <- as.formula(paste0(x,"~factor(gender)"))
  mod <- aov(form,df[df$GROUP != "QC",])
  results <- broom::tidy(mod)
  results[1,1] <- x
  as.data.frame(results[1,])
})
anova_results <- bind_rows(anova_results)
anova_results <- anova_results %>% arrange(p.value)
anova_results$p.value <- p.adjust(anova_results$p.value,"fdr")
kable(anova_results[which(anova_results$p.value < 0.05),])
```

## Normalization

```{r normalization,echo=FALSE,eval=FALSE}
# Metabolite data
featuredata <- df_qc[,9:(ncol(df_qc)-1)]
rownames(featuredata) <- df_qc$GlobalSampleID
# Injection order
sampledata <- read.csv("./Data_Cleaned/injection_seq.csv",stringsAsFactors = F) %>%
  select(Injection,SampleName,Position) %>%
  filter(Injection %in% rownames(featuredata))
# Format sample data
sampledata$batch <- sapply(strsplit(sampledata$SampleName,"_"),`[`,2)
sampledata$batch[nrow(sampledata)] <- sampledata$batch[(nrow(sampledata)-1)]
sampledata$batch <- sub("Batch0","",sampledata$batch)
sampledata <- sampledata %>% fill(batch,.direction = "up") %>%
  mutate(order = 1:n())
rownames(sampledata) <- sampledata$GlobalSampleID
sampledata$class <- df_qc$GROUP[match(sampledata$Injection,df_qc$GlobalSampleID)]
sampledata$class[sampledata$class == "QC"] <- 0
# Match sample and feature data, set rownames
featuredata <- featuredata[match(sampledata$Injection,rownames(featuredata)),]
featuredata <- as.data.frame(featuredata)
rownames(sampledata) <- sampledata$Injection
sampledata <- sampledata %>% select(batch,class,order) %>% as.data.frame()
# Normalize - saves output in working directory
normalized <- NormQcsamples(featuredata, sampledata, method = c("rlsc"), span = 0,
  deg = 2, lg = TRUE, saveoutput = T)
```

### PCA on Normalized Data

```{r normalized,echo=FALSE}
df_qc <- read.csv("./qcsample_results.csv")
df_qc$sampledata.class[is.na(df_qc$sampledata.class)] <- "QC"
X <- as.matrix(df_qc[,6:ncol(df_qc)])
class(X) <- "numeric"
# Try PCA 
pca <- pca(X,ncomp=5,center=T,scale=T)
# Plots
plotIndiv(pca,group = df_qc$sampledata.class,legend = T,ind.names = F,ellipse = TRUE,
          title = "PCA comp 1-2 by CAC Group",pch = 20)
# Plots
plotIndiv(pca,group = df_qc$sampledata.batch,legend = T,ind.names = F,ellipse = TRUE,
          title = "PCA comp 1-2 by Batch",pch = 20)
```

### Remove Potential Outliers

```{r normalized no outliers,echo=FALSE}
X <- X[-c(172,235),]
pca <- pca(X,ncomp=5,center=T,scale=T)
# Plots
plotIndiv(pca,group = df_qc$sampledata.class[-c(172,235)],legend = T,
          ind.names = F,ellipse = TRUE,pch = 20,
          title = "PCA comp 1-2 by CAC Group")
# Plots
plotIndiv(pca,group = df_qc$sampledata.batch[-c(172,235)],
          legend = T,ind.names = F,ellipse = TRUE,pch = 20,
          title = "PCA comp 1-2 by Batch")
```

# sPLS-DA

## Group

### Performance and Results

```{r group splsda}
Y <- factor(df_qc$sampledata.class[-c(172,235)])
# sPLSDA tuning
tune.splsda <- tune.splsda(X, Y, ncomp = 4, validation = 'Mfold', folds = 5,
                           progressBar = FALSE, dist = 'max.dist',
                           nrepeat = 10)
choice.ncomp <- tune.splsda$choice.ncomp$ncomp
choice.keepX <- tune.splsda$choice.keepX[1:choice.ncomp]
# sPLS-DA
splsda.res <- splsda(X, Y, ncomp = choice.ncomp, keepX = choice.keepX)
# Model performance
perf.splsda <- perf(splsda.res, validation = "Mfold", folds = 5,
                  progressBar = FALSE, auc = TRUE, nrepeat = 10)
plot(perf.splsda, sd = TRUE, legend.position = "horizontal")
perf.splsda$error.rate
plotIndiv(splsda.res,group = df_qc$sampledata.class[-c(172,235)],
          ind.names = FALSE,pch = 20,
          ellipse = TRUE, legend = TRUE, title = 'sPLSDA on GROUP')
```
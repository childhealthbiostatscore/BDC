---
title: "AHA Untargeted Metabolomics"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Janet Snell-Bergeon/AHA collaborative grant")
library(tableone)
library(skimr)
library(knitr)
library(sas7bdat)
library(mixOmics)
library(tidyverse)
```

```{r echo=FALSE,cache=TRUE}
# Read in
raw_metab <- read.csv("./Data_Cleaned/metabolomics.csv",na.strings = "",stringsAsFactors = F)
# Subset
metab <- raw_metab %>% 
  mutate(compound = coalesce(HMDB.No.,LI.Library.No.),
         neutralmass = Neutral.Mass..Da.,
         rt = RT..s.,
         masserror = coalesce(Mass.Error..ppm.,Mass.Error..ppm..1),
         rterror = coalesce(RT.Error..s.,RT.Error..s..1)) %>% 
  dplyr::select(compound,neutralmass,rt,masserror,rterror,
                IsoMS_results_QC01_190618171010_converted.csv:IsoMS_results_S227_Batch07_1400_RA8_converted.csv)
# Rename columns by sample number
colnames(metab) <- gsub("IsoMS_results_","",colnames(metab))
colnames(metab) <- gsub("*_.*","",colnames(metab))
# Import clinical data and sample list
targeted <- read.csv("./Data_Cleaned/targeted.csv")
samples <- read.csv("./Data_Cleaned/sample_list.csv")
# Match sample number to subject ID
targeted$GlobalSampleID <- samples$Injection[match(targeted$StudyID,samples$SampleID)]
# Select columns, filter out missing
clinical <- targeted %>% 
  dplyr::select(GlobalSampleID,gender,age,sex,race,CACGROUP) %>% 
  filter(!is.na(GlobalSampleID)) %>% arrange(GlobalSampleID)
```

# PCA

```{r echo=FALSE}
# Transpose
X <- metab %>% dplyr::select(compound,S001:S227)
X <- t(X)
cols <- X[1,]
X <- X[-c(1),]
class(X) <- "numeric"
colnames(X) <- cols
# Try PCA 
pca <- pca(X,ncomp=5,center=F,scale=F)
plot(pca)
# Sample plot
plotIndiv(pca,comp=c(1,2),group = clinical$CACGROUP,legend = T,ind.names = F,
          title = "PCA comp 1-2 by CAC Group",pch = 20)
```

# SPLSDA
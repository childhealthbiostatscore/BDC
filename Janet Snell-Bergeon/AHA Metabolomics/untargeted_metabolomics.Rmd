---
title: "AHA Untargeted Metabolomics"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Janet Snell-Bergeon/AHA collaborative grant/Metabolomics")
library(arsenal)
library(skimr)
library(knitr)
library(tidyverse)
library(limma)
library(WGCNA)
```

```{r data cleaning,echo=FALSE}
# Read in raw data
raw_data <- read.csv("./Data_Cleaned/metabolomics_without_imputation.csv",
                     stringsAsFactors = F,na.strings = c("","NA"))
# Format
data <- raw_data %>% 
  mutate(compound = coalesce(HMDB.No.,LI.Library.No.),
         m.z = Neutral.Mass..Da.+1.0078,
         rt = RT..s.,
         masserror = coalesce(Mass.Error..ppm.,Mass.Error..ppm..1),
         rterror = coalesce(RT.Error..s.,RT.Error..s..1)) %>%
  select(compound,m.z,rt,masserror,rterror,
                IsoMS_results_QC01_190618171010_converted.csv:
                  IsoMS_results_S227_Batch07_1400_RA8_converted.csv)
data$compound <- paste(data$compound,data$m.z,data$rt,sep = "_")
# Rename columns
colnames(data) <- gsub("IsoMS_results_","",colnames(data))
colnames(data) <- gsub("*_.*","",colnames(data))
# Import clinical data and sample list
clinical <- read.csv("./Data_Cleaned/targeted.csv",stringsAsFactors = F)
# Three progression groups
cac_groups <- read.table("./Data_Raw/CAC Trajectories 3 groups.txt",sep = "\t",
                         header = T)
# CAC progression - increase in square root calcium volume >= 2.5 between baseline and visit 3
clinical$CACp <- 
  as.factor(ifelse(clinical$c3 - clinical$c1 >= 2.5,"Progression","No Progression"))
# New CAC groups
clinical <- left_join(clinical,cac_groups[,c("StudyID","GROUP")],by = "StudyID")
samples <- read.csv("./Data_Cleaned/sample_list.csv")
# Match sample number to subject ID
clinical$GlobalSampleID <- 
  as.character(samples$Injection[match(clinical$StudyID,samples$SampleID)])
# Relevant columns
clinical <- clinical %>%
  select(GlobalSampleID,age,sex,race,CACp,GROUP) %>%
  filter(!is.na(GlobalSampleID))
# Names
names <- data$compound
# Data matrix
data <- data %>% select(QC01:S227) %>%
  t(.) %>% as.data.frame(.) # Transpose - samples in rows
# Format columns
colnames(data) <- names
data$GlobalSampleID <- as.character(rownames(data))
# Add clinical data
data <- left_join(data,clinical,by = "GlobalSampleID")
data <- data %>% select(GlobalSampleID:GROUP,everything())
data$GROUP[grepl("QC",data$GlobalSampleID)] <- "QC"
data$GROUP <- as.factor(data$GROUP)
# QC batch info
# Injection order
sampledata <- read.csv("./Data_Cleaned/injection_seq.csv",stringsAsFactors = F)
sampledata$batch <- sapply(strsplit(sampledata$SampleName,"_"),`[`,2)
sampledata$batch[nrow(sampledata)] <- sampledata$batch[(nrow(sampledata)-1)]
sampledata$batch <- sub("Batch0","",sampledata$batch)
sampledata <- sampledata %>% fill(batch,.direction = "up") %>%
  mutate(order = 1:n())
# Merge
data <- left_join(data,sampledata[,c("GlobalSampleID","batch")],
                  by = "GlobalSampleID")
data$batch <- as.factor(data$batch)
# Order columns
data <- data %>% select(GlobalSampleID:GROUP,batch,everything())
# Column formats
data[,c("GlobalSampleID","sex","race")] <- 
  lapply(data[,c("GlobalSampleID","sex","race")],as.factor) 
# Log transform
data[,8:ncol(data)] <- lapply(data[,8:ncol(data)],log)
```

# T tests

```{r echo=FALSE}
# Non-missing outcome
X <- data[,c(5,6,8:ncol(data))]
X <- X[!is.na(X[,1]),]
X$GROUP <- as.factor(as.character(X$GROUP))
# Test all
ts <- lapply(colnames(X)[c(3:293,295:ncol(X))], function(x){
  form <- as.formula(paste0(x,"~CACp"))
  t <- t.test(form,X)
  return(list("metabolite"=x,"p"=t$p.value))
})
ts <- data.frame(do.call(rbind,ts))
ts$p <- as.numeric(ts$p)
ts <- ts[order(ts$p),]
ts$p.adjusted <- p.adjust(ts$p,method = "fdr")
```

# ANOVA

```{r echo=FALSE}
# Test all
anovas <- lapply(colnames(X)[c(3:293,295:ncol(X))], function(x){
  form <- as.formula(paste0(x,"~GROUP"))
  mod <- lm(form,X)
  f <- anova(mod)
  return(list("metabolite"=x,"p"=f$`Pr(>F)`[1]))
})
anovas <- data.frame(do.call(rbind,anovas))
anovas$p <- as.numeric(anovas$p)
anovas <- anovas[order(anovas$p),]
anovas$p.adjusted <- p.adjust(anovas$p,method = "fdr")
```

# Moderated t tests

```{r echo=FALSE}
X <- data[,c(5,8:ncol(data))]
X <- X[!is.na(X[,1]),]
# Design matrix - 0 and 1 for CAC progression
design <- as.data.frame(X[,1])
design$int <- 1
design <- data.matrix(design[,c(2,1)])
design[design[,2] == 1,2] <- 0
design[design[,2] == 2,2] <- 1
# "Expression" matrix (samples in columns) for each 
X[,1] <- NULL
X <- t(X)
# Linear model
fit <- lmFit(X,design)
fit <- eBayes(fit,proportion = 0.1)
# Results
results <- topTable(fit,number = nrow(X))
results$m.z <- sapply(strsplit(rownames(results),"_"),"[[",2)
results$p.value <- results$P.Value
results$t.score <- fit$coefficients[match(rownames(results),rownames(fit$t)),2]
write.csv(results[,c("m.z","p.value","t.score")],row.names = F,
          file = "./Data_Cleaned/moderated_t_tests_CACp.csv")
```

# WGCNA

- Samples with > 50% missing are excluded

```{r echo=FALSE}
# WGCNA dataframe - samples in rows
W <- as.data.frame(data[,8:ncol(data)])
rownames(W) <- data$GlobalSampleID
# Exclude QC
W <- W[14:nrow(W),]
# Good samples and metabolites only
gsm <- goodSamplesGenes(W)
W <- W[,gsm$goodGenes]
W <- W[gsm$goodSamples,]
# Make sample tree
sampleTree <- hclust(dist(W), method = "average")
plot(sampleTree)
```
---
title: "AHA Untargeted Metabolomics"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Janet Snell-Bergeon/AHA collaborative grant")
library(tableone)
library(skimr)
library(knitr)
library(sas7bdat)
library(mixOmics)
library(tidyverse)
```

```{r echo=FALSE,cache=TRUE,include=FALSE}
# Read in
raw_metab <- read.csv("./Data_Cleaned/metabolomics.csv",na.strings = "",stringsAsFactors = F)
# Subset
metab <- raw_metab %>% 
  mutate(compound = coalesce(HMDB.No.,LI.Library.No.),
         neutralmass = Neutral.Mass..Da.,
         rt = RT..s.,
         masserror = coalesce(Mass.Error..ppm.,Mass.Error..ppm..1),
         rterror = coalesce(RT.Error..s.,RT.Error..s..1)) %>% 
  dplyr::select(compound,neutralmass,rt,masserror,rterror,
                IsoMS_results_QC01_190618171010_converted.csv:IsoMS_results_S227_Batch07_1400_RA8_converted.csv)
metab$compound <- paste(metab$compound,metab$neutralmass,metab$rt,sep = "")
# Rename columns by sample number
colnames(metab) <- gsub("IsoMS_results_","",colnames(metab))
colnames(metab) <- gsub("*_.*","",colnames(metab))
# Import clinical data and sample list
targeted <- read.csv("./Data_Cleaned/targeted.csv")
# Three progression groups
cac_groups <- read.table("./Data_Raw/CAC Trajectories 3 groups.txt",sep = "\t",
                         header = T)
# CAC progression - increase in square root calcium volume >= 2.5 between baseline and visit 3
targeted$CACp <- as.factor(ifelse(targeted$c3 - targeted$c1 >= 2.5,"Progression","No Progression"))
# New CAC groups
targeted <- left_join(targeted,cac_groups[,c("StudyID","GROUP")],by = "StudyID")
samples <- read.csv("./Data_Cleaned/sample_list.csv")
# Match sample number to subject ID
targeted$GlobalSampleID <- samples$Injection[match(targeted$StudyID,samples$SampleID)]
# Select relevant columns
df <- targeted %>% 
  select(GlobalSampleID,gender,age,sex,race,CACp,GROUP) %>% 
  filter(!is.na(GlobalSampleID))
# Metabolite matrix
X <- metab %>% dplyr::select(compound,S001:S227)
X <- t(X)
colnames(X) <- X[1,]
X <- X[-c(1),]
X <- as.data.frame(X)
X$GlobalSampleID <- rownames(X)
df <- left_join(X,df,by = "GlobalSampleID")
```

# PCA

```{r echo=FALSE}
X <- subset(X,select = -GlobalSampleID)
X <- as.matrix(X)
class(X) <- "numeric"
# Try PCA 
pca <- pca(X,ncomp=5,center=F,scale=F)
plot(pca)
# Sample plot
plotIndiv(pca,comp=c(1,2),group = clinical$GROUP,legend = T,ind.names = F,
          title = "PCA comp 1-2 by CAC Group",pch = 20)
```

# PLS-DA

```{r echo=FALSE,include=FALSE}
# Outcome
Y <- factor(df$GROUP)
# PLSDA
plsda <- plsda(X, Y, ncomp = 10)
# Plot
plotIndiv(plsda , comp = 1:2,
          group = df$GROUP, ind.names = FALSE, 
          ellipse = TRUE, legend = TRUE, title = 'PLSDA on GROUP')
```

---
title: "AHA Untargeted Metabolomics - DAISY CHECK"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Volumes/peds/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects/Janet Snell-Bergeon/AHA collaborative grant/Metabolomics")
library(arsenal)
library(skimr)
library(knitr)
library(sva)
library(metabomxtr)
library(mixOmics)
library(tidyverse)
```

```{r data,echo=FALSE}
# Read in raw data
raw_data = read.delim("./DAISY/QEHF_NPTD_CombinedSearch_proteinGroups_PerseusProcessed_20160624_Liu.txt",stringsAsFactors = F,na.strings = c("","NaN"))
# Format
data = raw_data %>%
  select(Unique.SN,Reporter.intensity.corrected.0.NP01:
           Reporter.intensity.corrected.9.TD11)
# Rename columns
colnames(data) = gsub("Reporter.intensity.corrected.","",colnames(data))
# Convert ids to metadata format
ids = colnames(data)[2:ncol(data)]
ids = strsplit(ids,"\\.")
ids = unlist(lapply(ids, function(x){
  num = as.numeric(x[1]) + 1
  paste(x[2],num,sep = "_")
}))
ids[grep("_10",ids)] = "commonRef"
colnames(data)[2:ncol(data)] = ids
# Transpose (samples in rows), fix column and row names
data = t(data)
colnames(data) = data[1,]
data = as.data.frame(data[-1,])
data$PNNLID = rownames(data)
# Import clinical data
clinical = read.csv("./DAISY/DAISY2_metadata_05_07_2015_rev_kcw.csv",na.strings = "")
clinical = clinical[clinical$PNNLID %in% rownames(data),]
# Relevant columns
clinical = clinical %>% select(PNNLID,RACE,SEX)
# Add clinical data (remove commonRefs)
data = inner_join(data,clinical,by = "PNNLID")
data = data %>% select(PNNLID:SEX,everything())
# Check distributions
skim(data)
```

# PCA

```{r pca,echo=FALSE,cache=TRUE}
# Abundances only (no ID)
X <- abundance[,proteins]
# Through PC4 explains ~95% of variance
result <- pca(X, ncomp = 4, center = T, scale = T)
plotIndiv(result,group = abundance$GROUP,legend = T,ellipse = T,
          title = "PCA by CAC Group")
```

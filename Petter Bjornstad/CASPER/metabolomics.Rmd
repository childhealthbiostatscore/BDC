---
title: "CASPER Untargeted Metabolomics"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,dpi = 600)
knitr::opts_knit$set(root.dir = "Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/Metabolomics")
library(arsenal)
library(skimr)
library(knitr)
library(mixOmics)
library(limma)
library(tidyverse)
library(haven)
library(psych)
library(pheatmap)
set.seed(1017)
```

```{r data,include=FALSE}
# Import data
raw_data <- read.csv("./Raw data/2020-03-20 Bjornstad discovery mode results jrh v2.csv",stringsAsFactors=F,na.strings = "")
samples <- read.csv("./Clean data/KNN_serum.csv_sampledata.csv")
samples$X <- NULL
# Transpose
compounds <- 
  paste("W",raw_data$Molecular.Weight,raw_data$RT..min.,sep="_")
df <- raw_data %>% dplyr::select(CS.01:RH.47.L) %>% t()
colnames(df) <- compounds
df <- as.data.frame(df)
# Sample data
df$ID <- sub("\\.","-",sub(".L","",rownames(df)))
df <- left_join(df,samples,by = "ID")
# Outcome 
df$group <- factor(df$group,levels = c(1,4),labels = c("T1D","Control"))
# SAS data
sas <- read_sas("./Raw data/casperheir_for_laura.sas7bdat")
# Add
df <- 
  left_join(df,sas[,c("ID","kidney_GFR","medullary_GFR","cortex_GFR")],
                by = "ID")
# Reorganize
df <- df %>% dplyr::select(ID:cortex_GFR,everything())
# Delete SAS data
rm(sas)
```

# Preprocessing

```{r preprocessing}
# Check for samples missing > 80% of compounds, remove them
missing <- 
  which(rowSums(is.na(df[,11:ncol(df)])) / length(11:ncol(df)) > 0.8)
if (length(missing)>0){df <- df[-missing,]}
# Same for 0 instead of NA - none
missing0 <- which(rowSums(df[,11:ncol(df)] == 0) / length(11:ncol(df)) > 0.8)
# Write csv
# write.csv(df,file = "./Clean data/metabolomics_for_RF.csv",
#           row.names = F,na = "")
```

Removed `r length(missing)` samples missing > 80% of compounds and `r length(missing0)` samples with > 80% of compounds equal to 0. 

```{r}
X <- df[,14:ncol(df)]
```

# PCA

```{r pca,cache=TRUE,eval=FALSE}
# 3 PCs
pca.res <- pca(X, ncomp = 3, center = TRUE, scale = FALSE)
# Plot
plotIndiv(pca.res,group = df$group,legend = TRUE,ind.names = FALSE,
          title = 'PCA by Group (PCs 1 & 2)',ellipse = T)
plotIndiv(pca.res,comp = c(1,3),group = df$group,legend = TRUE,
          ind.names = FALSE,title = 'PCA by Group (PCs 1 & 3)',
          ellipse = T)
plotIndiv(pca.res,comp = c(2,3),group = df$group,legend = TRUE,
          ind.names = FALSE,title = 'PCA by Group (PCs 2 & 3)',
          ellipse = T)
```

# PLS-DA

## PLS-DA Performance

```{r plsda loo,cache=TRUE}
# Group as outcome
Y <- as.factor(df$group)
# PLS-DA function
plsda_true <- plsda(X,Y,ncomp = 10)
# Check error and look at optimal number of components
perf_plsda_true <- perf(plsda_true,progressBar=FALSE, auc=TRUE,
                        validation = "loo")
plot(perf_plsda_true,
     col = color.mixo(5:7), sd = TRUE, legend.position = "horizontal")
# The performance plot looks a little bit strange, but it appears the 2 components is the best option
auc_true1 <- as.numeric(perf_plsda_true$auc$comp1["AUC.mean"])
auc_true2 <- as.numeric(perf_plsda_true$auc$comp2["AUC.mean"])
```

Performance was evaluated for 10 PLS-DA components using leave one out (LOO) cross-validation (CV). Two components resulted in the lowest overall classification error. For component 1, overall error rate was `r round(perf_plsda_true$error.rate.all$overall$centroids.dist[1],3)` with AUC of `r auc_true1`. For component 2, overall error rate was `r round(perf_plsda_true$error.rate.all$overall$centroids.dist[2],3)` with AUC of `r auc_true2`.

```{r plsda results}
plotIndiv(plsda_true,comp = c(1,2),title = "PLS-DA Components 1 & 2",
          ellipse = T,legend = T,ind.names = F)
```

## Permutation Testing

```{r permutation testing,cache=TRUE}
# Permutation testing - takes forever, make sure to cache
n_perm <- 1
aucs1 <- vector(mode="numeric", length=n_perm)
aucs2 <- vector(mode="numeric", length=n_perm)
for (i in 1:n_perm) {
  Y <- sample(df$group,replace = F)
  plsda_res <- plsda(X,Y,ncomp = 2)
  perf_plsda <- perf(plsda_res,progressBar=FALSE, auc=TRUE,
                     validation = "loo")
  aucs1[i] <- as.numeric(perf_plsda$auc$comp1["AUC.mean"])
  aucs2[i] <- as.numeric(perf_plsda$auc$comp2["AUC.mean"])
}
# Plot for each component
plot1 <- ggplot(as.data.frame(aucs1),aes(x=aucs1)) + 
  geom_histogram(binwidth = 0.01) + 
  geom_vline(aes(xintercept=auc_true1),color="red") + 
  theme_bw() + xlab("AUC") + ggtitle("Component 1")
plot1
plot2 <- ggplot(as.data.frame(aucs2),aes(x=aucs2)) + 
  geom_histogram(binwidth = 0.01) + 
  geom_vline(aes(xintercept=auc_true2),color="red") + 
  theme_bw() + xlab("AUC") + ggtitle("Component 2")
plot2
# Permutation p values
p1 <- (sum(aucs1 > auc_true1) + 1) / (length(aucs1) + 1)
p2 <- (sum(aucs2 > auc_true2) + 1) / (length(aucs2) + 1)
```

Group labels were permuted `r n_perm` times. Two component PLS-DA was run for each permutation and AUC was calculated using LOO CV. Red line indicates the AUC calculated for non-permuted data, and the gray histogram represents the null distribution of AUC. So, the permutation-based p value for AUC of component 1 is `r format.pval(p1,eps = 0.001)` and is `r  format.pval(p2,eps = 0.001)` for component 2. In other words, it's likely that PLS-DA is finding genuine differences between group 1 and group 4 and the AUC is not purely due to overfitting.

## Loadings

List of top 20 identified compounds in terms of discrimination for component 1 of the PLS-DA:

```{r comp1 vars}
var1 <- selectVar(plsda_true,comp = 1)$name
names <- raw_data$Name[match(var1,compounds)]
top20_pls <- var1[which(!is.na(names))[1:20]]
kable(head(names[!is.na(names)],20),col.names = "Compound Name")
```

List of top 20 identified compounds in terms of discrimination for component 2:

```{r comp2 vars}
var2 <- selectVar(plsda_true,comp = 2)$name
names <- raw_data$Name[match(var2,compounds)]
kable(head(names[!is.na(names)],20),col.names = "Compound Name")
```

# Moderated t tests

Top 20 identified metabolites that are significantly different between groups. P values adjusted using the FDR method. The reference group here is group 1, so negative logFC values indicate that the metabolite was lower in group 4 (and positive values indicate it was higher).

```{r echo=FALSE}
# Design matrix - 0 and 1 for CAC progression
design <- model.matrix(~factor(group),df)
# Linear model - X is "expression" matrix (samples in columns)
# Log base 2 transformation
fit <- lmFit(log(t(X),base = 2),design)
fit <- eBayes(fit)
# Results
results <- topTable(fit,coef = "factor(group)Control",number = ncol(X),
                    adjust.method = "BH")
results$m.z <- sapply(strsplit(rownames(results),"_"),"[[",2)
results$p.value <- results$P.Value
results$t.score <- results$t
results$Compound <- raw_data$Name[match(rownames(results),compounds)]
top20 <- rownames(results[!is.na(results$Compound),])[1:20]
# These results must then be uploaded to MetaboAnalyst for compound identification.
write.csv(results[,c("m.z","p.value","t.score")],na="",row.names = F,
          file = "./Clean data/untargeted_metaboanalyst.csv")
# table
results <- 
  results[!is.na(results$Compound),
          c("Compound","m.z","logFC","t.score","p.value","adj.P.Val")]
kable(head(results,20),row.names = F)
```

# Heatmap

```{r cim,include=FALSE,cache=TRUE}
# Color by T1D status
colors <- c("steelblue","orange")
colors <- colors[as.numeric(factor(Y))]
# Heatmap
obj.cim = cim(plsda_true,col.names = F,row.sideColors = colors,
              clust.method = c("complete","complete"),save = 'jpeg',
              name.save = 'PLScim')
```

![](Z:/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/Metabolomics/PLScim.jpeg)

# Correlations 

```{r}
vars = c("GIR","GIR_per_kg","body_fat","screen_bmi_percentile",	
         "rpf","acr_mean","kidney_oxygenation","gfr","kidney_GFR",
         "medullary_GFR","cortex_GFR")
varnames = c("GIR","GIR per kg","Body fat","BMI %ile","RPF",
             "Mean ACR","Kidney Oxy.","GFR","Kidney GFR","Medullary GFR",
             "Cortex GFR")
```

## For the Top 20 Identified Metabolites by Moderated t test

### Correlations

```{r}
c = corr.test(X[,top20],df[,vars],method = "spearman")
rownames(c$r) <- raw_data$Name[match(rownames(c$r),compounds)]
colnames(c$r) <- varnames
kable(c$r,digits = 3)
```

### P Values (FDR-adjusted)

```{r}
rownames(c$p) <- rownames(c$r)
colnames(c$p) <- colnames(c$r)
kable(c$p,digits = 3)
```

### Heatmap

```{r}
heatmap(c$r,margins = c(8,8))
```

## For the Top 20 Identified Metabolites by PLS-DA

### Correlations

```{r}
c = corr.test(X[,top20_pls],df[,vars],method = "spearman")
rownames(c$r) <- raw_data$Name[match(rownames(c$r),compounds)]
colnames(c$r) <- varnames
kable(c$r,digits = 3)
```

### P Values (FDR-adjusted)

```{r}
rownames(c$p) <- rownames(c$r)
colnames(c$p) <- colnames(c$r)
kable(c$p,digits = 3)
```

### Heatmap

```{r}
heatmap(c$r,margins = c(8,8))
```
